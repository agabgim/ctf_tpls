<center><a href="stag2d.c">Actual source code: stag2d.c</a></center><br>

<html>
<head> <link rel="canonical" href="http://www.mcs.anl.gov/petsc/petsc-current/src/dm/impls/stag/stag2d.c.html" />
<title></title>
<meta name="generator" content="c2html 0.9.4">
<meta name="date" content="2020-02-04T17:05:42+00:00">
</head>

<body bgcolor="#FFFFFF">
   <div id="version" align=right><b>petsc-3.12.4 2020-02-04</b></div>
   <div id="bugreport" align=right><a href="mailto:petsc-maint@mcs.anl.gov?subject=Typo or Error in Documentation &body=Please describe the typo or error in the documentation: petsc-3.12.4 v3.12.4 src/dm/impls/stag/stag2d.c.html "><small>Report Typos and Errors</small></a></div>
<pre width="80">
<a name="line1">  1: </a><font color="#B22222">/* Functions specific to the 2-dimensional implementation of DMStag */</font>
<a name="line2">  2: </a> #include <A href="../../../../include/petsc/private/dmstagimpl.h.html">&lt;petsc/private/dmstagimpl.h&gt;</A>

<a name="line4">  4: </a><font color="#B22222">/*@C</font>
<a name="line5">  5: </a><font color="#B22222">  <a href="../../../../docs/manualpages/DMSTAG/DMStagCreate2d.html#DMStagCreate2d">DMStagCreate2d</a> - Create an object to manage data living on the faces, edges, and vertices of a parallelized regular 2D grid.</font>

<a name="line7">  7: </a><font color="#B22222">  Collective</font>

<a name="line9">  9: </a><font color="#B22222">  Input Parameters:</font>
<a name="line10"> 10: </a><font color="#B22222">+ comm - MPI communicator</font>
<a name="line11"> 11: </a><font color="#B22222">. bndx,bndy - boundary type: <a href="../../../../docs/manualpages/DM/DMBoundaryType.html#DMBoundaryType">DM_BOUNDARY_NONE</a>, <a href="../../../../docs/manualpages/DM/DMBoundaryType.html#DMBoundaryType">DM_BOUNDARY_PERIODIC</a>, or <a href="../../../../docs/manualpages/DM/DMBoundaryType.html#DMBoundaryType">DM_BOUNDARY_GHOSTED</a></font>
<a name="line12"> 12: </a><font color="#B22222">. M,N - global number of grid points in x,y directions</font>
<a name="line13"> 13: </a><font color="#B22222">. m,n - number of ranks in the x,y directions (may be <a href="../../../../docs/manualpages/Sys/PETSC_DECIDE.html#PETSC_DECIDE">PETSC_DECIDE</a>)</font>
<a name="line14"> 14: </a><font color="#B22222">. dof0 - number of degrees of freedom per vertex/point/node/0-cell</font>
<a name="line15"> 15: </a><font color="#B22222">. dof1 - number of degrees of freedom per edge/1-cell</font>
<a name="line16"> 16: </a><font color="#B22222">. dof2 - number of degrees of freedom per element/2-cell</font>
<a name="line17"> 17: </a><font color="#B22222">. stencilType - ghost/halo region type: <a href="../../../../docs/manualpages/DMSTAG/DMStagStencilType.html#DMStagStencilType">DMSTAG_STENCIL_NONE</a>, <a href="../../../../docs/manualpages/DMSTAG/DMStagStencilType.html#DMStagStencilType">DMSTAG_STENCIL_BOX</a>, or <a href="../../../../docs/manualpages/DMSTAG/DMStagStencilType.html#DMStagStencilType">DMSTAG_STENCIL_STAR</a></font>
<a name="line18"> 18: </a><font color="#B22222">. stencilWidth - width, in elements, of halo/ghost region</font>
<a name="line19"> 19: </a><font color="#B22222">- lx,ly - arrays of local x,y element counts, of length equal to m,n, summing to M,N</font>

<a name="line21"> 21: </a><font color="#B22222">  Output Parameter:</font>
<a name="line22"> 22: </a><font color="#B22222">. dm - the new DMStag object</font>

<a name="line24"> 24: </a><font color="#B22222">  Options Database Keys:</font>
<a name="line25"> 25: </a><font color="#B22222">+ -dm_view - calls DMViewFromOptions() a the conclusion of <a href="../../../../docs/manualpages/DM/DMSetUp.html#DMSetUp">DMSetUp</a>()</font>
<a name="line26"> 26: </a><font color="#B22222">. -stag_grid_x &lt;nx&gt; - number of elements in the x direction</font>
<a name="line27"> 27: </a><font color="#B22222">. -stag_grid_y &lt;ny&gt; - number of elements in the y direction</font>
<a name="line28"> 28: </a><font color="#B22222">. -stag_ranks_x &lt;rx&gt; - number of ranks in the x direction</font>
<a name="line29"> 29: </a><font color="#B22222">. -stag_ranks_y &lt;ry&gt; - number of ranks in the y direction</font>
<a name="line30"> 30: </a><font color="#B22222">. -stag_ghost_stencil_width - width of ghost region, in elements</font>
<a name="line31"> 31: </a><font color="#B22222">. -stag_boundary_type_x &lt;none,ghosted,periodic&gt; - <a href="../../../../docs/manualpages/DM/DMBoundaryType.html#DMBoundaryType">DMBoundaryType</a> value</font>
<a name="line32"> 32: </a><font color="#B22222">- -stag_boundary_type_y &lt;none,ghosted,periodic&gt; - <a href="../../../../docs/manualpages/DM/DMBoundaryType.html#DMBoundaryType">DMBoundaryType</a> value</font>

<a name="line34"> 34: </a><font color="#B22222">  Notes:</font>
<a name="line35"> 35: </a><font color="#B22222">  You must call <a href="../../../../docs/manualpages/DM/DMSetUp.html#DMSetUp">DMSetUp</a>() after this call, before using the <a href="../../../../docs/manualpages/DM/DM.html#DM">DM</a>.</font>
<a name="line36"> 36: </a><font color="#B22222">  If you wish to use the options database (see the keys above) to change values in the DMStag, you must call</font>
<a name="line37"> 37: </a><font color="#B22222">  <a href="../../../../docs/manualpages/DM/DMSetFromOptions.html#DMSetFromOptions">DMSetFromOptions</a>() after this function but before <a href="../../../../docs/manualpages/DM/DMSetUp.html#DMSetUp">DMSetUp</a>().</font>

<a name="line39"> 39: </a><font color="#B22222">  Level: beginner</font>

<a name="line41"> 41: </a><font color="#B22222">.seealso: <a href="../../../../docs/manualpages/DMSTAG/DMSTAG.html#DMSTAG">DMSTAG</a>, <a href="../../../../docs/manualpages/DMSTAG/DMStagCreate1d.html#DMStagCreate1d">DMStagCreate1d</a>(), <a href="../../../../docs/manualpages/DMSTAG/DMStagCreate3d.html#DMStagCreate3d">DMStagCreate3d</a>(), <a href="../../../../docs/manualpages/DM/DMDestroy.html#DMDestroy">DMDestroy</a>(), <a href="../../../../docs/manualpages/DM/DMView.html#DMView">DMView</a>(), <a href="../../../../docs/manualpages/DM/DMCreateGlobalVector.html#DMCreateGlobalVector">DMCreateGlobalVector</a>(), <a href="../../../../docs/manualpages/DM/DMCreateLocalVector.html#DMCreateLocalVector">DMCreateLocalVector</a>(), <a href="../../../../docs/manualpages/DM/DMLocalToGlobalBegin.html#DMLocalToGlobalBegin">DMLocalToGlobalBegin</a>(), <a href="../../../../docs/manualpages/DMDA/DMDACreate2d.html#DMDACreate2d">DMDACreate2d</a>()</font>
<a name="line42"> 42: </a><font color="#B22222">@*/</font>
<a name="line43"> 43: </a><strong><font color="#4169E1"><a name="DMStagCreate2d"></a>PETSC_EXTERN <a href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> <a href="../../../../docs/manualpages/DMSTAG/DMStagCreate2d.html#DMStagCreate2d">DMStagCreate2d</a>(<a href="../../../../docs/manualpages/Sys/MPI_Comm.html#MPI_Comm">MPI_Comm</a> comm, <a href="../../../../docs/manualpages/DM/DMBoundaryType.html#DMBoundaryType">DMBoundaryType</a> bndx ,<a href="../../../../docs/manualpages/DM/DMBoundaryType.html#DMBoundaryType">DMBoundaryType</a> bndy, <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> M,<a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> N, <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> m,<a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> n, <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> dof0,<a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> dof1,<a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> dof2,<a href="../../../../docs/manualpages/DMSTAG/DMStagStencilType.html#DMStagStencilType">DMStagStencilType</a> stencilType,<a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> stencilWidth,const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> lx[],const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> ly[],<a href="../../../../docs/manualpages/DM/DM.html#DM">DM</a>* dm)</font></strong>
<a name="line44"> 44: </a>{
<a name="line46"> 46: </a>  DM_Stag        *stag;

<a name="line49"> 49: </a>  <a href="../../../../docs/manualpages/DM/DMCreate.html#DMCreate">DMCreate</a>(comm,dm);
<a name="line50"> 50: </a>  <a href="../../../../docs/manualpages/DM/DMSetDimension.html#DMSetDimension">DMSetDimension</a>(*dm,2); <font color="#B22222">/* Must precede <a href="../../../../docs/manualpages/DM/DMSetType.html#DMSetType">DMSetType</a> */</font>
<a name="line51"> 51: </a>  <a href="../../../../docs/manualpages/DM/DMSetType.html#DMSetType">DMSetType</a>(*dm,<a href="../../../../docs/manualpages/DMSTAG/DMSTAG.html#DMSTAG">DMSTAG</a>);
<a name="line52"> 52: </a>  stag = (DM_Stag*)(*dm)-&gt;data;

<a name="line54"> 54: </a>  <font color="#B22222">/* Global sizes and flags (derived quantities set in DMSetUp_Stag) */</font>
<a name="line55"> 55: </a>  stag-&gt;boundaryType[0] = bndx;
<a name="line56"> 56: </a>  stag-&gt;boundaryType[1] = bndy;
<a name="line57"> 57: </a>  stag-&gt;N[0]            = M;
<a name="line58"> 58: </a>  stag-&gt;N[1]            = N;
<a name="line59"> 59: </a>  stag-&gt;nRanks[0]       = m; <font color="#B22222">/* Adjusted later in DMSetUp_Stag */</font>
<a name="line60"> 60: </a>  stag-&gt;nRanks[1]       = n; <font color="#B22222">/* Adjusted later in DMSetUp_Stag */</font>
<a name="line61"> 61: </a>  stag-&gt;stencilType     = stencilType;
<a name="line62"> 62: </a>  stag-&gt;stencilWidth    = stencilWidth;
<a name="line63"> 63: </a>  <a href="../../../../docs/manualpages/DMSTAG/DMStagSetDOF.html#DMStagSetDOF">DMStagSetDOF</a>(*dm,dof0,dof1,dof2,0);
<a name="line64"> 64: </a>  <a href="../../../../docs/manualpages/DMSTAG/DMStagSetOwnershipRanges.html#DMStagSetOwnershipRanges">DMStagSetOwnershipRanges</a>(*dm,lx,ly,NULL);

<a name="line66"> 66: </a>  <font color="#4169E1">return</font>(0);
<a name="line67"> 67: </a>}

<a name="line69"> 69: </a><strong><font color="#4169E1"><a name="DMStagSetUniformCoordinatesExplicit_2d"></a>PETSC_INTERN <a href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> DMStagSetUniformCoordinatesExplicit_2d(<a href="../../../../docs/manualpages/DM/DM.html#DM">DM</a> dm,<a href="../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> xmin,<a href="../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> xmax,<a href="../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> ymin,<a href="../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> ymax)</font></strong>
<a name="line70"> 70: </a>{
<a name="line72"> 72: </a>  DM_Stag        *stagCoord;
<a name="line73"> 73: </a>  <a href="../../../../docs/manualpages/DM/DM.html#DM">DM</a>             dmCoord;
<a name="line74"> 74: </a>  <a href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</a>            coordLocal,coord;
<a name="line75"> 75: </a>  <a href="../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a>      h[2],min[2];
<a name="line76"> 76: </a>  <a href="../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a>    ***arr;
<a name="line77"> 77: </a>  <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>       ind[2],start[2],n[2],nExtra[2],s,c;
<a name="line78"> 78: </a>  <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>       idownleft,idown,ileft,ielement;

<a name="line81"> 81: </a>  <a href="../../../../docs/manualpages/DM/DMGetCoordinateDM.html#DMGetCoordinateDM">DMGetCoordinateDM</a>(dm, &amp;dmCoord);
<a name="line82"> 82: </a>  stagCoord = (DM_Stag*) dmCoord-&gt;data;
<a name="line83"> 83: </a>  <font color="#4169E1">for</font> (s=0; s&lt;3; ++s) {
<a name="line84"> 84: </a>    <font color="#4169E1">if</font> (stagCoord-&gt;dof[s] !=0 &amp;&amp; stagCoord-&gt;dof[s] != 2) <a href="../../../../docs/manualpages/Sys/SETERRQ2.html#SETERRQ2">SETERRQ2</a>(<a href="../../../../docs/manualpages/Sys/PetscObjectComm.html#PetscObjectComm">PetscObjectComm</a>((<a href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)dm),PETSC_ERR_PLIB,<font color="#666666">"Coordinate <a href="../../../../docs/manualpages/DM/DM.html#DM">DM</a> in 2 dimensions must have 0 or 2 dof on each stratum, but stratum %d has %d dof"</font>,s,stagCoord-&gt;dof[s]);
<a name="line85"> 85: </a>  }
<a name="line86"> 86: </a>  <a href="../../../../docs/manualpages/DM/DMGetLocalVector.html#DMGetLocalVector">DMGetLocalVector</a>(dmCoord,&amp;coordLocal);

<a name="line88"> 88: </a>  <a href="../../../../docs/manualpages/DMSTAG/DMStagVecGetArrayDOF.html#DMStagVecGetArrayDOF">DMStagVecGetArrayDOF</a>(dmCoord,coordLocal,&amp;arr);
<a name="line89"> 89: </a>  <font color="#4169E1">if</font> (stagCoord-&gt;dof[0]) {
<a name="line90"> 90: </a>    <a href="../../../../docs/manualpages/DMSTAG/DMStagGetLocationSlot.html#DMStagGetLocationSlot">DMStagGetLocationSlot</a>(dmCoord,<a href="../../../../docs/manualpages/DMSTAG/DMStagStencilLocation.html#DMStagStencilLocation">DMSTAG_DOWN_LEFT</a>,0,&amp;idownleft);
<a name="line91"> 91: </a>  }
<a name="line92"> 92: </a>  <font color="#4169E1">if</font> (stagCoord-&gt;dof[1]) {
<a name="line93"> 93: </a>    <a href="../../../../docs/manualpages/DMSTAG/DMStagGetLocationSlot.html#DMStagGetLocationSlot">DMStagGetLocationSlot</a>(dmCoord,<a href="../../../../docs/manualpages/DMSTAG/DMStagStencilLocation.html#DMStagStencilLocation">DMSTAG_DOWN</a>     ,0,&amp;idown    );
<a name="line94"> 94: </a>    <a href="../../../../docs/manualpages/DMSTAG/DMStagGetLocationSlot.html#DMStagGetLocationSlot">DMStagGetLocationSlot</a>(dmCoord,<a href="../../../../docs/manualpages/DMSTAG/DMStagStencilLocation.html#DMStagStencilLocation">DMSTAG_LEFT</a>     ,0,&amp;ileft    );
<a name="line95"> 95: </a>  }
<a name="line96"> 96: </a>  <font color="#4169E1">if</font> (stagCoord-&gt;dof[2]) {
<a name="line97"> 97: </a>    <a href="../../../../docs/manualpages/DMSTAG/DMStagGetLocationSlot.html#DMStagGetLocationSlot">DMStagGetLocationSlot</a>(dmCoord,<a href="../../../../docs/manualpages/DMSTAG/DMStagStencilLocation.html#DMStagStencilLocation">DMSTAG_ELEMENT</a>  ,0,&amp;ielement );
<a name="line98"> 98: </a>  }
<a name="line99"> 99: </a>  <a href="../../../../docs/manualpages/DMSTAG/DMStagGetCorners.html#DMStagGetCorners">DMStagGetCorners</a>(dmCoord,&amp;start[0],&amp;start[1],NULL,&amp;n[0],&amp;n[1],NULL,&amp;nExtra[0],&amp;nExtra[1],NULL);

<a name="line101">101: </a>  min[0] = xmin; min[1]= ymin;
<a name="line102">102: </a>  h[0] = (xmax-xmin)/stagCoord-&gt;N[0];
<a name="line103">103: </a>  h[1] = (ymax-ymin)/stagCoord-&gt;N[1];

<a name="line105">105: </a>  <font color="#4169E1">for</font>(ind[1]=start[1]; ind[1]&lt;start[1] + n[1] + nExtra[1]; ++ind[1]) {
<a name="line106">106: </a>    <font color="#4169E1">for</font>(ind[0]=start[0]; ind[0]&lt;start[0] + n[0] + nExtra[0]; ++ind[0]) {
<a name="line107">107: </a>      <font color="#4169E1">if</font> (stagCoord-&gt;dof[0]) {
<a name="line108">108: </a>        const <a href="../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> offs[2] = {0.0,0.0};
<a name="line109">109: </a>        <font color="#4169E1">for</font> (c=0; c&lt;2; ++c) {
<a name="line110">110: </a>          arr[ind[1]][ind[0]][idownleft + c] = min[c] + ((<a href="../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a>)ind[c] + offs[c]) * h[c];
<a name="line111">111: </a>        }
<a name="line112">112: </a>      }
<a name="line113">113: </a>      <font color="#4169E1">if</font> (stagCoord-&gt;dof[1]) {
<a name="line114">114: </a>        const <a href="../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> offs[2] = {0.5,0.0};
<a name="line115">115: </a>        <font color="#4169E1">for</font> (c=0; c&lt;2; ++c) {
<a name="line116">116: </a>          arr[ind[1]][ind[0]][idown + c] = min[c] + ((<a href="../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a>)ind[c] + offs[c]) * h[c];
<a name="line117">117: </a>        }
<a name="line118">118: </a>      }
<a name="line119">119: </a>      <font color="#4169E1">if</font> (stagCoord-&gt;dof[1]) {
<a name="line120">120: </a>        const <a href="../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> offs[2] = {0.0,0.5};
<a name="line121">121: </a>        <font color="#4169E1">for</font> (c=0; c&lt;2; ++c) {
<a name="line122">122: </a>          arr[ind[1]][ind[0]][ileft + c] = min[c] + ((<a href="../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a>)ind[c] + offs[c]) * h[c];
<a name="line123">123: </a>        }
<a name="line124">124: </a>      }
<a name="line125">125: </a>      <font color="#4169E1">if</font> (stagCoord-&gt;dof[2]) {
<a name="line126">126: </a>        const <a href="../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> offs[2] = {0.5,0.5};
<a name="line127">127: </a>        <font color="#4169E1">for</font> (c=0; c&lt;2; ++c) {
<a name="line128">128: </a>          arr[ind[1]][ind[0]][ielement + c] = min[c] + ((<a href="../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a>)ind[c] + offs[c]) * h[c];
<a name="line129">129: </a>        }
<a name="line130">130: </a>      }
<a name="line131">131: </a>    }
<a name="line132">132: </a>  }
<a name="line133">133: </a>  <a href="../../../../docs/manualpages/DMSTAG/DMStagVecRestoreArrayDOF.html#DMStagVecRestoreArrayDOF">DMStagVecRestoreArrayDOF</a>(dmCoord,coordLocal,&amp;arr);
<a name="line134">134: </a>  <a href="../../../../docs/manualpages/DM/DMCreateGlobalVector.html#DMCreateGlobalVector">DMCreateGlobalVector</a>(dmCoord,&amp;coord);
<a name="line135">135: </a>  <a href="../../../../docs/manualpages/DM/DMLocalToGlobalBegin.html#DMLocalToGlobalBegin">DMLocalToGlobalBegin</a>(dmCoord,coordLocal,<a href="../../../../docs/manualpages/Sys/INSERT_VALUES.html#INSERT_VALUES">INSERT_VALUES</a>,coord);
<a name="line136">136: </a>  <a href="../../../../docs/manualpages/DM/DMLocalToGlobalEnd.html#DMLocalToGlobalEnd">DMLocalToGlobalEnd</a>(dmCoord,coordLocal,<a href="../../../../docs/manualpages/Sys/INSERT_VALUES.html#INSERT_VALUES">INSERT_VALUES</a>,coord);
<a name="line137">137: </a>  <a href="../../../../docs/manualpages/DM/DMSetCoordinates.html#DMSetCoordinates">DMSetCoordinates</a>(dm,coord);
<a name="line138">138: </a>  PetscLogObjectParent((<a href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)dm,(<a href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)coord);
<a name="line139">139: </a>  <a href="../../../../docs/manualpages/DM/DMRestoreLocalVector.html#DMRestoreLocalVector">DMRestoreLocalVector</a>(dmCoord,&amp;coordLocal);
<a name="line140">140: </a>  <a href="../../../../docs/manualpages/Vec/VecDestroy.html#VecDestroy">VecDestroy</a>(&amp;coord);
<a name="line141">141: </a>  <font color="#4169E1">return</font>(0);
<a name="line142">142: </a>}

<a name="line144">144: </a><font color="#B22222">/* Helper functions used in DMSetUp_Stag() */</font>
<a name="line145">145: </a><strong><font color="#4169E1">static <a href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> DMStagSetUpBuildRankGrid_2d(<a href="../../../../docs/manualpages/DM/DM.html#DM">DM</a>)</font></strong>;
<a name="line146">146: </a><strong><font color="#4169E1">static <a href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> DMStagSetUpBuildNeighbors_2d(<a href="../../../../docs/manualpages/DM/DM.html#DM">DM</a>)</font></strong>;
<a name="line147">147: </a><strong><font color="#4169E1">static <a href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> DMStagSetUpBuildGlobalOffsets_2d(<a href="../../../../docs/manualpages/DM/DM.html#DM">DM</a>,<a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>**)</font></strong>;
<a name="line148">148: </a><strong><font color="#4169E1">static <a href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> DMStagComputeLocationOffsets_2d(<a href="../../../../docs/manualpages/DM/DM.html#DM">DM</a>)</font></strong>;

<a name="line150">150: </a><strong><font color="#4169E1"><a name="DMSetUp_Stag_2d"></a>PETSC_INTERN <a href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> DMSetUp_Stag_2d(<a href="../../../../docs/manualpages/DM/DM.html#DM">DM</a> dm)</font></strong>
<a name="line151">151: </a>{
<a name="line152">152: </a>  <a href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a>  ierr;
<a name="line153">153: </a>  DM_Stag * const stag = (DM_Stag*)dm-&gt;data;
<a name="line154">154: </a>  <a href="../../../../docs/manualpages/Sys/PetscMPIInt.html#PetscMPIInt">PetscMPIInt</a>     size,rank;
<a name="line155">155: </a>  <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>        i,j,d,entriesPerElementRowGhost,entriesPerCorner,entriesPerEdge,entriesPerElementRow;
<a name="line156">156: </a>  <a href="../../../../docs/manualpages/Sys/MPI_Comm.html#MPI_Comm">MPI_Comm</a>        comm;
<a name="line157">157: </a>  <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>        *globalOffsets;
<a name="line158">158: </a>  <a href="../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</a>       star,dummyStart[2],dummyEnd[2];
<a name="line159">159: </a>  const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>  dim = 2;

<a name="line162">162: </a>  <a href="../../../../docs/manualpages/Sys/PetscObjectGetComm.html#PetscObjectGetComm">PetscObjectGetComm</a>((<a href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)dm,&amp;comm);
<a name="line163">163: </a>  <a href="http://www.mpich.org/static/docs/latest/www3/MPI_Comm_size.html#MPI_Comm_size">MPI_Comm_size</a>(comm,&amp;size);
<a name="line164">164: </a>  <a href="http://www.mpich.org/static/docs/latest/www3/MPI_Comm_rank.html#MPI_Comm_rank">MPI_Comm_rank</a>(comm,&amp;rank);

<a name="line166">166: </a>  <font color="#B22222">/* Rank grid sizes (populates stag-&gt;nRanks) */</font>
<a name="line167">167: </a>  DMStagSetUpBuildRankGrid_2d(dm);

<a name="line169">169: </a>  <font color="#B22222">/* Determine location of rank in grid (these get extra boundary points on the last element)</font>
<a name="line170">170: </a><font color="#B22222">     Order is x-fast, as usual */</font>
<a name="line171">171: </a>    stag-&gt;rank[0] = rank % stag-&gt;nRanks[0];
<a name="line172">172: </a>    stag-&gt;rank[1] = rank / stag-&gt;nRanks[0];
<a name="line173">173: </a>    <font color="#4169E1">for</font>(i=0; i&lt;dim; ++i) {
<a name="line174">174: </a>      stag-&gt;firstRank[i] = <a href="../../../../docs/manualpages/Sys/PetscNot.html#PetscNot">PetscNot</a>(stag-&gt;rank[i]);
<a name="line175">175: </a>      stag-&gt;lastRank[i]  = (<a href="../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</a>)(stag-&gt;rank[i] == stag-&gt;nRanks[i]-1);
<a name="line176">176: </a>    }

<a name="line178">178: </a>  <font color="#B22222">/* Determine Locally owned region</font>

<a name="line180">180: </a><font color="#B22222">   Divide equally, giving lower ranks in each dimension and extra element if needbe.</font>

<a name="line182">182: </a><font color="#B22222">   Note that this uses O(P) storage. If this ever becomes an issue, this could</font>
<a name="line183">183: </a><font color="#B22222">   be refactored to not keep this data around.  */</font>
<a name="line184">184: </a>  <font color="#4169E1">for</font> (i=0; i&lt;dim; ++i) {
<a name="line185">185: </a>    <font color="#4169E1">if</font> (!stag-&gt;l[i]) {
<a name="line186">186: </a>      const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> Ni = stag-&gt;N[i], nRanksi = stag-&gt;nRanks[i];
<a name="line187">187: </a>      <a href="../../../../docs/manualpages/Sys/PetscMalloc1.html#PetscMalloc1">PetscMalloc1</a>(stag-&gt;nRanks[i],&amp;stag-&gt;l[i]);
<a name="line188">188: </a>      <font color="#4169E1">for</font> (j=0; j&lt;stag-&gt;nRanks[i]; ++j){
<a name="line189">189: </a>        stag-&gt;l[i][j] = Ni/nRanksi + ((Ni % nRanksi) &gt; j);
<a name="line190">190: </a>      }
<a name="line191">191: </a>    }
<a name="line192">192: </a>  }

<a name="line194">194: </a>  <font color="#B22222">/* Retrieve local size in stag-&gt;n */</font>
<a name="line195">195: </a>  <font color="#4169E1">for</font> (i=0; i&lt;dim; ++i) stag-&gt;n[i] = stag-&gt;l[i][stag-&gt;rank[i]];
<a name="line196">196: </a><font color="#A020F0">#if defined(PETSC_USE_DEBUG)</font>
<a name="line197">197: </a>  <font color="#4169E1">for</font> (i=0; i&lt;dim; ++i) {
<a name="line198">198: </a>    <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> Ncheck,j;
<a name="line199">199: </a>    Ncheck = 0;
<a name="line200">200: </a>    <font color="#4169E1">for</font> (j=0; j&lt;stag-&gt;nRanks[i]; ++j) Ncheck += stag-&gt;l[i][j];
<a name="line201">201: </a>    <font color="#4169E1">if</font> (Ncheck != stag-&gt;N[i]) <a href="../../../../docs/manualpages/Sys/SETERRQ3.html#SETERRQ3">SETERRQ3</a>(<a href="../../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</a>,PETSC_ERR_ARG_SIZ,<font color="#666666">"Local sizes in dimension %d don't add up. %d != %d\n"</font>,i,Ncheck,stag-&gt;N[i]);
<a name="line202">202: </a>  }
<a name="line203">203: </a><font color="#A020F0">#endif</font>

<a name="line205">205: </a>  <font color="#B22222">/* Compute starting elements */</font>
<a name="line206">206: </a>  <font color="#4169E1">for</font> (i=0; i&lt;dim; ++i) {
<a name="line207">207: </a>    stag-&gt;start[i] = 0;
<a name="line208">208: </a>    <font color="#4169E1">for</font>(j=0;j&lt;stag-&gt;rank[i];++j){
<a name="line209">209: </a>      stag-&gt;start[i] += stag-&gt;l[i][j];
<a name="line210">210: </a>    }
<a name="line211">211: </a>  }

<a name="line213">213: </a>  <font color="#B22222">/* Determine ranks of neighbors, using <a href="../../../../docs/manualpages/DMDA/DMDA.html#DMDA">DMDA</a>'s convention</font>

<a name="line215">215: </a><font color="#B22222">     n6 n7 n8</font>
<a name="line216">216: </a><font color="#B22222">     n3    n5</font>
<a name="line217">217: </a><font color="#B22222">     n0 n1 n2                                               */</font>
<a name="line218">218: </a>  DMStagSetUpBuildNeighbors_2d(dm);

<a name="line220">220: </a>    <font color="#B22222">/* Determine whether the ghost region includes dummies or not. This is currently</font>
<a name="line221">221: </a><font color="#B22222">       equivalent to having a non-periodic boundary. If not, then</font>
<a name="line222">222: </a><font color="#B22222">       ghostOffset{Start,End}[d] elements correspond to elements on the neighbor.</font>
<a name="line223">223: </a><font color="#B22222">       If true, then</font>
<a name="line224">224: </a><font color="#B22222">       - at the start, there are ghostOffsetStart[d] ghost elements</font>
<a name="line225">225: </a><font color="#B22222">       - at the end, there is a layer of extra "physical" points inside a layer of</font>
<a name="line226">226: </a><font color="#B22222">         ghostOffsetEnd[d] ghost elements</font>
<a name="line227">227: </a><font color="#B22222">       Note that this computation should be updated if any boundary types besides</font>
<a name="line228">228: </a><font color="#B22222">       NONE, GHOSTED, and PERIODIC are supported.  */</font>
<a name="line229">229: </a>    <font color="#4169E1">for</font> (d=0; d&lt;2; ++d) dummyStart[d] = (<a href="../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</a>)(stag-&gt;firstRank[d] &amp;&amp; stag-&gt;boundaryType[d] != <a href="../../../../docs/manualpages/DM/DMBoundaryType.html#DMBoundaryType">DM_BOUNDARY_PERIODIC</a>);
<a name="line230">230: </a>    <font color="#4169E1">for</font> (d=0; d&lt;2; ++d) dummyEnd[d]   = (<a href="../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</a>)(stag-&gt;lastRank[d]  &amp;&amp; stag-&gt;boundaryType[d] != <a href="../../../../docs/manualpages/DM/DMBoundaryType.html#DMBoundaryType">DM_BOUNDARY_PERIODIC</a>);

<a name="line232">232: </a>  <font color="#B22222">/* Define useful sizes */</font>
<a name="line233">233: </a>  stag-&gt;entriesPerElement = stag-&gt;dof[0] + 2*stag-&gt;dof[1] + stag-&gt;dof[2];
<a name="line234">234: </a>  entriesPerEdge          = stag-&gt;dof[0] + stag-&gt;dof[1];
<a name="line235">235: </a>  entriesPerCorner        = stag-&gt;dof[0];
<a name="line236">236: </a>  entriesPerElementRow    = stag-&gt;n[0]*stag-&gt;entriesPerElement + (dummyEnd[0] ? entriesPerEdge : 0);
<a name="line237">237: </a>  stag-&gt;entries           = stag-&gt;n[1]*entriesPerElementRow +  (dummyEnd[1] ? stag-&gt;n[0]*entriesPerEdge : 0 ) + (dummyEnd[0] &amp;&amp; dummyEnd[1] ? entriesPerCorner: 0);

<a name="line239">239: </a>  <font color="#B22222">/* Compute offsets for each rank into global vectors</font>
<a name="line240">240: </a><font color="#B22222">     This again requires O(P) storage, which could be replaced with some global</font>
<a name="line241">241: </a><font color="#B22222">     communication.  */</font>
<a name="line242">242: </a>  DMStagSetUpBuildGlobalOffsets_2d(dm,&amp;globalOffsets);

<a name="line244">244: </a>  <font color="#4169E1">for</font> (d=0; d&lt;dim; ++d) <font color="#4169E1">if</font> (stag-&gt;boundaryType[d] != <a href="../../../../docs/manualpages/DM/DMBoundaryType.html#DMBoundaryType">DM_BOUNDARY_NONE</a> &amp;&amp; stag-&gt;boundaryType[d] != <a href="../../../../docs/manualpages/DM/DMBoundaryType.html#DMBoundaryType">DM_BOUNDARY_PERIODIC</a> &amp;&amp; stag-&gt;boundaryType[d] != <a href="../../../../docs/manualpages/DM/DMBoundaryType.html#DMBoundaryType">DM_BOUNDARY_GHOSTED</a>) <a href="../../../../docs/manualpages/Sys/SETERRQ.html#SETERRQ">SETERRQ</a>(<a href="../../../../docs/manualpages/Sys/PETSC_COMM_WORLD.html#PETSC_COMM_WORLD">PETSC_COMM_WORLD</a>,PETSC_ERR_SUP,<font color="#666666">"Unsupported boundary type"</font>);

<a name="line246">246: </a>  <font color="#B22222">/* Define ghosted/local sizes */</font>
<a name="line247">247: </a>  <font color="#4169E1">for</font> (d=0; d&lt;dim; ++d) {
<a name="line248">248: </a>    <font color="#4169E1">switch</font> (stag-&gt;boundaryType[d]) {
<a name="line249">249: </a>      <font color="#4169E1">case</font> <a href="../../../../docs/manualpages/DM/DMBoundaryType.html#DMBoundaryType">DM_BOUNDARY_NONE</a>:
<a name="line250">250: </a>        <font color="#B22222">/* Note: for a elements-only DMStag, the extra elements on the edges aren't necessary but we include them anyway */</font>
<a name="line251">251: </a>        <font color="#4169E1">switch</font> (stag-&gt;stencilType) {
<a name="line252">252: </a>          <font color="#4169E1">case</font> <a href="../../../../docs/manualpages/DMSTAG/DMStagStencilType.html#DMStagStencilType">DMSTAG_STENCIL_NONE</a> : <font color="#B22222">/* only the extra one on the right/top edges */</font>
<a name="line253">253: </a>            stag-&gt;nGhost[d] = stag-&gt;n[d];
<a name="line254">254: </a>            stag-&gt;startGhost[d] = stag-&gt;start[d];
<a name="line255">255: </a>            <font color="#4169E1">if</font> (stag-&gt;lastRank[d]) stag-&gt;nGhost[d] += 1;
<a name="line256">256: </a>            <font color="#4169E1">break</font>;
<a name="line257">257: </a>          <font color="#4169E1">case</font> <a href="../../../../docs/manualpages/DMSTAG/DMStagStencilType.html#DMStagStencilType">DMSTAG_STENCIL_STAR</a> : <font color="#B22222">/* allocate the corners but don't use them */</font>
<a name="line258">258: </a>          <font color="#4169E1">case</font> <a href="../../../../docs/manualpages/DMSTAG/DMStagStencilType.html#DMStagStencilType">DMSTAG_STENCIL_BOX</a> :
<a name="line259">259: </a>            stag-&gt;nGhost[d] = stag-&gt;n[d];
<a name="line260">260: </a>            stag-&gt;startGhost[d] = stag-&gt;start[d];
<a name="line261">261: </a>            <font color="#4169E1">if</font> (!stag-&gt;firstRank[d]) {
<a name="line262">262: </a>              stag-&gt;nGhost[d]     += stag-&gt;stencilWidth; <font color="#B22222">/* add interior ghost elements */</font>
<a name="line263">263: </a>              stag-&gt;startGhost[d] -= stag-&gt;stencilWidth;
<a name="line264">264: </a>            }
<a name="line265">265: </a>            <font color="#4169E1">if</font> (!stag-&gt;lastRank[d]) {
<a name="line266">266: </a>              stag-&gt;nGhost[d] += stag-&gt;stencilWidth; <font color="#B22222">/* add interior ghost elements */</font>
<a name="line267">267: </a>            } <font color="#4169E1">else</font> {
<a name="line268">268: </a>              stag-&gt;nGhost[d] += 1; <font color="#B22222">/* one element on the boundary to complete blocking */</font>
<a name="line269">269: </a>            }
<a name="line270">270: </a>            <font color="#4169E1">break</font>;
<a name="line271">271: </a>          <font color="#4169E1">default</font> :
<a name="line272">272: </a>            <a href="../../../../docs/manualpages/Sys/SETERRQ1.html#SETERRQ1">SETERRQ1</a>(<a href="../../../../docs/manualpages/Sys/PETSC_COMM_WORLD.html#PETSC_COMM_WORLD">PETSC_COMM_WORLD</a>,PETSC_ERR_SUP,<font color="#666666">"Unrecognized ghost stencil type %d"</font>,stag-&gt;stencilType);
<a name="line273">273: </a>        }
<a name="line274">274: </a>        <font color="#4169E1">break</font>;
<a name="line275">275: </a>      <font color="#4169E1">case</font> <a href="../../../../docs/manualpages/DM/DMBoundaryType.html#DMBoundaryType">DM_BOUNDARY_GHOSTED</a>:
<a name="line276">276: </a>        <font color="#4169E1">switch</font> (stag-&gt;stencilType) {
<a name="line277">277: </a>          <font color="#4169E1">case</font> <a href="../../../../docs/manualpages/DMSTAG/DMStagStencilType.html#DMStagStencilType">DMSTAG_STENCIL_NONE</a> :
<a name="line278">278: </a>            stag-&gt;startGhost[d] = stag-&gt;start[d];
<a name="line279">279: </a>            stag-&gt;nGhost[d]     = stag-&gt;n[d] + (stag-&gt;lastRank[d] ? 1 : 0);
<a name="line280">280: </a>            <font color="#4169E1">break</font>;
<a name="line281">281: </a>          <font color="#4169E1">case</font> <a href="../../../../docs/manualpages/DMSTAG/DMStagStencilType.html#DMStagStencilType">DMSTAG_STENCIL_STAR</a> :
<a name="line282">282: </a>          <font color="#4169E1">case</font> <a href="../../../../docs/manualpages/DMSTAG/DMStagStencilType.html#DMStagStencilType">DMSTAG_STENCIL_BOX</a> :
<a name="line283">283: </a>            stag-&gt;startGhost[d] = stag-&gt;start[d] - stag-&gt;stencilWidth; <font color="#B22222">/* This value may be negative */</font>
<a name="line284">284: </a>            stag-&gt;nGhost[d]     = stag-&gt;n[d] + 2*stag-&gt;stencilWidth + (stag-&gt;lastRank[d] &amp;&amp; stag-&gt;stencilWidth == 0 ? 1 : 0);
<a name="line285">285: </a>            <font color="#4169E1">break</font>;
<a name="line286">286: </a>          <font color="#4169E1">default</font> :
<a name="line287">287: </a>            <a href="../../../../docs/manualpages/Sys/SETERRQ1.html#SETERRQ1">SETERRQ1</a>(<a href="../../../../docs/manualpages/Sys/PETSC_COMM_WORLD.html#PETSC_COMM_WORLD">PETSC_COMM_WORLD</a>,PETSC_ERR_SUP,<font color="#666666">"Unrecognized ghost stencil type %d"</font>,stag-&gt;stencilType);
<a name="line288">288: </a>        }
<a name="line289">289: </a>        <font color="#4169E1">break</font>;
<a name="line290">290: </a>      <font color="#4169E1">case</font> <a href="../../../../docs/manualpages/DM/DMBoundaryType.html#DMBoundaryType">DM_BOUNDARY_PERIODIC</a>:
<a name="line291">291: </a>        <font color="#4169E1">switch</font> (stag-&gt;stencilType) {
<a name="line292">292: </a>          <font color="#4169E1">case</font> <a href="../../../../docs/manualpages/DMSTAG/DMStagStencilType.html#DMStagStencilType">DMSTAG_STENCIL_NONE</a> : <font color="#B22222">/* only the extra one on the right/top edges */</font>
<a name="line293">293: </a>            stag-&gt;nGhost[d] = stag-&gt;n[d];
<a name="line294">294: </a>            stag-&gt;startGhost[d] = stag-&gt;start[d];
<a name="line295">295: </a>            <font color="#4169E1">break</font>;
<a name="line296">296: </a>          <font color="#4169E1">case</font> <a href="../../../../docs/manualpages/DMSTAG/DMStagStencilType.html#DMStagStencilType">DMSTAG_STENCIL_STAR</a> :
<a name="line297">297: </a>          <font color="#4169E1">case</font> <a href="../../../../docs/manualpages/DMSTAG/DMStagStencilType.html#DMStagStencilType">DMSTAG_STENCIL_BOX</a> :
<a name="line298">298: </a>            stag-&gt;nGhost[d] = stag-&gt;n[d] + 2*stag-&gt;stencilWidth;
<a name="line299">299: </a>            stag-&gt;startGhost[d] = stag-&gt;start[d] - stag-&gt;stencilWidth;
<a name="line300">300: </a>            <font color="#4169E1">break</font>;
<a name="line301">301: </a>          <font color="#4169E1">default</font> :
<a name="line302">302: </a>            <a href="../../../../docs/manualpages/Sys/SETERRQ1.html#SETERRQ1">SETERRQ1</a>(<a href="../../../../docs/manualpages/Sys/PETSC_COMM_WORLD.html#PETSC_COMM_WORLD">PETSC_COMM_WORLD</a>,PETSC_ERR_SUP,<font color="#666666">"Unrecognized ghost stencil type %d"</font>,stag-&gt;stencilType);
<a name="line303">303: </a>        }
<a name="line304">304: </a>        <font color="#4169E1">break</font>;
<a name="line305">305: </a><strong><font color="#FF0000">      default:</font></strong> <a href="../../../../docs/manualpages/Sys/SETERRQ1.html#SETERRQ1">SETERRQ1</a>(<a href="../../../../docs/manualpages/Sys/PETSC_COMM_WORLD.html#PETSC_COMM_WORLD">PETSC_COMM_WORLD</a>,PETSC_ERR_SUP,<font color="#666666">"Unsupported boundary type in dimension %D"</font>,d);
<a name="line306">306: </a>    }
<a name="line307">307: </a>  }
<a name="line308">308: </a>  stag-&gt;entriesGhost = stag-&gt;nGhost[0]*stag-&gt;nGhost[1]*stag-&gt;entriesPerElement;
<a name="line309">309: </a>  entriesPerElementRowGhost = stag-&gt;nGhost[0]*stag-&gt;entriesPerElement;

<a name="line311">311: </a>  <font color="#B22222">/* Create global--&gt;local <a href="../../../../docs/manualpages/Vec/VecScatter.html#VecScatter">VecScatter</a> and local-&gt;global <a href="../../../../docs/manualpages/IS/ISLocalToGlobalMapping.html#ISLocalToGlobalMapping">ISLocalToGlobalMapping</a></font>

<a name="line313">313: </a><font color="#B22222">     We iterate over all local points twice. First, we iterate over each neighbor, populating</font>
<a name="line314">314: </a><font color="#B22222">     1. idxLocal[] : the subset of points, in local numbering ("S" from 0 on all points including ghosts), which correspond to global points. That is, the set of all non-dummy points in the ghosted representation</font>
<a name="line315">315: </a><font color="#B22222">     2. idxGlobal[]: the corresponding global points, in global numbering (Nested "S"s - ranks then non-ghost points in each rank)</font>

<a name="line317">317: </a><font color="#B22222">     Next, we iterate over all points in the local ordering, populating</font>
<a name="line318">318: </a><font color="#B22222">     3. idxGlobalAll[] : entry i is the global point corresponding to local point i, or -1 if local point i is a dummy.</font>

<a name="line320">320: </a><font color="#B22222">     Note further here that the local/ghosted vectors:</font>
<a name="line321">321: </a><font color="#B22222">     - Are always an integral number of elements-worth of points, in all directions.</font>
<a name="line322">322: </a><font color="#B22222">     - Contain three flavors of points:</font>
<a name="line323">323: </a><font color="#B22222">     1. Points which "live here" in the global representation</font>
<a name="line324">324: </a><font color="#B22222">     2. Ghost points which correspond to points on other ranks in the global representation</font>
<a name="line325">325: </a><font color="#B22222">     3. Ghost points, which we call "dummy points," which do not correspond to any point in the global representation</font>

<a name="line327">327: </a><font color="#B22222">     Dummy ghost points arise in at least three ways:</font>
<a name="line328">328: </a><font color="#B22222">     1. As padding for the right, top, and front physical boundaries, to complete partial elements</font>
<a name="line329">329: </a><font color="#B22222">     2. As unused space in the "corners" on interior ranks when using a star stencil</font>
<a name="line330">330: </a><font color="#B22222">     3. As additional work space on all physical boundaries, when <a href="../../../../docs/manualpages/DM/DMBoundaryType.html#DMBoundaryType">DM_BOUNDARY_GHOSTED</a> is used</font>

<a name="line332">332: </a><font color="#B22222">     Note that, because of the boundary dummies,</font>
<a name="line333">333: </a><font color="#B22222">     with a stencil width of zero, on 1 rank, local and global vectors</font>
<a name="line334">334: </a><font color="#B22222">     are still different!</font>

<a name="line336">336: </a><font color="#B22222">     We assume that the size on each rank is greater than or equal to the</font>
<a name="line337">337: </a><font color="#B22222">     stencil width.</font>
<a name="line338">338: </a><font color="#B22222">     */</font>

<a name="line340">340: </a>  <font color="#4169E1">if</font> (stag-&gt;n[0] &lt; stag-&gt;stencilWidth || stag-&gt;n[1] &lt; stag-&gt;stencilWidth) {
<a name="line341">341: </a>    <a href="../../../../docs/manualpages/Sys/SETERRQ3.html#SETERRQ3">SETERRQ3</a>(<a href="../../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</a>,PETSC_ERR_SUP,<font color="#666666">"DMStag 2d setup does not support local sizes (%D x %D) smaller than the elementwise stencil width (%D)"</font>,stag-&gt;n[0],stag-&gt;n[1],stag-&gt;stencilWidth);
<a name="line342">342: </a>  }

<a name="line344">344: </a>  <font color="#B22222">/* Check stencil type */</font>
<a name="line345">345: </a>  <font color="#4169E1">if</font> (stag-&gt;stencilType != <a href="../../../../docs/manualpages/DMSTAG/DMStagStencilType.html#DMStagStencilType">DMSTAG_STENCIL_NONE</a> &amp;&amp; stag-&gt;stencilType != <a href="../../../../docs/manualpages/DMSTAG/DMStagStencilType.html#DMStagStencilType">DMSTAG_STENCIL_BOX</a> &amp;&amp; stag-&gt;stencilType != <a href="../../../../docs/manualpages/DMSTAG/DMStagStencilType.html#DMStagStencilType">DMSTAG_STENCIL_STAR</a>) <a href="../../../../docs/manualpages/Sys/SETERRQ1.html#SETERRQ1">SETERRQ1</a>(<a href="../../../../docs/manualpages/Sys/PetscObjectComm.html#PetscObjectComm">PetscObjectComm</a>((<a href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)dm),PETSC_ERR_SUP,<font color="#666666">"Unsupported stencil type %s"</font>,DMStagStencilTypes[stag-&gt;stencilType]);
<a name="line346">346: </a>  <font color="#4169E1">if</font> (stag-&gt;stencilType == <a href="../../../../docs/manualpages/DMSTAG/DMStagStencilType.html#DMStagStencilType">DMSTAG_STENCIL_NONE</a> &amp;&amp; stag-&gt;stencilWidth != 0) <a href="../../../../docs/manualpages/Sys/SETERRQ.html#SETERRQ">SETERRQ</a>(<a href="../../../../docs/manualpages/Sys/PetscObjectComm.html#PetscObjectComm">PetscObjectComm</a>((<a href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)dm),PETSC_ERR_SUP,<font color="#666666">"DMStag 2d setup requries stencil width 0 with stencil type none"</font>);
<a name="line347">347: </a>  star = (<a href="../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</a>)(stag-&gt;stencilType == <a href="../../../../docs/manualpages/DMSTAG/DMStagStencilType.html#DMStagStencilType">DMSTAG_STENCIL_STAR</a>);

<a name="line349">349: </a>  {
<a name="line350">350: </a>    <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> *idxLocal,*idxGlobal,*idxGlobalAll;
<a name="line351">351: </a>    <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>  count,countAll,entriesToTransferTotal,i,j,d,ghostOffsetStart[2],ghostOffsetEnd[2];
<a name="line352">352: </a>    <a href="../../../../docs/manualpages/IS/IS.html#IS">IS</a>        isLocal,isGlobal;
<a name="line353">353: </a>    <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>  jghost,ighost;
<a name="line354">354: </a>    <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>  nNeighbors[9][2];
<a name="line355">355: </a>    <a href="../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</a> nextToDummyEnd[2];

<a name="line357">357: </a>    <font color="#B22222">/* Compute numbers of elements on each neighbor */</font>
<a name="line358">358: </a>    <font color="#4169E1">for</font> (i=0; i&lt;9; ++i) {
<a name="line359">359: </a>      const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> neighborRank = stag-&gt;neighbors[i];
<a name="line360">360: </a>      <font color="#4169E1">if</font> (neighborRank &gt;= 0) { <font color="#B22222">/* note we copy the values for our own rank (neighbor 4) */</font>
<a name="line361">361: </a>        nNeighbors[i][0] =  stag-&gt;l[0][neighborRank % stag-&gt;nRanks[0]];
<a name="line362">362: </a>        nNeighbors[i][1] =  stag-&gt;l[1][neighborRank / stag-&gt;nRanks[0]];
<a name="line363">363: </a>      } <font color="#B22222">/* else leave uninitialized - error if accessed */</font>
<a name="line364">364: </a>    }

<a name="line366">366: </a>    <font color="#B22222">/* These offsets should always be non-negative, and describe how many</font>
<a name="line367">367: </a><font color="#B22222">       ghost elements exist at each boundary. These are not always equal to the stencil width,</font>
<a name="line368">368: </a><font color="#B22222">       because we may have different numbers of ghost elements at the boundaries. In particular,</font>
<a name="line369">369: </a><font color="#B22222">       we always have at least one ghost (dummy) element at the right/top/front. */</font>
<a name="line370">370: </a>    <font color="#4169E1">for</font> (d=0; d&lt;2; ++d) ghostOffsetStart[d] = stag-&gt;start[d] - stag-&gt;startGhost[d];
<a name="line371">371: </a>    <font color="#4169E1">for</font> (d=0; d&lt;2; ++d) ghostOffsetEnd[d]   = stag-&gt;startGhost[d]+stag-&gt;nGhost[d] - (stag-&gt;start[d]+stag-&gt;n[d]);

<a name="line373">373: </a>    <font color="#B22222">/* Compute whether the next rank has an extra point (only used in x direction) */</font>
<a name="line374">374: </a>    <font color="#4169E1">for</font> (d=0;d&lt;2;++d) nextToDummyEnd[d] = (<a href="../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</a>)(stag-&gt;boundaryType[d] != <a href="../../../../docs/manualpages/DM/DMBoundaryType.html#DMBoundaryType">DM_BOUNDARY_PERIODIC</a> &amp;&amp; stag-&gt;rank[d] == stag-&gt;nRanks[d]-2);

<a name="line376">376: </a>    <font color="#B22222">/* Compute the number of local entries which correspond to any global entry */</font>
<a name="line377">377: </a>    {
<a name="line378">378: </a>      <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> nNonDummyGhost[2];
<a name="line379">379: </a>      <font color="#4169E1">for</font> (d=0; d&lt;2; ++d) nNonDummyGhost[d] = stag-&gt;nGhost[d] - (dummyStart[d] ? ghostOffsetStart[d] : 0) - (dummyEnd[d] ? ghostOffsetEnd[d] : 0);
<a name="line380">380: </a>      <font color="#4169E1">if</font> (star) {
<a name="line381">381: </a>        entriesToTransferTotal = (nNonDummyGhost[0] * stag-&gt;n[1] + stag-&gt;n[0] * nNonDummyGhost[1] - stag-&gt;n[0] * stag-&gt;n[1]) * stag-&gt;entriesPerElement
<a name="line382">382: </a>          + (dummyEnd[0]                ? nNonDummyGhost[1] * entriesPerEdge   : 0)
<a name="line383">383: </a>          + (dummyEnd[1]                ? nNonDummyGhost[0] * entriesPerEdge   : 0)
<a name="line384">384: </a>          + (dummyEnd[0] &amp;&amp; dummyEnd[1] ?                     entriesPerCorner : 0);
<a name="line385">385: </a>      } <font color="#4169E1">else</font> {
<a name="line386">386: </a>        entriesToTransferTotal = nNonDummyGhost[0] * nNonDummyGhost[1] * stag-&gt;entriesPerElement
<a name="line387">387: </a>          + (dummyEnd[0]                ? nNonDummyGhost[1] * entriesPerEdge   : 0)
<a name="line388">388: </a>          + (dummyEnd[1]                ? nNonDummyGhost[0] * entriesPerEdge   : 0)
<a name="line389">389: </a>          + (dummyEnd[0] &amp;&amp; dummyEnd[1] ?                     entriesPerCorner : 0);
<a name="line390">390: </a>      }
<a name="line391">391: </a>    }

<a name="line393">393: </a>    <font color="#B22222">/* Allocate arrays to populate */</font>
<a name="line394">394: </a>    <a href="../../../../docs/manualpages/Sys/PetscMalloc1.html#PetscMalloc1">PetscMalloc1</a>(entriesToTransferTotal,&amp;idxLocal);
<a name="line395">395: </a>    <a href="../../../../docs/manualpages/Sys/PetscMalloc1.html#PetscMalloc1">PetscMalloc1</a>(entriesToTransferTotal,&amp;idxGlobal);

<a name="line397">397: </a>    <font color="#B22222">/* Counts into idxLocal/idxGlobal */</font>
<a name="line398">398: </a>    count = 0;

<a name="line400">400: </a>    <font color="#B22222">/* Here and below, we work with (i,j) describing element numbers within a neighboring rank's global ordering,</font>
<a name="line401">401: </a><font color="#B22222">       to be offset by that rank's global offset,</font>
<a name="line402">402: </a><font color="#B22222">       and (ighost,jghost) referring to element numbers within this ranks local (ghosted) ordering */</font>

<a name="line404">404: </a>    <font color="#B22222">/* Neighbor 0 (down left) */</font>
<a name="line405">405: </a>    <font color="#4169E1">if</font> (!star &amp;&amp; !dummyStart[0] &amp;&amp; !dummyStart[1]) {
<a name="line406">406: </a>      const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         neighbor             = 0;
<a name="line407">407: </a>      const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         globalOffset         = globalOffsets[stag-&gt;neighbors[neighbor]];
<a name="line408">408: </a>      const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> * const nNeighbor            = nNeighbors[neighbor];
<a name="line409">409: </a>      const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> entriesPerElementRowNeighbor = stag-&gt;entriesPerElement * nNeighbor[0];
<a name="line410">410: </a>      <font color="#4169E1">for</font> (jghost = 0; jghost&lt;ghostOffsetStart[1]; ++jghost) {
<a name="line411">411: </a>        const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> j = nNeighbor[1] - ghostOffsetStart[1] + jghost;
<a name="line412">412: </a>        <font color="#4169E1">for</font> (ighost = 0; ighost&lt;ghostOffsetStart[0]; ++ighost) {
<a name="line413">413: </a>          const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> i = nNeighbor[0] - ghostOffsetStart[0] + ighost;
<a name="line414">414: </a>          <font color="#4169E1">for</font> (d=0; d&lt;stag-&gt;entriesPerElement; ++d,++count) {
<a name="line415">415: </a>            idxGlobal[count] = globalOffset + j     *entriesPerElementRowNeighbor + i     *stag-&gt;entriesPerElement + d;
<a name="line416">416: </a>            idxLocal[count]  =                jghost*entriesPerElementRowGhost    + ighost*stag-&gt;entriesPerElement + d;
<a name="line417">417: </a>          }
<a name="line418">418: </a>        }
<a name="line419">419: </a>      }
<a name="line420">420: </a>    }

<a name="line422">422: </a>    <font color="#B22222">/* Neighbor 1 (down) */</font>
<a name="line423">423: </a>    <font color="#4169E1">if</font> (!dummyStart[1]) {
<a name="line424">424: </a>      <font color="#B22222">/* We may be a ghosted boundary in x, in which case the neighbor is also */</font>
<a name="line425">425: </a>      const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         neighbor                     = 1;
<a name="line426">426: </a>      const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         globalOffset                 = globalOffsets[stag-&gt;neighbors[neighbor]];
<a name="line427">427: </a>      const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> * const nNeighbor                    = nNeighbors[neighbor];
<a name="line428">428: </a>      const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         entriesPerElementRowNeighbor = entriesPerElementRow; <font color="#B22222">/* same as here */</font>
<a name="line429">429: </a>      <font color="#4169E1">for</font> (jghost = 0; jghost&lt;ghostOffsetStart[1]; ++jghost) {
<a name="line430">430: </a>        const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> j = nNeighbor[1] - ghostOffsetStart[1] + jghost;
<a name="line431">431: </a>        <font color="#4169E1">for</font> (ighost = ghostOffsetStart[0]; ighost&lt;stag-&gt;nGhost[0]-ghostOffsetEnd[0]; ++ighost) {
<a name="line432">432: </a>          const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> i = ighost - ghostOffsetStart[0];
<a name="line433">433: </a>          <font color="#4169E1">for</font> (d=0; d&lt;stag-&gt;entriesPerElement; ++d, ++count) {
<a name="line434">434: </a>            idxGlobal[count] = globalOffset+ j     *entriesPerElementRowNeighbor + i     *stag-&gt;entriesPerElement + d;
<a name="line435">435: </a>            idxLocal[count]  =               jghost*entriesPerElementRowGhost    + ighost*stag-&gt;entriesPerElement + d;
<a name="line436">436: </a>          }
<a name="line437">437: </a>        }
<a name="line438">438: </a>        <font color="#4169E1">if</font> (dummyEnd[0]) {
<a name="line439">439: </a>          const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> ighost = stag-&gt;nGhost[0]-ghostOffsetEnd[0];
<a name="line440">440: </a>          const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> i = stag-&gt;n[0];
<a name="line441">441: </a>          <font color="#4169E1">for</font> (d=0; d&lt;stag-&gt;dof[0]; ++d, ++count) { <font color="#B22222">/* Vertex */</font>
<a name="line442">442: </a>            idxGlobal[count] = globalOffset + j     *entriesPerElementRowNeighbor + i     *stag-&gt;entriesPerElement + d;
<a name="line443">443: </a>            idxLocal[count]  =                jghost*entriesPerElementRowGhost    + ighost*stag-&gt;entriesPerElement + d;
<a name="line444">444: </a>          }
<a name="line445">445: </a>          <font color="#4169E1">for</font> (d=0; d&lt;stag-&gt;dof[1]; ++d,++count) { <font color="#B22222">/* Edge */</font>
<a name="line446">446: </a>            idxGlobal[count] = globalOffset + j     *entriesPerElementRowNeighbor + i     *stag-&gt;entriesPerElement + stag-&gt;dof[0]                + d;
<a name="line447">447: </a>            idxLocal[count]  =                jghost*entriesPerElementRowGhost    + ighost*stag-&gt;entriesPerElement + stag-&gt;dof[0] + stag-&gt;dof[1] + d;
<a name="line448">448: </a>          }
<a name="line449">449: </a>        }
<a name="line450">450: </a>      }
<a name="line451">451: </a>    }

<a name="line453">453: </a>    <font color="#B22222">/* Neighbor 2 (down right) */</font>
<a name="line454">454: </a>    <font color="#4169E1">if</font> (!star &amp;&amp; !dummyEnd[0] &amp;&amp; !dummyStart[1]) {
<a name="line455">455: </a>      const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         neighbor             = 2;
<a name="line456">456: </a>      const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         globalOffset         = globalOffsets[stag-&gt;neighbors[neighbor]];
<a name="line457">457: </a>      const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> * const nNeighbor            = nNeighbors[neighbor];
<a name="line458">458: </a>      const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> entriesPerElementRowNeighbor = nNeighbor[0]*stag-&gt;entriesPerElement + (nextToDummyEnd[0] ? entriesPerEdge : 0);
<a name="line459">459: </a>      <font color="#4169E1">for</font> (jghost = 0; jghost&lt;ghostOffsetStart[1]; ++jghost) {
<a name="line460">460: </a>        const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> j = nNeighbor[1] - ghostOffsetStart[1] + jghost;
<a name="line461">461: </a>        <font color="#4169E1">for</font> (i=0; i&lt;ghostOffsetEnd[0]; ++i) {
<a name="line462">462: </a>          const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> ighost = stag-&gt;nGhost[0] - ghostOffsetEnd[0] + i;
<a name="line463">463: </a>          <font color="#4169E1">for</font> (d=0; d&lt;stag-&gt;entriesPerElement; ++d, ++count) {
<a name="line464">464: </a>            idxGlobal[count] = globalOffset + j     *entriesPerElementRowNeighbor + i     *stag-&gt;entriesPerElement + d;
<a name="line465">465: </a>            idxLocal[count]  =                jghost*entriesPerElementRowGhost    + ighost*stag-&gt;entriesPerElement + d;
<a name="line466">466: </a>          }
<a name="line467">467: </a>        }
<a name="line468">468: </a>      }
<a name="line469">469: </a>    }

<a name="line471">471: </a>    <font color="#B22222">/* Neighbor 3 (left) */</font>
<a name="line472">472: </a>    <font color="#4169E1">if</font> (!dummyStart[0]) {
<a name="line473">473: </a>      <font color="#B22222">/* Our neighbor is never a ghosted boundary in x, but we may be</font>
<a name="line474">474: </a><font color="#B22222">         Here, we may be a ghosted boundary in y and thus so will our neighbor be */</font>
<a name="line475">475: </a>      const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         neighbor             = 3;
<a name="line476">476: </a>      const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         globalOffset         = globalOffsets[stag-&gt;neighbors[neighbor]];
<a name="line477">477: </a>      const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> * const nNeighbor            = nNeighbors[neighbor];
<a name="line478">478: </a>      const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> entriesPerElementRowNeighbor = nNeighbor[0]*stag-&gt;entriesPerElement;
<a name="line479">479: </a>      <font color="#4169E1">for</font> (jghost = ghostOffsetStart[1]; jghost&lt;stag-&gt;nGhost[1] - ghostOffsetEnd[1]; ++jghost) {
<a name="line480">480: </a>        const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> j = jghost-ghostOffsetStart[1];
<a name="line481">481: </a>        <font color="#4169E1">for</font> (ighost = 0; ighost&lt;ghostOffsetStart[0]; ++ighost) {
<a name="line482">482: </a>          const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> i = nNeighbor[0] - ghostOffsetStart[0] + ighost;
<a name="line483">483: </a>          <font color="#4169E1">for</font> (d=0; d&lt;stag-&gt;entriesPerElement; ++d, ++count) {
<a name="line484">484: </a>            idxGlobal[count] = globalOffset + j     *entriesPerElementRowNeighbor + i     *stag-&gt;entriesPerElement + d;
<a name="line485">485: </a>            idxLocal[count]  =                jghost*entriesPerElementRowGhost    + ighost*stag-&gt;entriesPerElement + d;
<a name="line486">486: </a>          }
<a name="line487">487: </a>        }
<a name="line488">488: </a>      }
<a name="line489">489: </a>      <font color="#4169E1">if</font> (dummyEnd[1]) {
<a name="line490">490: </a>        const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> jghost = stag-&gt;nGhost[1]-ghostOffsetEnd[1];
<a name="line491">491: </a>        const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> j = stag-&gt;n[1];
<a name="line492">492: </a>        <font color="#4169E1">for</font> (ighost = 0; ighost&lt;ghostOffsetStart[0]; ++ighost) {
<a name="line493">493: </a>          const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> i = nNeighbor[0] - ghostOffsetStart[0] + ighost;
<a name="line494">494: </a>          <font color="#4169E1">for</font> (d=0; d&lt;entriesPerEdge; ++d, ++count) { <font color="#B22222">/* only vertices and horizontal edge (which are the first dof) */</font>
<a name="line495">495: </a>            idxGlobal[count] = globalOffset + j     *entriesPerElementRowNeighbor + i     *entriesPerEdge          + d; <font color="#B22222">/* i moves by edge here */</font>
<a name="line496">496: </a>            idxLocal[count]  =                jghost*entriesPerElementRowGhost    + ighost*stag-&gt;entriesPerElement + d;
<a name="line497">497: </a>          }
<a name="line498">498: </a>        }
<a name="line499">499: </a>      }
<a name="line500">500: </a>    }

<a name="line502">502: </a>    <font color="#B22222">/* Interior/Resident-here-in-global elements ("Neighbor 4" - same rank)</font>
<a name="line503">503: </a><font color="#B22222">       *including* entries from boundary dummy elements */</font>
<a name="line504">504: </a>    {
<a name="line505">505: </a>      const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> neighbor     = 4;
<a name="line506">506: </a>      const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> globalOffset = globalOffsets[stag-&gt;neighbors[neighbor]];
<a name="line507">507: </a>      <font color="#4169E1">for</font> (j=0; j&lt;stag-&gt;n[1]; ++j) {
<a name="line508">508: </a>        const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> jghost = j + ghostOffsetStart[1];
<a name="line509">509: </a>        <font color="#4169E1">for</font> (i=0; i&lt;stag-&gt;n[0]; ++i) {
<a name="line510">510: </a>          const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> ighost = i + ghostOffsetStart[0];
<a name="line511">511: </a>          <font color="#4169E1">for</font> (d=0; d&lt;stag-&gt;entriesPerElement; ++d, ++count) {
<a name="line512">512: </a>            idxGlobal[count] = globalOffset + j     *entriesPerElementRow       + i     *stag-&gt;entriesPerElement + d;
<a name="line513">513: </a>            idxLocal[count]  =                jghost*entriesPerElementRowGhost  + ighost*stag-&gt;entriesPerElement + d;
<a name="line514">514: </a>          }
<a name="line515">515: </a>        }
<a name="line516">516: </a>        <font color="#4169E1">if</font> (dummyEnd[0]) {
<a name="line517">517: </a>          const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> ighost = i + ghostOffsetStart[0];
<a name="line518">518: </a>          i = stag-&gt;n[0];
<a name="line519">519: </a>          <font color="#4169E1">for</font> (d=0; d&lt;stag-&gt;dof[0]; ++d, ++count) { <font color="#B22222">/* vertex first */</font>
<a name="line520">520: </a>            idxGlobal[count] = globalOffset + j     *entriesPerElementRow      + i     *stag-&gt;entriesPerElement + d;
<a name="line521">521: </a>            idxLocal[count]  =                jghost*entriesPerElementRowGhost + ighost*stag-&gt;entriesPerElement + d;
<a name="line522">522: </a>          }
<a name="line523">523: </a>          <font color="#4169E1">for</font> (d=0; d&lt;stag-&gt;dof[1]; ++d, ++count) { <font color="#B22222">/* then left ege (skipping bottom edge) */</font>
<a name="line524">524: </a>            idxGlobal[count] = globalOffset + j     *entriesPerElementRow       + i     *stag-&gt;entriesPerElement + stag-&gt;dof[0]                + d;
<a name="line525">525: </a>            idxLocal[count]  =                jghost*entriesPerElementRowGhost  + ighost*stag-&gt;entriesPerElement + stag-&gt;dof[0] + stag-&gt;dof[1] + d;
<a name="line526">526: </a>          }
<a name="line527">527: </a>        }
<a name="line528">528: </a>      }
<a name="line529">529: </a>      <font color="#4169E1">if</font> (dummyEnd[1]) {
<a name="line530">530: </a>        const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> jghost = j + ghostOffsetStart[1];
<a name="line531">531: </a>        j = stag-&gt;n[1];
<a name="line532">532: </a>        <font color="#4169E1">for</font> (i=0; i&lt;stag-&gt;n[0]; ++i) {
<a name="line533">533: </a>          const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> ighost = i + ghostOffsetStart[0];
<a name="line534">534: </a>          <font color="#4169E1">for</font> (d=0; d&lt;entriesPerEdge; ++d, ++count) { <font color="#B22222">/* vertex and bottom edge (which are the first entries) */</font>
<a name="line535">535: </a>            idxGlobal[count] = globalOffset + j     *entriesPerElementRow +      i*entriesPerEdge               + d; <font color="#B22222">/* note i increment by entriesPerEdge */</font>
<a name="line536">536: </a>            idxLocal[count]  =                jghost*entriesPerElementRowGhost + ighost*stag-&gt;entriesPerElement + d;
<a name="line537">537: </a>          }
<a name="line538">538: </a>        }
<a name="line539">539: </a>        <font color="#4169E1">if</font> (dummyEnd[0]) {
<a name="line540">540: </a>          const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> ighost = i + ghostOffsetStart[0];
<a name="line541">541: </a>          i = stag-&gt;n[0];
<a name="line542">542: </a>          <font color="#4169E1">for</font> (d=0; d&lt;entriesPerCorner; ++d, ++count) { <font color="#B22222">/* vertex only */</font>
<a name="line543">543: </a>            idxGlobal[count] = globalOffset + j     *entriesPerElementRow       + i     *entriesPerEdge          + d; <font color="#B22222">/* note i increment by entriesPerEdge */</font>
<a name="line544">544: </a>            idxLocal[count]  =                jghost*entriesPerElementRowGhost  + ighost*stag-&gt;entriesPerElement + d;
<a name="line545">545: </a>          }
<a name="line546">546: </a>        }
<a name="line547">547: </a>      }
<a name="line548">548: </a>    }

<a name="line550">550: </a>    <font color="#B22222">/* Neighbor 5 (right) */</font>
<a name="line551">551: </a>    <font color="#4169E1">if</font> (!dummyEnd[0]) {
<a name="line552">552: </a>      <font color="#B22222">/* We can never be right boundary, but we may be a top boundary, along with the right neighbor */</font>
<a name="line553">553: </a>      const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         neighbor             = 5;
<a name="line554">554: </a>      const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         globalOffset         = globalOffsets[stag-&gt;neighbors[neighbor]];
<a name="line555">555: </a>      const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> * const nNeighbor            = nNeighbors[neighbor];
<a name="line556">556: </a>      const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> entriesPerElementRowNeighbor = nNeighbor[0]*stag-&gt;entriesPerElement + (nextToDummyEnd[0] ? entriesPerEdge : 0);
<a name="line557">557: </a>      <font color="#4169E1">for</font> (jghost = ghostOffsetStart[1];jghost&lt;stag-&gt;nGhost[1]-ghostOffsetEnd[1]; ++jghost) {
<a name="line558">558: </a>        const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> j = jghost-ghostOffsetStart[1];
<a name="line559">559: </a>        <font color="#4169E1">for</font> (i=0; i&lt;ghostOffsetEnd[0]; ++i) {
<a name="line560">560: </a>          const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> ighost = stag-&gt;nGhost[0] - ghostOffsetEnd[0] + i;
<a name="line561">561: </a>          <font color="#4169E1">for</font> (d=0; d&lt;stag-&gt;entriesPerElement; ++d, ++count) {
<a name="line562">562: </a>            idxGlobal[count] = globalOffset+ j     *entriesPerElementRowNeighbor + i     *stag-&gt;entriesPerElement + d;
<a name="line563">563: </a>            idxLocal[count]  =               jghost*entriesPerElementRowGhost    + ighost*stag-&gt;entriesPerElement + d;
<a name="line564">564: </a>          }
<a name="line565">565: </a>        }
<a name="line566">566: </a>      }
<a name="line567">567: </a>      <font color="#4169E1">if</font> (dummyEnd[1]) {
<a name="line568">568: </a>        const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> jghost = stag-&gt;nGhost[1]-ghostOffsetEnd[1];
<a name="line569">569: </a>        const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> j = nNeighbor[1];
<a name="line570">570: </a>        <font color="#4169E1">for</font> (i=0; i&lt;ghostOffsetEnd[0]; ++i) {
<a name="line571">571: </a>          const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> ighost = stag-&gt;nGhost[0] - ghostOffsetEnd[0] + i;
<a name="line572">572: </a>          <font color="#4169E1">for</font> (d=0; d&lt;entriesPerEdge; ++d, ++count) { <font color="#B22222">/* only vertices and horizontal edge (which are the first dof) */</font>
<a name="line573">573: </a>            idxGlobal[count] = globalOffset+ j     *entriesPerElementRowNeighbor    + i     *entriesPerEdge    + d; <font color="#B22222">/* Note i increment by entriesPerEdge */</font>
<a name="line574">574: </a>            idxLocal[count]  =               jghost*entriesPerElementRowGhost + ighost*stag-&gt;entriesPerElement + d;
<a name="line575">575: </a>          }
<a name="line576">576: </a>        }
<a name="line577">577: </a>      }
<a name="line578">578: </a>    }

<a name="line580">580: </a>    <font color="#B22222">/* Neighbor 6 (up left) */</font>
<a name="line581">581: </a>    <font color="#4169E1">if</font> (!star &amp;&amp; !dummyStart[0] &amp;&amp; !dummyEnd[1]) {
<a name="line582">582: </a>      <font color="#B22222">/* We can never be a top boundary, but our neighbor may be</font>
<a name="line583">583: </a><font color="#B22222">       We may be a right boundary, but our neighbor cannot be */</font>
<a name="line584">584: </a>      const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         neighbor             = 6;
<a name="line585">585: </a>      const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         globalOffset         = globalOffsets[stag-&gt;neighbors[neighbor]];
<a name="line586">586: </a>      const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> * const nNeighbor            = nNeighbors[neighbor];
<a name="line587">587: </a>      const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> entriesPerElementRowNeighbor = nNeighbor[0]*stag-&gt;entriesPerElement;
<a name="line588">588: </a>      <font color="#4169E1">for</font> (j=0; j&lt;ghostOffsetEnd[1]; ++j) {
<a name="line589">589: </a>        const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> jghost = stag-&gt;nGhost[1] - ghostOffsetEnd[1] + j;
<a name="line590">590: </a>        <font color="#4169E1">for</font> (ighost = 0; ighost&lt;ghostOffsetStart[0]; ++ighost) {
<a name="line591">591: </a>          const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> i = nNeighbor[0] - ghostOffsetStart[0] + ighost;
<a name="line592">592: </a>          <font color="#4169E1">for</font> (d=0; d&lt;stag-&gt;entriesPerElement; ++d, ++count) {
<a name="line593">593: </a>            idxGlobal[count] = globalOffset+ j     *entriesPerElementRowNeighbor + i     *stag-&gt;entriesPerElement + d;
<a name="line594">594: </a>            idxLocal[count]  =               jghost*entriesPerElementRowGhost    + ighost*stag-&gt;entriesPerElement + d;
<a name="line595">595: </a>          }
<a name="line596">596: </a>        }
<a name="line597">597: </a>      }
<a name="line598">598: </a>    }

<a name="line600">600: </a>    <font color="#B22222">/* Neighbor 7 (up) */</font>
<a name="line601">601: </a>    <font color="#4169E1">if</font> (!dummyEnd[1]) {
<a name="line602">602: </a>      <font color="#B22222">/* We cannot be the last rank in y, though our neighbor may be</font>
<a name="line603">603: </a><font color="#B22222">       We may be the last rank in x, in which case our neighbor is also */</font>
<a name="line604">604: </a>      const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         neighbor             = 7;
<a name="line605">605: </a>      const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         globalOffset         = globalOffsets[stag-&gt;neighbors[neighbor]];
<a name="line606">606: </a>      const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> * const nNeighbor            = nNeighbors[neighbor];
<a name="line607">607: </a>      const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> entriesPerElementRowNeighbor = entriesPerElementRow; <font color="#B22222">/* same as here */</font>
<a name="line608">608: </a>      <font color="#4169E1">for</font> (j=0; j&lt;ghostOffsetEnd[1]; ++j) {
<a name="line609">609: </a>        const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> jghost = stag-&gt;nGhost[1] - ghostOffsetEnd[1] + j;
<a name="line610">610: </a>        <font color="#4169E1">for</font> (ighost = ghostOffsetStart[0]; ighost&lt;stag-&gt;nGhost[0]-ghostOffsetEnd[0]; ++ighost) {
<a name="line611">611: </a>          const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> i = ighost - ghostOffsetStart[0];
<a name="line612">612: </a>          <font color="#4169E1">for</font> (d=0; d&lt;stag-&gt;entriesPerElement; ++d, ++count) {
<a name="line613">613: </a>            idxGlobal[count] = globalOffset + j     *entriesPerElementRowNeighbor + i     *stag-&gt;entriesPerElement + d;
<a name="line614">614: </a>            idxLocal[count]  =                jghost*entriesPerElementRowGhost    + ighost*stag-&gt;entriesPerElement + d;
<a name="line615">615: </a>          }
<a name="line616">616: </a>        }
<a name="line617">617: </a>        <font color="#4169E1">if</font> (dummyEnd[0]) {
<a name="line618">618: </a>          const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> ighost = stag-&gt;nGhost[0]-ghostOffsetEnd[0];
<a name="line619">619: </a>          const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> i = nNeighbor[0];
<a name="line620">620: </a>          <font color="#4169E1">for</font> (d=0; d&lt;stag-&gt;dof[0]; ++d, ++count) { <font color="#B22222">/* Vertex */</font>
<a name="line621">621: </a>            idxGlobal[count] = globalOffset+ j     *entriesPerElementRowNeighbor + i     *stag-&gt;entriesPerElement + d;
<a name="line622">622: </a>            idxLocal[count]  =               jghost*entriesPerElementRowGhost    + ighost*stag-&gt;entriesPerElement + d;
<a name="line623">623: </a>          }
<a name="line624">624: </a>          <font color="#4169E1">for</font> (d=0; d&lt;stag-&gt;dof[1]; ++d, ++count) { <font color="#B22222">/* Edge */</font>
<a name="line625">625: </a>            idxGlobal[count] = globalOffset+ j     *entriesPerElementRowNeighbor + i     *stag-&gt;entriesPerElement + stag-&gt;dof[0]                + d;
<a name="line626">626: </a>            idxLocal[count]  =               jghost*entriesPerElementRowGhost    + ighost*stag-&gt;entriesPerElement + stag-&gt;dof[0] + stag-&gt;dof[1] + d;
<a name="line627">627: </a>          }
<a name="line628">628: </a>        }
<a name="line629">629: </a>      }
<a name="line630">630: </a>    }

<a name="line632">632: </a>    <font color="#B22222">/* Neighbor 8 (up right) */</font>
<a name="line633">633: </a>    <font color="#4169E1">if</font> (!star &amp;&amp; !dummyEnd[0] &amp;&amp; !dummyEnd[1]) {
<a name="line634">634: </a>      <font color="#B22222">/* We can never be a ghosted boundary</font>
<a name="line635">635: </a><font color="#B22222">         Our neighbor may be a top boundary, a right boundary, or both */</font>
<a name="line636">636: </a>      const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         neighbor             = 8;
<a name="line637">637: </a>      const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         globalOffset         = globalOffsets[stag-&gt;neighbors[neighbor]];
<a name="line638">638: </a>      const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> * const nNeighbor            = nNeighbors[neighbor];
<a name="line639">639: </a>      const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> entriesPerElementRowNeighbor = nNeighbor[0]*stag-&gt;entriesPerElement + (nextToDummyEnd[0] ? entriesPerEdge : 0);
<a name="line640">640: </a>      <font color="#4169E1">for</font> (j=0; j&lt;ghostOffsetEnd[1]; ++j) {
<a name="line641">641: </a>        const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> jghost = stag-&gt;nGhost[1] - ghostOffsetEnd[1] + j;
<a name="line642">642: </a>        <font color="#4169E1">for</font> (i=0; i&lt;ghostOffsetEnd[0]; ++i) {
<a name="line643">643: </a>          const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> ighost = stag-&gt;nGhost[0] - ghostOffsetEnd[0] + i;
<a name="line644">644: </a>          <font color="#4169E1">for</font> (d=0; d&lt;stag-&gt;entriesPerElement; ++d, ++count) {
<a name="line645">645: </a>            idxGlobal[count] = globalOffset + j     *entriesPerElementRowNeighbor + i     *stag-&gt;entriesPerElement + d;
<a name="line646">646: </a>            idxLocal[count]  =                jghost*entriesPerElementRowGhost    + ighost*stag-&gt;entriesPerElement + d;
<a name="line647">647: </a>          }
<a name="line648">648: </a>        }
<a name="line649">649: </a>      }
<a name="line650">650: </a>    }

<a name="line652">652: </a><font color="#A020F0">#if defined(PETSC_USE_DEBUG)</font>
<a name="line653">653: </a>    <font color="#4169E1">if</font> (count != entriesToTransferTotal) <a href="../../../../docs/manualpages/Sys/SETERRQ2.html#SETERRQ2">SETERRQ2</a>(<a href="../../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</a>,PETSC_ERR_PLIB,<font color="#666666">"Number of entries computed in gtol (%d) is not as expected (%d)"</font>,count,entriesToTransferTotal);
<a name="line654">654: </a><font color="#A020F0">#endif</font>

<a name="line656">656: </a>    <font color="#B22222">/* Create Local and Global ISs (transferring pointer ownership) */</font>
<a name="line657">657: </a>    <a href="../../../../docs/manualpages/IS/ISCreateGeneral.html#ISCreateGeneral">ISCreateGeneral</a>(<a href="../../../../docs/manualpages/Sys/PetscObjectComm.html#PetscObjectComm">PetscObjectComm</a>((<a href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)dm),entriesToTransferTotal,idxLocal,<a href="../../../../docs/manualpages/Sys/PetscCopyMode.html#PetscCopyMode">PETSC_OWN_POINTER</a>,&amp;isLocal);
<a name="line658">658: </a>    <a href="../../../../docs/manualpages/IS/ISCreateGeneral.html#ISCreateGeneral">ISCreateGeneral</a>(<a href="../../../../docs/manualpages/Sys/PetscObjectComm.html#PetscObjectComm">PetscObjectComm</a>((<a href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)dm),entriesToTransferTotal,idxGlobal,<a href="../../../../docs/manualpages/Sys/PetscCopyMode.html#PetscCopyMode">PETSC_OWN_POINTER</a>,&amp;isGlobal);

<a name="line660">660: </a>    <font color="#B22222">/* Create stag-&gt;gtol. The order is computed as PETSc ordering, and doesn't include dummy entries */</font>
<a name="line661">661: </a>    {
<a name="line662">662: </a>      <a href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</a> local,global;
<a name="line663">663: </a>      <a href="../../../../docs/manualpages/Vec/VecCreateMPIWithArray.html#VecCreateMPIWithArray">VecCreateMPIWithArray</a>(<a href="../../../../docs/manualpages/Sys/PetscObjectComm.html#PetscObjectComm">PetscObjectComm</a>((<a href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)dm),1,stag-&gt;entries,<a href="../../../../docs/manualpages/Sys/PETSC_DECIDE.html#PETSC_DECIDE">PETSC_DECIDE</a>,NULL,&amp;global);
<a name="line664">664: </a>      <a href="../../../../docs/manualpages/Vec/VecCreateSeqWithArray.html#VecCreateSeqWithArray">VecCreateSeqWithArray</a>(<a href="../../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</a>,stag-&gt;entriesPerElement,stag-&gt;entriesGhost,NULL,&amp;local);
<a name="line665">665: </a>      <a href="../../../../docs/manualpages/Vec/VecScatterCreate.html#VecScatterCreate">VecScatterCreate</a>(global,isGlobal,local,isLocal,&amp;stag-&gt;gtol);
<a name="line666">666: </a>      <a href="../../../../docs/manualpages/Vec/VecDestroy.html#VecDestroy">VecDestroy</a>(&amp;global);
<a name="line667">667: </a>      <a href="../../../../docs/manualpages/Vec/VecDestroy.html#VecDestroy">VecDestroy</a>(&amp;local);
<a name="line668">668: </a>    }

<a name="line670">670: </a>    <font color="#B22222">/* Destroy ISs */</font>
<a name="line671">671: </a>    <a href="../../../../docs/manualpages/IS/ISDestroy.html#ISDestroy">ISDestroy</a>(&amp;isLocal);
<a name="line672">672: </a>    <a href="../../../../docs/manualpages/IS/ISDestroy.html#ISDestroy">ISDestroy</a>(&amp;isGlobal);

<a name="line674">674: </a>    <font color="#B22222">/* Next, we iterate over the local entries  again, in local order, recording the global entry to which each maps,</font>
<a name="line675">675: </a><font color="#B22222">       or -1 if there is none */</font>
<a name="line676">676: </a>    <a href="../../../../docs/manualpages/Sys/PetscMalloc1.html#PetscMalloc1">PetscMalloc1</a>(stag-&gt;entriesGhost,&amp;idxGlobalAll);

<a name="line678">678: </a>    countAll = 0;

<a name="line680">680: </a>    <font color="#B22222">/* Loop over rows 1/3 : down */</font>
<a name="line681">681: </a>    <font color="#4169E1">if</font> (!dummyStart[1]) {
<a name="line682">682: </a>      <font color="#4169E1">for</font> (jghost=0; jghost&lt;ghostOffsetStart[1]; ++jghost) {

<a name="line684">684: </a>        <font color="#B22222">/* Loop over columns 1/3 : down left */</font>
<a name="line685">685: </a>        <font color="#4169E1">if</font> (!star &amp;&amp; !dummyStart[0]) {
<a name="line686">686: </a>          const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         neighbor     = 0;
<a name="line687">687: </a>          const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         globalOffset = globalOffsets[stag-&gt;neighbors[neighbor]];
<a name="line688">688: </a>          const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> * const nNeighbor    = nNeighbors[neighbor];
<a name="line689">689: </a>          const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         j            = nNeighbor[1] - ghostOffsetStart[1] + jghost; <font color="#B22222">/* Note: this is actually the same value for the whole row of ranks below, so recomputing it for the next two ranks is redundant, and one could even get rid of jghost entirely if desired */</font>
<a name="line690">690: </a>          const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         eprNeighbor  = nNeighbor[0] * stag-&gt;entriesPerElement;
<a name="line691">691: </a>          <font color="#4169E1">for</font> (i=nNeighbor[0]-ghostOffsetStart[0]; i&lt;nNeighbor[0]; ++i) {
<a name="line692">692: </a>            <font color="#4169E1">for</font> (d=0; d&lt;stag-&gt;entriesPerElement; ++d, ++countAll) {
<a name="line693">693: </a>              idxGlobalAll[countAll] = globalOffset + j*eprNeighbor + i*stag-&gt;entriesPerElement + d;
<a name="line694">694: </a>            }
<a name="line695">695: </a>          }
<a name="line696">696: </a>        } <font color="#4169E1">else</font> {
<a name="line697">697: </a>          <font color="#B22222">/* Down Left dummies */</font>
<a name="line698">698: </a>          <font color="#4169E1">for</font> (ighost=0; ighost&lt;ghostOffsetStart[0]; ++ighost) {
<a name="line699">699: </a>            <font color="#4169E1">for</font> (d=0; d&lt;stag-&gt;entriesPerElement; ++d, ++countAll) {
<a name="line700">700: </a>              idxGlobalAll[countAll] = -1;
<a name="line701">701: </a>            }
<a name="line702">702: </a>          }
<a name="line703">703: </a>        }

<a name="line705">705: </a>        <font color="#B22222">/* Loop over columns 2/3 : down middle */</font>
<a name="line706">706: </a>        {
<a name="line707">707: </a>          const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         neighbor     = 1;
<a name="line708">708: </a>          const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         globalOffset = globalOffsets[stag-&gt;neighbors[neighbor]];
<a name="line709">709: </a>          const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> * const nNeighbor    = nNeighbors[neighbor];
<a name="line710">710: </a>          const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         j            = nNeighbor[1] - ghostOffsetStart[1] + jghost;
<a name="line711">711: </a>          const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         eprNeighbor  = entriesPerElementRow; <font color="#B22222">/* same as here */</font>
<a name="line712">712: </a>          <font color="#4169E1">for</font> (i=0; i&lt;nNeighbor[0]; ++i) {
<a name="line713">713: </a>            <font color="#4169E1">for</font> (d=0; d&lt;stag-&gt;entriesPerElement; ++d, ++countAll) {
<a name="line714">714: </a>              idxGlobalAll[countAll] = globalOffset + j*eprNeighbor + i*stag-&gt;entriesPerElement + d;
<a name="line715">715: </a>            }
<a name="line716">716: </a>          }
<a name="line717">717: </a>        }

<a name="line719">719: </a>        <font color="#B22222">/* Loop over columns 3/3 : down right */</font>
<a name="line720">720: </a>        <font color="#4169E1">if</font> (!star &amp;&amp; !dummyEnd[0]) {
<a name="line721">721: </a>          const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         neighbor     = 2;
<a name="line722">722: </a>          const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         globalOffset = globalOffsets[stag-&gt;neighbors[neighbor]];
<a name="line723">723: </a>          const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> * const nNeighbor    = nNeighbors[neighbor];
<a name="line724">724: </a>          const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         j            = nNeighbor[1] - ghostOffsetStart[1] + jghost;
<a name="line725">725: </a>          const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         eprNeighbor  = nNeighbor[0]*stag-&gt;entriesPerElement + (nextToDummyEnd[0] ? entriesPerEdge : 0);
<a name="line726">726: </a>          <font color="#4169E1">for</font> (i=0; i&lt;ghostOffsetEnd[0]; ++i) {
<a name="line727">727: </a>            <font color="#4169E1">for</font> (d=0; d&lt;stag-&gt;entriesPerElement; ++d, ++countAll) {
<a name="line728">728: </a>              idxGlobalAll[countAll] = globalOffset + j*eprNeighbor + i*stag-&gt;entriesPerElement + d;
<a name="line729">729: </a>            }
<a name="line730">730: </a>          }
<a name="line731">731: </a>        } <font color="#4169E1">else</font> <font color="#4169E1">if</font> (dummyEnd[0]) {
<a name="line732">732: </a>          <font color="#B22222">/* Down right partial dummy elements, living on the *down* rank */</font>
<a name="line733">733: </a>          const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         neighbor     = 1;
<a name="line734">734: </a>          const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         globalOffset = globalOffsets[stag-&gt;neighbors[neighbor]];
<a name="line735">735: </a>          const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> * const nNeighbor    = nNeighbors[neighbor];
<a name="line736">736: </a>          const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         j            = nNeighbor[1] - ghostOffsetStart[1] + jghost;
<a name="line737">737: </a>          const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         eprNeighbor  = entriesPerElementRow; <font color="#B22222">/* same as here */</font>
<a name="line738">738: </a>          <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> dGlobal;
<a name="line739">739: </a>          i = nNeighbor[0];
<a name="line740">740: </a>          <font color="#4169E1">for</font> (d=0,dGlobal=0; d&lt;stag-&gt;dof[0]; ++d, ++dGlobal, ++countAll) {
<a name="line741">741: </a>            idxGlobalAll[countAll] = globalOffset + j*eprNeighbor + i*stag-&gt;entriesPerElement + dGlobal;
<a name="line742">742: </a>          }
<a name="line743">743: </a>          <font color="#4169E1">for</font> (; d&lt;stag-&gt;dof[0] + stag-&gt;dof[1]; ++d, ++countAll) {
<a name="line744">744: </a>            idxGlobalAll[countAll] = -1; <font color="#B22222">/* dummy down edge point */</font>
<a name="line745">745: </a>          }
<a name="line746">746: </a>          <font color="#4169E1">for</font> (; d&lt;stag-&gt;dof[0] + 2*stag-&gt;dof[1]; ++d, ++dGlobal, ++countAll) {
<a name="line747">747: </a>            idxGlobalAll[countAll] = globalOffset + j*eprNeighbor + i*stag-&gt;entriesPerElement + dGlobal;
<a name="line748">748: </a>          }
<a name="line749">749: </a>          <font color="#4169E1">for</font> (; d&lt;stag-&gt;entriesPerElement; ++d, ++countAll) {
<a name="line750">750: </a>            idxGlobalAll[countAll] = -1; <font color="#B22222">/* dummy element point */</font>
<a name="line751">751: </a>          }
<a name="line752">752: </a>          ++i;
<a name="line753">753: </a>          <font color="#4169E1">for</font> (; i&lt;nNeighbor[0]+ghostOffsetEnd[0]; ++i) {
<a name="line754">754: </a>            <font color="#4169E1">for</font> (d=0; d&lt;stag-&gt;entriesPerElement; ++d, ++countAll) {
<a name="line755">755: </a>              idxGlobalAll[countAll] = -1;
<a name="line756">756: </a>            }
<a name="line757">757: </a>          }
<a name="line758">758: </a>        } <font color="#4169E1">else</font> {
<a name="line759">759: </a>          <font color="#B22222">/* Down Right dummies */</font>
<a name="line760">760: </a>          <font color="#4169E1">for</font> (ighost=0; ighost&lt;ghostOffsetEnd[0]; ++ighost) {
<a name="line761">761: </a>            <font color="#4169E1">for</font> (d=0; d&lt;stag-&gt;entriesPerElement; ++d, ++countAll) {
<a name="line762">762: </a>              idxGlobalAll[countAll] = -1;
<a name="line763">763: </a>            }
<a name="line764">764: </a>          }
<a name="line765">765: </a>        }
<a name="line766">766: </a>      }
<a name="line767">767: </a>    } <font color="#4169E1">else</font> {
<a name="line768">768: </a>      <font color="#B22222">/* Down dummies row */</font>
<a name="line769">769: </a>      <font color="#4169E1">for</font> (jghost=0; jghost&lt;ghostOffsetStart[1]; ++jghost) {
<a name="line770">770: </a>        <font color="#4169E1">for</font> (ighost=0; ighost&lt;stag-&gt;nGhost[0]; ++ighost) {
<a name="line771">771: </a>          <font color="#4169E1">for</font> (d=0; d&lt;stag-&gt;entriesPerElement; ++d, ++countAll) {
<a name="line772">772: </a>            idxGlobalAll[countAll] = -1;
<a name="line773">773: </a>          }
<a name="line774">774: </a>        }
<a name="line775">775: </a>      }
<a name="line776">776: </a>    }

<a name="line778">778: </a>    <font color="#B22222">/* Loop over rows 2/3 : center */</font>
<a name="line779">779: </a>    <font color="#4169E1">for</font> (j=0; j&lt;stag-&gt;n[1]; ++j) {
<a name="line780">780: </a>      <font color="#B22222">/* Loop over columns 1/3 : left */</font>
<a name="line781">781: </a>      <font color="#4169E1">if</font> (!dummyStart[0]) {
<a name="line782">782: </a>        const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         neighbor     = 3;
<a name="line783">783: </a>        const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         globalOffset = globalOffsets[stag-&gt;neighbors[neighbor]];
<a name="line784">784: </a>        const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> * const nNeighbor    = nNeighbors[neighbor];
<a name="line785">785: </a>        const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         eprNeighbor  = nNeighbor[0] * stag-&gt;entriesPerElement;
<a name="line786">786: </a>        <font color="#4169E1">for</font> (i=nNeighbor[0]-ghostOffsetStart[0]; i&lt;nNeighbor[0]; ++i) {
<a name="line787">787: </a>          <font color="#4169E1">for</font> (d=0; d&lt;stag-&gt;entriesPerElement; ++d, ++countAll) {
<a name="line788">788: </a>            idxGlobalAll[countAll] = globalOffset + j*eprNeighbor + i*stag-&gt;entriesPerElement + d;
<a name="line789">789: </a>          }
<a name="line790">790: </a>        }
<a name="line791">791: </a>      } <font color="#4169E1">else</font> {
<a name="line792">792: </a>        <font color="#B22222">/* (Middle) Left dummies */</font>
<a name="line793">793: </a>        <font color="#4169E1">for</font> (ighost=0; ighost &lt; ghostOffsetStart[0]; ++ighost) {
<a name="line794">794: </a>          <font color="#4169E1">for</font> (d=0; d&lt;stag-&gt;entriesPerElement; ++d, ++countAll) {
<a name="line795">795: </a>            idxGlobalAll[countAll] = -1;
<a name="line796">796: </a>          }
<a name="line797">797: </a>        }
<a name="line798">798: </a>      }

<a name="line800">800: </a>      <font color="#B22222">/* Loop over columns 2/3 : here (the "neighbor" is ourselves, here) */</font>
<a name="line801">801: </a>      {
<a name="line802">802: </a>        const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> neighbor     = 4;
<a name="line803">803: </a>        const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> globalOffset = globalOffsets[stag-&gt;neighbors[neighbor]];
<a name="line804">804: </a>        const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> eprNeighbor  = entriesPerElementRow; <font color="#B22222">/* same as here (obviously) */</font>
<a name="line805">805: </a>        <font color="#4169E1">for</font> (i=0; i&lt;stag-&gt;n[0]; ++i) {
<a name="line806">806: </a>          <font color="#4169E1">for</font> (d=0; d&lt;stag-&gt;entriesPerElement; ++d, ++countAll) {
<a name="line807">807: </a>            idxGlobalAll[countAll] = globalOffset + j*eprNeighbor + i*stag-&gt;entriesPerElement + d;
<a name="line808">808: </a>          }
<a name="line809">809: </a>        }
<a name="line810">810: </a>      }

<a name="line812">812: </a>      <font color="#B22222">/* Loop over columns 3/3 : right */</font>
<a name="line813">813: </a>      <font color="#4169E1">if</font> (!dummyEnd[0]) {
<a name="line814">814: </a>          const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         neighbor     = 5;
<a name="line815">815: </a>          const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         globalOffset = globalOffsets[stag-&gt;neighbors[neighbor]];
<a name="line816">816: </a>          const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> * const nNeighbor    = nNeighbors[neighbor];
<a name="line817">817: </a>          const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         eprNeighbor  = nNeighbor[0]*stag-&gt;entriesPerElement + (nextToDummyEnd[0] ? entriesPerEdge : 0);
<a name="line818">818: </a>        <font color="#4169E1">for</font> (i=0; i&lt;ghostOffsetEnd[0]; ++i) {
<a name="line819">819: </a>          <font color="#4169E1">for</font> (d=0; d&lt;stag-&gt;entriesPerElement; ++d, ++countAll) {
<a name="line820">820: </a>            idxGlobalAll[countAll] = globalOffset + j*eprNeighbor + i*stag-&gt;entriesPerElement + d;
<a name="line821">821: </a>          }
<a name="line822">822: </a>        }
<a name="line823">823: </a>      } <font color="#4169E1">else</font> {
<a name="line824">824: </a>        <font color="#B22222">/* -1's for right layer of partial dummies, living on *this* rank */</font>
<a name="line825">825: </a>        const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         neighbor     = 4;
<a name="line826">826: </a>        const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         globalOffset = globalOffsets[stag-&gt;neighbors[neighbor]];
<a name="line827">827: </a>        const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> * const nNeighbor    = nNeighbors[neighbor];
<a name="line828">828: </a>        const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         eprNeighbor  = entriesPerElementRow; <font color="#B22222">/* same as here (obviously) */</font>
<a name="line829">829: </a>        <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> dGlobal;
<a name="line830">830: </a>        i = nNeighbor[0];
<a name="line831">831: </a>        <font color="#4169E1">for</font> (d=0,dGlobal=0; d&lt;stag-&gt;dof[0]; ++d, ++dGlobal, ++countAll) {
<a name="line832">832: </a>          idxGlobalAll[countAll] = globalOffset + j*eprNeighbor + i*stag-&gt;entriesPerElement + dGlobal;
<a name="line833">833: </a>        }
<a name="line834">834: </a>        <font color="#4169E1">for</font> (; d&lt;stag-&gt;dof[0] + stag-&gt;dof[1]; ++d, ++countAll) {
<a name="line835">835: </a>          idxGlobalAll[countAll] = -1; <font color="#B22222">/* dummy down edge point */</font>
<a name="line836">836: </a>        }
<a name="line837">837: </a>        <font color="#4169E1">for</font> (; d&lt;stag-&gt;dof[0] + 2*stag-&gt;dof[1]; ++d, ++dGlobal, ++countAll) {
<a name="line838">838: </a>          idxGlobalAll[countAll] = globalOffset + j*eprNeighbor + i*stag-&gt;entriesPerElement + dGlobal;
<a name="line839">839: </a>        }
<a name="line840">840: </a>        <font color="#4169E1">for</font> (; d&lt;stag-&gt;entriesPerElement; ++d, ++countAll) {
<a name="line841">841: </a>          idxGlobalAll[countAll] = -1; <font color="#B22222">/* dummy element point */</font>
<a name="line842">842: </a>        }
<a name="line843">843: </a>        ++i;
<a name="line844">844: </a>        <font color="#4169E1">for</font> (; i&lt;nNeighbor[0]+ghostOffsetEnd[0]; ++i) {
<a name="line845">845: </a>          <font color="#4169E1">for</font> (d=0; d&lt;stag-&gt;entriesPerElement; ++d, ++countAll) {
<a name="line846">846: </a>            idxGlobalAll[countAll] = -1;
<a name="line847">847: </a>          }
<a name="line848">848: </a>        }
<a name="line849">849: </a>      }
<a name="line850">850: </a>    }

<a name="line852">852: </a>    <font color="#B22222">/* Loop over rows 3/3 : up */</font>
<a name="line853">853: </a>    <font color="#4169E1">if</font> (!dummyEnd[1]) {
<a name="line854">854: </a>      <font color="#4169E1">for</font> (j=0; j&lt;ghostOffsetEnd[1]; ++j) {

<a name="line856">856: </a>        <font color="#B22222">/* Loop over columns 1/3 : up left */</font>
<a name="line857">857: </a>        <font color="#4169E1">if</font> (!star &amp;&amp; !dummyStart[0]) {
<a name="line858">858: </a>          const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         neighbor     = 6;
<a name="line859">859: </a>          const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         globalOffset = globalOffsets[stag-&gt;neighbors[neighbor]];
<a name="line860">860: </a>          const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> * const nNeighbor    = nNeighbors[neighbor];
<a name="line861">861: </a>          const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         eprNeighbor  = nNeighbor[0] * stag-&gt;entriesPerElement;
<a name="line862">862: </a>          <font color="#4169E1">for</font> (i=nNeighbor[0]-ghostOffsetStart[0]; i&lt;nNeighbor[0]; ++i) {
<a name="line863">863: </a>            <font color="#4169E1">for</font> (d=0; d&lt;stag-&gt;entriesPerElement; ++d, ++countAll) {
<a name="line864">864: </a>              idxGlobalAll[countAll] = globalOffset + j*eprNeighbor + i*stag-&gt;entriesPerElement + d;
<a name="line865">865: </a>            }
<a name="line866">866: </a>          }
<a name="line867">867: </a>        } <font color="#4169E1">else</font> {
<a name="line868">868: </a>          <font color="#B22222">/* Up Left dummies */</font>
<a name="line869">869: </a>          <font color="#4169E1">for</font> (ighost=0; ighost&lt;ghostOffsetStart[0]; ++ighost) {
<a name="line870">870: </a>            <font color="#4169E1">for</font> (d=0; d&lt;stag-&gt;entriesPerElement; ++d, ++countAll) {
<a name="line871">871: </a>              idxGlobalAll[countAll] = -1;
<a name="line872">872: </a>            }
<a name="line873">873: </a>          }
<a name="line874">874: </a>        }

<a name="line876">876: </a>        <font color="#B22222">/* Loop over columns 2/3 : up */</font>
<a name="line877">877: </a>        {
<a name="line878">878: </a>          const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         neighbor     = 7;
<a name="line879">879: </a>          const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         globalOffset = globalOffsets[stag-&gt;neighbors[neighbor]];
<a name="line880">880: </a>          const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> * const nNeighbor    = nNeighbors[neighbor];
<a name="line881">881: </a>          const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         eprNeighbor  = entriesPerElementRow; <font color="#B22222">/* Same as here */</font>
<a name="line882">882: </a>          <font color="#4169E1">for</font> (i=0; i&lt;nNeighbor[0]; ++i) {
<a name="line883">883: </a>            <font color="#4169E1">for</font> (d=0; d&lt;stag-&gt;entriesPerElement; ++d, ++countAll) {
<a name="line884">884: </a>              idxGlobalAll[countAll] = globalOffset + j*eprNeighbor + i*stag-&gt;entriesPerElement + d;
<a name="line885">885: </a>            }
<a name="line886">886: </a>          }
<a name="line887">887: </a>        }

<a name="line889">889: </a>        <font color="#B22222">/* Loop over columns 3/3 : up right */</font>
<a name="line890">890: </a>        <font color="#4169E1">if</font> (!star &amp;&amp; !dummyEnd[0]) {
<a name="line891">891: </a>          const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         neighbor     = 8;
<a name="line892">892: </a>          const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         globalOffset = globalOffsets[stag-&gt;neighbors[neighbor]];
<a name="line893">893: </a>          const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> * const nNeighbor    = nNeighbors[neighbor];
<a name="line894">894: </a>          const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         eprNeighbor  = nNeighbor[0]*stag-&gt;entriesPerElement + (nextToDummyEnd[0] ? entriesPerEdge : 0);
<a name="line895">895: </a>          <font color="#4169E1">for</font> (i=0; i&lt;ghostOffsetEnd[0]; ++i) {
<a name="line896">896: </a>            <font color="#4169E1">for</font> (d=0; d&lt;stag-&gt;entriesPerElement; ++d, ++countAll) {
<a name="line897">897: </a>              idxGlobalAll[countAll] = globalOffset + j*eprNeighbor + i*stag-&gt;entriesPerElement + d;
<a name="line898">898: </a>            }
<a name="line899">899: </a>          }
<a name="line900">900: </a>        } <font color="#4169E1">else</font> <font color="#4169E1">if</font> (dummyEnd[0]) {
<a name="line901">901: </a>          <font color="#B22222">/* -1's for right layer of partial dummies, living on rank above */</font>
<a name="line902">902: </a>          const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         neighbor     = 7;
<a name="line903">903: </a>          const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         globalOffset = globalOffsets[stag-&gt;neighbors[neighbor]];
<a name="line904">904: </a>          const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> * const nNeighbor    = nNeighbors[neighbor];
<a name="line905">905: </a>          const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         eprNeighbor  = entriesPerElementRow; <font color="#B22222">/* Same as here */</font>
<a name="line906">906: </a>          <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> dGlobal;
<a name="line907">907: </a>          i = nNeighbor[0];
<a name="line908">908: </a>          <font color="#4169E1">for</font> (d=0,dGlobal=0; d&lt;stag-&gt;dof[0]; ++d, ++dGlobal, ++countAll) {
<a name="line909">909: </a>            idxGlobalAll[countAll] = globalOffset + j*eprNeighbor + i*stag-&gt;entriesPerElement + dGlobal;
<a name="line910">910: </a>          }
<a name="line911">911: </a>          <font color="#4169E1">for</font> (; d&lt;stag-&gt;dof[0] + stag-&gt;dof[1]; ++d, ++countAll) {
<a name="line912">912: </a>            idxGlobalAll[countAll] = -1; <font color="#B22222">/* dummy down edge point */</font>
<a name="line913">913: </a>          }
<a name="line914">914: </a>          <font color="#4169E1">for</font> (; d&lt;stag-&gt;dof[0] + 2*stag-&gt;dof[1]; ++d, ++dGlobal, ++countAll) {
<a name="line915">915: </a>            idxGlobalAll[countAll] = globalOffset + j*eprNeighbor + i*stag-&gt;entriesPerElement + dGlobal;
<a name="line916">916: </a>          }
<a name="line917">917: </a>          <font color="#4169E1">for</font> (; d&lt;stag-&gt;entriesPerElement; ++d, ++countAll) {
<a name="line918">918: </a>            idxGlobalAll[countAll] = -1; <font color="#B22222">/* dummy element point */</font>
<a name="line919">919: </a>          }
<a name="line920">920: </a>          ++i;
<a name="line921">921: </a>          <font color="#4169E1">for</font> (; i&lt;nNeighbor[0]+ghostOffsetEnd[0]; ++i) {
<a name="line922">922: </a>            <font color="#4169E1">for</font> (d=0; d&lt;stag-&gt;entriesPerElement; ++d, ++countAll) {
<a name="line923">923: </a>              idxGlobalAll[countAll] = -1;
<a name="line924">924: </a>            }
<a name="line925">925: </a>          }
<a name="line926">926: </a>        } <font color="#4169E1">else</font> {
<a name="line927">927: </a>          <font color="#B22222">/* Up Right dummies */</font>
<a name="line928">928: </a>          <font color="#4169E1">for</font> (ighost=0; ighost&lt;ghostOffsetEnd[0]; ++ighost) {
<a name="line929">929: </a>            <font color="#4169E1">for</font> (d=0; d&lt;stag-&gt;entriesPerElement; ++d, ++countAll) {
<a name="line930">930: </a>              idxGlobalAll[countAll] = -1;
<a name="line931">931: </a>            }
<a name="line932">932: </a>          }
<a name="line933">933: </a>        }
<a name="line934">934: </a>      }
<a name="line935">935: </a>    } <font color="#4169E1">else</font> {
<a name="line936">936: </a>      j = stag-&gt;n[1];
<a name="line937">937: </a>      <font color="#B22222">/* Top layer of partial dummies */</font>

<a name="line939">939: </a>      <font color="#B22222">/* up left partial dummies layer : Loop over columns 1/3 : living on *left* neighbor */</font>
<a name="line940">940: </a>      <font color="#4169E1">if</font> (!dummyStart[0]) {
<a name="line941">941: </a>        const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         neighbor     = 3;
<a name="line942">942: </a>        const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         globalOffset = globalOffsets[stag-&gt;neighbors[neighbor]];
<a name="line943">943: </a>        const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> * const nNeighbor    = nNeighbors[neighbor];
<a name="line944">944: </a>        const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         eprNeighbor  = nNeighbor[0] * stag-&gt;entriesPerElement;
<a name="line945">945: </a>        <font color="#4169E1">for</font> (i=nNeighbor[0]-ghostOffsetStart[0]; i&lt;nNeighbor[0]; ++i) {
<a name="line946">946: </a>          <font color="#4169E1">for</font> (d=0; d&lt;stag-&gt;dof[0] + stag-&gt;dof[1]; ++d, ++countAll) {
<a name="line947">947: </a>            idxGlobalAll[countAll] = globalOffset + j*eprNeighbor + i*entriesPerEdge + d; <font color="#B22222">/* Note entriesPerEdge here */</font>
<a name="line948">948: </a>          }
<a name="line949">949: </a>          <font color="#4169E1">for</font> (; d&lt;stag-&gt;entriesPerElement; ++d, ++countAll) {
<a name="line950">950: </a>            idxGlobalAll[countAll] = -1; <font color="#B22222">/* dummy left edge and element points */</font>
<a name="line951">951: </a>          }
<a name="line952">952: </a>        }
<a name="line953">953: </a>      } <font color="#4169E1">else</font> {
<a name="line954">954: </a>        <font color="#4169E1">for</font> (ighost=0; ighost&lt;ghostOffsetStart[0]; ++ighost) {
<a name="line955">955: </a>          <font color="#4169E1">for</font> (d=0; d&lt;stag-&gt;entriesPerElement; ++d, ++countAll) {
<a name="line956">956: </a>            idxGlobalAll[countAll] = -1;
<a name="line957">957: </a>          }
<a name="line958">958: </a>        }
<a name="line959">959: </a>      }

<a name="line961">961: </a>      <font color="#B22222">/* up partial dummies layer : Loop over columns 2/3 : living on *this* rank */</font>
<a name="line962">962: </a>      {
<a name="line963">963: </a>        const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         neighbor     = 4;
<a name="line964">964: </a>        const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         globalOffset = globalOffsets[stag-&gt;neighbors[neighbor]];
<a name="line965">965: </a>        const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         eprNeighbor  = entriesPerElementRow; <font color="#B22222">/* same as here (obviously) */</font>
<a name="line966">966: </a>        <font color="#4169E1">for</font> (i=0; i&lt;stag-&gt;n[0]; ++i) {
<a name="line967">967: </a>          <font color="#4169E1">for</font> (d=0; d&lt;stag-&gt;dof[0] + stag-&gt;dof[1]; ++d, ++countAll) {
<a name="line968">968: </a>            idxGlobalAll[countAll] = globalOffset + j*eprNeighbor + i*entriesPerEdge + d; <font color="#B22222">/* Note entriesPerEdge here */</font>
<a name="line969">969: </a>          }
<a name="line970">970: </a>          <font color="#4169E1">for</font> (; d&lt;stag-&gt;entriesPerElement; ++d, ++countAll) {
<a name="line971">971: </a>            idxGlobalAll[countAll] = -1; <font color="#B22222">/* dummy left edge and element points */</font>
<a name="line972">972: </a>          }
<a name="line973">973: </a>        }
<a name="line974">974: </a>      }

<a name="line976">976: </a>      <font color="#4169E1">if</font> (!dummyEnd[0]) {
<a name="line977">977: </a>        <font color="#B22222">/* up right partial dummies layer : Loop over columns 3/3 :  living on *right* neighbor */</font>
<a name="line978">978: </a>        const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         neighbor     = 5;
<a name="line979">979: </a>        const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         globalOffset = globalOffsets[stag-&gt;neighbors[neighbor]];
<a name="line980">980: </a>        const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> * const nNeighbor    = nNeighbors[neighbor];
<a name="line981">981: </a>        const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         eprNeighbor  = nNeighbor[0]*stag-&gt;entriesPerElement + (nextToDummyEnd[0] ? entriesPerEdge : 0);
<a name="line982">982: </a>        <font color="#4169E1">for</font> (i = 0; i&lt;ghostOffsetEnd[0]; ++i) {
<a name="line983">983: </a>          <font color="#4169E1">for</font> (d=0; d&lt;stag-&gt;dof[0] + stag-&gt;dof[1]; ++d, ++countAll) {
<a name="line984">984: </a>            idxGlobalAll[countAll] = globalOffset + j*eprNeighbor + i*entriesPerEdge + d; <font color="#B22222">/* Note entriesPerEdge here */</font>
<a name="line985">985: </a>          }
<a name="line986">986: </a>          <font color="#4169E1">for</font> (; d&lt;stag-&gt;entriesPerElement; ++d, ++countAll) {
<a name="line987">987: </a>            idxGlobalAll[countAll] = -1; <font color="#B22222">/* dummy left edge and element points */</font>
<a name="line988">988: </a>          }
<a name="line989">989: </a>        }
<a name="line990">990: </a>      } <font color="#4169E1">else</font> {
<a name="line991">991: </a>        <font color="#B22222">/* Top partial dummies layer : Loop over columns 3/3 : right, living *here* */</font>
<a name="line992">992: </a>        const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         neighbor     = 4;
<a name="line993">993: </a>        const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         globalOffset = globalOffsets[stag-&gt;neighbors[neighbor]];
<a name="line994">994: </a>        const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         eprNeighbor  = entriesPerElementRow; <font color="#B22222">/* same as here (obviously) */</font>
<a name="line995">995: </a>        i = stag-&gt;n[0];
<a name="line996">996: </a>        <font color="#4169E1">for</font> (d=0; d&lt;stag-&gt;dof[0]; ++d, ++countAll) { <font color="#B22222">/* Note just the vertex here */</font>
<a name="line997">997: </a>          idxGlobalAll[countAll] = globalOffset + j*eprNeighbor + i*entriesPerEdge + d; <font color="#B22222">/* Note entriesPerEdge here */</font>
<a name="line998">998: </a>        }
<a name="line999">999: </a>        <font color="#4169E1">for</font> (; d&lt;stag-&gt;entriesPerElement; ++d, ++countAll) {
<a name="line1000">1000: </a>          idxGlobalAll[countAll] = -1; <font color="#B22222">/* dummy bottom edge, left edge and element points */</font>
<a name="line1001">1001: </a>        }
<a name="line1002">1002: </a>        ++i;
<a name="line1003">1003: </a>        <font color="#4169E1">for</font> (; i&lt;stag-&gt;n[0] + ghostOffsetEnd[0]; ++i) {
<a name="line1004">1004: </a>          <font color="#4169E1">for</font> (d=0; d&lt;stag-&gt;entriesPerElement; ++d, ++countAll) {
<a name="line1005">1005: </a>            idxGlobalAll[countAll] = -1;
<a name="line1006">1006: </a>          }
<a name="line1007">1007: </a>        }
<a name="line1008">1008: </a>      }
<a name="line1009">1009: </a>      ++j;
<a name="line1010">1010: </a>      <font color="#B22222">/* Additional top dummy layers */</font>
<a name="line1011">1011: </a>      <font color="#4169E1">for</font> (; j&lt;stag-&gt;n[1]+ghostOffsetEnd[1]; ++j) {
<a name="line1012">1012: </a>        <font color="#4169E1">for</font> (ighost=0; ighost&lt;stag-&gt;nGhost[0]; ++ighost){
<a name="line1013">1013: </a>          <font color="#4169E1">for</font> (d=0; d&lt;stag-&gt;entriesPerElement; ++d, ++countAll) {
<a name="line1014">1014: </a>            idxGlobalAll[countAll] = -1;
<a name="line1015">1015: </a>          }
<a name="line1016">1016: </a>        }
<a name="line1017">1017: </a>      }
<a name="line1018">1018: </a>    }

<a name="line1020">1020: </a>    <font color="#B22222">/* Create local-to-global map (in local ordering, includes maps to -1 for dummy points) */</font>
<a name="line1021">1021: </a>    <a href="../../../../docs/manualpages/IS/ISLocalToGlobalMappingCreate.html#ISLocalToGlobalMappingCreate">ISLocalToGlobalMappingCreate</a>(comm,1,stag-&gt;entriesGhost,idxGlobalAll,<a href="../../../../docs/manualpages/Sys/PetscCopyMode.html#PetscCopyMode">PETSC_OWN_POINTER</a>,&amp;dm-&gt;ltogmap);
<a name="line1022">1022: </a>    PetscLogObjectParent((<a href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)dm,(<a href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)dm-&gt;ltogmap);
<a name="line1023">1023: </a>  }

<a name="line1025">1025: </a>  <font color="#B22222">/* In special cases, create a dedicated injective local-to-global map */</font>
<a name="line1026">1026: </a>  <font color="#4169E1">if</font> ((stag-&gt;boundaryType[0] == <a href="../../../../docs/manualpages/DM/DMBoundaryType.html#DMBoundaryType">DM_BOUNDARY_PERIODIC</a> &amp;&amp; stag-&gt;nRanks[0] == 1) ||
<a name="line1027">1027: </a>      (stag-&gt;boundaryType[1] == <a href="../../../../docs/manualpages/DM/DMBoundaryType.html#DMBoundaryType">DM_BOUNDARY_PERIODIC</a> &amp;&amp; stag-&gt;nRanks[1] == 1)) {
<a name="line1028">1028: </a>    <a href="../../../../docs/manualpages/DMSTAG/DMStagPopulateLocalToGlobalInjective.html#DMStagPopulateLocalToGlobalInjective">DMStagPopulateLocalToGlobalInjective</a>(dm);
<a name="line1029">1029: </a>  }

<a name="line1031">1031: </a>  <font color="#B22222">/* Free global offsets */</font>
<a name="line1032">1032: </a>  <a href="../../../../docs/manualpages/Sys/PetscFree.html#PetscFree">PetscFree</a>(globalOffsets);

<a name="line1034">1034: </a>  <font color="#B22222">/* Precompute location offsets */</font>
<a name="line1035">1035: </a>  DMStagComputeLocationOffsets_2d(dm);

<a name="line1037">1037: </a>  <font color="#B22222">/* View from Options */</font>
<a name="line1038">1038: </a>  DMViewFromOptions(dm,NULL,<font color="#666666">"-dm_view"</font>);

<a name="line1040">1040: </a>  <font color="#4169E1">return</font>(0);
<a name="line1041">1041: </a>}

<a name="line1043">1043: </a><font color="#B22222">/* adapted from da2.c */</font>
<a name="line1044">1044: </a><strong><font color="#4169E1"><a name="DMStagSetUpBuildRankGrid_2d"></a>static <a href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> DMStagSetUpBuildRankGrid_2d(<a href="../../../../docs/manualpages/DM/DM.html#DM">DM</a> dm)</font></strong>
<a name="line1045">1045: </a>{
<a name="line1046">1046: </a>  <a href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a>  ierr;
<a name="line1047">1047: </a>  DM_Stag * const stag = (DM_Stag*)dm-&gt;data;
<a name="line1048">1048: </a>  <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>        m,n;
<a name="line1049">1049: </a>  <a href="../../../../docs/manualpages/Sys/PetscMPIInt.html#PetscMPIInt">PetscMPIInt</a>     rank,size;
<a name="line1050">1050: </a>  const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>  M = stag-&gt;N[0];
<a name="line1051">1051: </a>  const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>  N = stag-&gt;N[1];

<a name="line1054">1054: </a>  <a href="http://www.mpich.org/static/docs/latest/www3/MPI_Comm_size.html#MPI_Comm_size">MPI_Comm_size</a>(<a href="../../../../docs/manualpages/Sys/PetscObjectComm.html#PetscObjectComm">PetscObjectComm</a>((<a href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)dm),&amp;size);
<a name="line1055">1055: </a>  <a href="http://www.mpich.org/static/docs/latest/www3/MPI_Comm_rank.html#MPI_Comm_rank">MPI_Comm_rank</a>(<a href="../../../../docs/manualpages/Sys/PetscObjectComm.html#PetscObjectComm">PetscObjectComm</a>((<a href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)dm),&amp;rank);
<a name="line1056">1056: </a>  m = stag-&gt;nRanks[0];
<a name="line1057">1057: </a>  n = stag-&gt;nRanks[1];
<a name="line1058">1058: </a>  <font color="#4169E1">if</font> (m != <a href="../../../../docs/manualpages/Sys/PETSC_DECIDE.html#PETSC_DECIDE">PETSC_DECIDE</a>) {
<a name="line1059">1059: </a>    <font color="#4169E1">if</font> (m &lt; 1) <a href="../../../../docs/manualpages/Sys/SETERRQ1.html#SETERRQ1">SETERRQ1</a>(<a href="../../../../docs/manualpages/Sys/PetscObjectComm.html#PetscObjectComm">PetscObjectComm</a>((<a href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)dm),PETSC_ERR_ARG_OUTOFRANGE,<font color="#666666">"Non-positive number of ranks in X direction: %D"</font>,m);
<a name="line1060">1060: </a>    <font color="#4169E1">else</font> <font color="#4169E1">if</font> (m &gt; size) <a href="../../../../docs/manualpages/Sys/SETERRQ2.html#SETERRQ2">SETERRQ2</a>(<a href="../../../../docs/manualpages/Sys/PetscObjectComm.html#PetscObjectComm">PetscObjectComm</a>((<a href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)dm),PETSC_ERR_ARG_OUTOFRANGE,<font color="#666666">"Too many ranks in X direction: %D %d"</font>,m,size);
<a name="line1061">1061: </a>  }
<a name="line1062">1062: </a>  <font color="#4169E1">if</font> (n != <a href="../../../../docs/manualpages/Sys/PETSC_DECIDE.html#PETSC_DECIDE">PETSC_DECIDE</a>) {
<a name="line1063">1063: </a>    <font color="#4169E1">if</font> (n &lt; 1) <a href="../../../../docs/manualpages/Sys/SETERRQ1.html#SETERRQ1">SETERRQ1</a>(<a href="../../../../docs/manualpages/Sys/PetscObjectComm.html#PetscObjectComm">PetscObjectComm</a>((<a href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)dm),PETSC_ERR_ARG_OUTOFRANGE,<font color="#666666">"Non-positive number of ranks in Y direction: %D"</font>,n);
<a name="line1064">1064: </a>    <font color="#4169E1">else</font> <font color="#4169E1">if</font> (n &gt; size) <a href="../../../../docs/manualpages/Sys/SETERRQ2.html#SETERRQ2">SETERRQ2</a>(<a href="../../../../docs/manualpages/Sys/PetscObjectComm.html#PetscObjectComm">PetscObjectComm</a>((<a href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)dm),PETSC_ERR_ARG_OUTOFRANGE,<font color="#666666">"Too many ranks in Y direction: %D %d"</font>,n,size);
<a name="line1065">1065: </a>  }
<a name="line1066">1066: </a>  <font color="#4169E1">if</font> (m == <a href="../../../../docs/manualpages/Sys/PETSC_DECIDE.html#PETSC_DECIDE">PETSC_DECIDE</a> || n == <a href="../../../../docs/manualpages/Sys/PETSC_DECIDE.html#PETSC_DECIDE">PETSC_DECIDE</a>) {
<a name="line1067">1067: </a>    <font color="#4169E1">if</font> (n != <a href="../../../../docs/manualpages/Sys/PETSC_DECIDE.html#PETSC_DECIDE">PETSC_DECIDE</a>) {
<a name="line1068">1068: </a>      m = size/n;
<a name="line1069">1069: </a>    } <font color="#4169E1">else</font> <font color="#4169E1">if</font> (m != <a href="../../../../docs/manualpages/Sys/PETSC_DECIDE.html#PETSC_DECIDE">PETSC_DECIDE</a>) {
<a name="line1070">1070: </a>      n = size/m;
<a name="line1071">1071: </a>    } <font color="#4169E1">else</font> {
<a name="line1072">1072: </a>      <font color="#B22222">/* try for squarish distribution */</font>
<a name="line1073">1073: </a>      m = (<a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>)(0.5 + PetscSqrtReal(((<a href="../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a>)M)*((<a href="../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a>)size)/((<a href="../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a>)N)));
<a name="line1074">1074: </a>      <font color="#4169E1">if</font> (!m) m = 1;
<a name="line1075">1075: </a>      <font color="#4169E1">while</font> (m &gt; 0) {
<a name="line1076">1076: </a>        n = size/m;
<a name="line1077">1077: </a>        <font color="#4169E1">if</font> (m*n == size) <font color="#4169E1">break</font>;
<a name="line1078">1078: </a>        m--;
<a name="line1079">1079: </a>      }
<a name="line1080">1080: </a>      <font color="#4169E1">if</font> (M &gt; N &amp;&amp; m &lt; n) {<a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> _m = m; m = n; n = _m;}
<a name="line1081">1081: </a>    }
<a name="line1082">1082: </a>    <font color="#4169E1">if</font> (m*n != size) <a href="../../../../docs/manualpages/Sys/SETERRQ.html#SETERRQ">SETERRQ</a>(<a href="../../../../docs/manualpages/Sys/PetscObjectComm.html#PetscObjectComm">PetscObjectComm</a>((<a href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)dm),PETSC_ERR_PLIB,<font color="#666666">"Unable to create partition, check the size of the communicator and input m and n "</font>);
<a name="line1083">1083: </a>  } <font color="#4169E1">else</font> <font color="#4169E1">if</font> (m*n != size) <a href="../../../../docs/manualpages/Sys/SETERRQ2.html#SETERRQ2">SETERRQ2</a>(<a href="../../../../docs/manualpages/Sys/PetscObjectComm.html#PetscObjectComm">PetscObjectComm</a>((<a href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)dm),PETSC_ERR_ARG_OUTOFRANGE,<font color="#666666">"Given Bad partition. Product of sizes (%D) does not equal communicator size (%d)"</font>,m*n,size);
<a name="line1084">1084: </a>  <font color="#4169E1">if</font> (M &lt; m) <a href="../../../../docs/manualpages/Sys/SETERRQ2.html#SETERRQ2">SETERRQ2</a>(<a href="../../../../docs/manualpages/Sys/PetscObjectComm.html#PetscObjectComm">PetscObjectComm</a>((<a href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)dm),PETSC_ERR_ARG_OUTOFRANGE,<font color="#666666">"Partition in x direction is too fine! %D %D"</font>,M,m);
<a name="line1085">1085: </a>  <font color="#4169E1">if</font> (N &lt; n) <a href="../../../../docs/manualpages/Sys/SETERRQ2.html#SETERRQ2">SETERRQ2</a>(<a href="../../../../docs/manualpages/Sys/PetscObjectComm.html#PetscObjectComm">PetscObjectComm</a>((<a href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)dm),PETSC_ERR_ARG_OUTOFRANGE,<font color="#666666">"Partition in y direction is too fine! %D %D"</font>,N,n);
<a name="line1086">1086: </a>  stag-&gt;nRanks[0] = m;
<a name="line1087">1087: </a>  stag-&gt;nRanks[1] = n;
<a name="line1088">1088: </a>  <font color="#4169E1">return</font>(0);
<a name="line1089">1089: </a>}

<a name="line1091">1091: </a><strong><font color="#4169E1"><a name="DMStagSetUpBuildNeighbors_2d"></a>static <a href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> DMStagSetUpBuildNeighbors_2d(<a href="../../../../docs/manualpages/DM/DM.html#DM">DM</a> dm)</font></strong>
<a name="line1092">1092: </a>{
<a name="line1093">1093: </a>  <a href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a>  ierr;
<a name="line1094">1094: </a>  DM_Stag * const stag = (DM_Stag*)dm-&gt;data;
<a name="line1095">1095: </a>  <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>        d,i;
<a name="line1096">1096: </a>  <a href="../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</a>       per[2],first[2],last[2];
<a name="line1097">1097: </a>  <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>        neighborRank[9][2],r[2],n[2];
<a name="line1098">1098: </a>  const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>  dim = 2;

<a name="line1101">1101: </a>  <font color="#4169E1">for</font> (d=0; d&lt;dim; ++d) <font color="#4169E1">if</font> (stag-&gt;boundaryType[d] != <a href="../../../../docs/manualpages/DM/DMBoundaryType.html#DMBoundaryType">DM_BOUNDARY_NONE</a> &amp;&amp; stag-&gt;boundaryType[d] != <a href="../../../../docs/manualpages/DM/DMBoundaryType.html#DMBoundaryType">DM_BOUNDARY_PERIODIC</a> &amp;&amp; stag-&gt;boundaryType[d] != <a href="../../../../docs/manualpages/DM/DMBoundaryType.html#DMBoundaryType">DM_BOUNDARY_GHOSTED</a>) <a href="../../../../docs/manualpages/Sys/SETERRQ1.html#SETERRQ1">SETERRQ1</a>(<a href="../../../../docs/manualpages/Sys/PETSC_COMM_WORLD.html#PETSC_COMM_WORLD">PETSC_COMM_WORLD</a>,PETSC_ERR_SUP,<font color="#666666">"Neighbor determination not implemented for %s"</font>,DMBoundaryTypes[stag-&gt;boundaryType[d]]);

<a name="line1103">1103: </a>  <font color="#B22222">/* Assemble some convenience variables */</font>
<a name="line1104">1104: </a>  <font color="#4169E1">for</font> (d=0; d&lt;dim; ++d) {
<a name="line1105">1105: </a>    per[d]   = (<a href="../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</a>)(stag-&gt;boundaryType[d] == <a href="../../../../docs/manualpages/DM/DMBoundaryType.html#DMBoundaryType">DM_BOUNDARY_PERIODIC</a>);
<a name="line1106">1106: </a>    first[d] = stag-&gt;firstRank[d];
<a name="line1107">1107: </a>    last[d]  = stag-&gt;lastRank[d];
<a name="line1108">1108: </a>    r[d]     = stag-&gt;rank[d];
<a name="line1109">1109: </a>    n[d]     = stag-&gt;nRanks[d];
<a name="line1110">1110: </a>  }

<a name="line1112">1112: </a>  <font color="#B22222">/* First, compute the position in the rank grid for all neighbors */</font>
<a name="line1113">1113: </a>  neighborRank[0][0]  = first[0] ? (per[0] ?  n[0]-1 : -1) : r[0] - 1; <font color="#B22222">/* left  down */</font>
<a name="line1114">1114: </a>  neighborRank[0][1]  = first[1] ? (per[1] ?  n[1]-1 : -1) : r[1] - 1;

<a name="line1116">1116: </a>  neighborRank[1][0] =                                      r[0]    ; <font color="#B22222">/*       down */</font>
<a name="line1117">1117: </a>  neighborRank[1][1] = first[1] ? (per[1] ?  n[1]-1 : -1) : r[1] - 1;

<a name="line1119">1119: </a>  neighborRank[2][0] = last[0]  ? (per[0] ?  0      : -1) : r[0] + 1; <font color="#B22222">/* right down */</font>
<a name="line1120">1120: </a>  neighborRank[2][1] = first[1] ? (per[1] ?  n[1]-1 : -1) : r[1] - 1;

<a name="line1122">1122: </a>  neighborRank[3][0] = first[0] ? (per[0] ?  n[0]-1 : -1) : r[0] - 1; <font color="#B22222">/* left       */</font>
<a name="line1123">1123: </a>  neighborRank[3][1] =                                      r[1]    ;

<a name="line1125">1125: </a>  neighborRank[4][0] =                                      r[0]    ; <font color="#B22222">/*            */</font>
<a name="line1126">1126: </a>  neighborRank[4][1] =                                      r[1]    ;

<a name="line1128">1128: </a>  neighborRank[5][0] = last[0]  ? (per[0] ?  0      : -1) : r[0] + 1; <font color="#B22222">/* right      */</font>
<a name="line1129">1129: </a>  neighborRank[5][1] =                                      r[1]    ;

<a name="line1131">1131: </a>  neighborRank[6][0] = first[0] ? (per[0] ?  n[0]-1 : -1) : r[0] - 1; <font color="#B22222">/* left  up   */</font>
<a name="line1132">1132: </a>  neighborRank[6][1] = last[1]  ? (per[1] ?  0      : -1) : r[1] + 1;

<a name="line1134">1134: </a>  neighborRank[7][0] =                                      r[0]    ; <font color="#B22222">/*       up   */</font>
<a name="line1135">1135: </a>  neighborRank[7][1] = last[1]  ? (per[1] ?  0      : -1) : r[1] + 1;

<a name="line1137">1137: </a>  neighborRank[8][0] = last[0]  ? (per[0] ?  0      : -1) : r[0] + 1; <font color="#B22222">/* right up   */</font>
<a name="line1138">1138: </a>  neighborRank[8][1] = last[1]  ? (per[1] ?  0      : -1) : r[1] + 1;

<a name="line1140">1140: </a>  <font color="#B22222">/* Then, compute the rank of each in the linear ordering */</font>
<a name="line1141">1141: </a>  <a href="../../../../docs/manualpages/Sys/PetscMalloc1.html#PetscMalloc1">PetscMalloc1</a>(9,&amp;stag-&gt;neighbors);
<a name="line1142">1142: </a>  <font color="#4169E1">for</font> (i=0; i&lt;9; ++i){
<a name="line1143">1143: </a>    <font color="#4169E1">if</font>  (neighborRank[i][0] &gt;= 0 &amp;&amp; neighborRank[i][1] &gt;=0) {
<a name="line1144">1144: </a>      stag-&gt;neighbors[i] = neighborRank[i][0] + n[0]*neighborRank[i][1];
<a name="line1145">1145: </a>    } <font color="#4169E1">else</font> {
<a name="line1146">1146: </a>      stag-&gt;neighbors[i] = -1;
<a name="line1147">1147: </a>    }
<a name="line1148">1148: </a>  }

<a name="line1150">1150: </a>  <font color="#4169E1">return</font>(0);
<a name="line1151">1151: </a>}

<a name="line1153">1153: </a><strong><font color="#4169E1"><a name="DMStagSetUpBuildGlobalOffsets_2d"></a>static <a href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> DMStagSetUpBuildGlobalOffsets_2d(<a href="../../../../docs/manualpages/DM/DM.html#DM">DM</a> dm,<a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> **pGlobalOffsets)</font></strong>
<a name="line1154">1154: </a>{
<a name="line1155">1155: </a>  <a href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a>        ierr;
<a name="line1156">1156: </a>  const DM_Stag * const stag = (DM_Stag*)dm-&gt;data;
<a name="line1157">1157: </a>  <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>              *globalOffsets;
<a name="line1158">1158: </a>  <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>              i,j,d,entriesPerEdge,count;
<a name="line1159">1159: </a>  <a href="../../../../docs/manualpages/Sys/PetscMPIInt.html#PetscMPIInt">PetscMPIInt</a>           size;
<a name="line1160">1160: </a>  <a href="../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</a>             extra[2];

<a name="line1163">1163: </a>  <a href="http://www.mpich.org/static/docs/latest/www3/MPI_Comm_size.html#MPI_Comm_size">MPI_Comm_size</a>(<a href="../../../../docs/manualpages/Sys/PetscObjectComm.html#PetscObjectComm">PetscObjectComm</a>((<a href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)dm),&amp;size);
<a name="line1164">1164: </a>  <font color="#4169E1">for</font> (d=0; d&lt;2; ++d) extra[d] = (<a href="../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</a>)(stag-&gt;boundaryType[d] != <a href="../../../../docs/manualpages/DM/DMBoundaryType.html#DMBoundaryType">DM_BOUNDARY_PERIODIC</a>); <font color="#B22222">/* Extra points in global rep */</font>
<a name="line1165">1165: </a>  entriesPerEdge = stag-&gt;dof[0] + stag-&gt;dof[1];
<a name="line1166">1166: </a>  <a href="../../../../docs/manualpages/Sys/PetscMalloc1.html#PetscMalloc1">PetscMalloc1</a>(size,pGlobalOffsets);
<a name="line1167">1167: </a>  globalOffsets = *pGlobalOffsets;
<a name="line1168">1168: </a>  globalOffsets[0] = 0;
<a name="line1169">1169: </a>  count = 1; <font color="#B22222">/* note the count is offset by 1 here. We add the size of the previous rank */</font>
<a name="line1170">1170: </a>  <font color="#4169E1">for</font> (j=0; j&lt;stag-&gt;nRanks[1]-1; ++j) {
<a name="line1171">1171: </a>    const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> nnj = stag-&gt;l[1][j];
<a name="line1172">1172: </a>    <font color="#4169E1">for</font> (i=0; i&lt;stag-&gt;nRanks[0]-1; ++i) {
<a name="line1173">1173: </a>      const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> nni = stag-&gt;l[0][i];
<a name="line1174">1174: </a>      globalOffsets[count] = globalOffsets[count-1] + nnj*nni*stag-&gt;entriesPerElement; <font color="#B22222">/* No right/top/front boundaries */</font>
<a name="line1175">1175: </a>      ++count;
<a name="line1176">1176: </a>    }
<a name="line1177">1177: </a>    {
<a name="line1178">1178: </a>      <font color="#B22222">/* i = stag-&gt;nRanks[0]-1; */</font>
<a name="line1179">1179: </a>      const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> nni = stag-&gt;l[0][i];
<a name="line1180">1180: </a>      globalOffsets[count] = globalOffsets[count-1] + nnj*nni*stag-&gt;entriesPerElement
<a name="line1181">1181: </a>                             + (extra[0] ? nnj*entriesPerEdge : 0); <font color="#B22222">/* Extra edges on the right */</font>
<a name="line1182">1182: </a>      ++count;
<a name="line1183">1183: </a>    }
<a name="line1184">1184: </a>  }
<a name="line1185">1185: </a>  {
<a name="line1186">1186: </a>    <font color="#B22222">/* j = stag-&gt;nRanks[1]-1; */</font>
<a name="line1187">1187: </a>    const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> nnj = stag-&gt;l[1][j];
<a name="line1188">1188: </a>    <font color="#4169E1">for</font> (i=0; i&lt;stag-&gt;nRanks[0]-1; ++i) {
<a name="line1189">1189: </a>      const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> nni = stag-&gt;l[0][i];
<a name="line1190">1190: </a>      globalOffsets[count] = globalOffsets[count-1] + nni*nnj*stag-&gt;entriesPerElement
<a name="line1191">1191: </a>                             + (extra[1] ? nni*entriesPerEdge : 0); <font color="#B22222">/* Extra edges on the top */</font>
<a name="line1192">1192: </a>      ++count;
<a name="line1193">1193: </a>    }
<a name="line1194">1194: </a>    <font color="#B22222">/* Don't need to compute entries in last element */</font>
<a name="line1195">1195: </a>  }
<a name="line1196">1196: </a>  <font color="#4169E1">return</font>(0);
<a name="line1197">1197: </a>}

<a name="line1199">1199: </a><strong><font color="#4169E1"><a name="DMStagComputeLocationOffsets_2d"></a>static <a href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> DMStagComputeLocationOffsets_2d(<a href="../../../../docs/manualpages/DM/DM.html#DM">DM</a> dm)</font></strong>
<a name="line1200">1200: </a>{
<a name="line1201">1201: </a>  <a href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a>  ierr;
<a name="line1202">1202: </a>  DM_Stag * const stag = (DM_Stag*)dm-&gt;data;
<a name="line1203">1203: </a>  const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>  epe = stag-&gt;entriesPerElement;
<a name="line1204">1204: </a>  const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>  epr = stag-&gt;nGhost[0]*epe;

<a name="line1207">1207: </a>  <a href="../../../../docs/manualpages/Sys/PetscMalloc1.html#PetscMalloc1">PetscMalloc1</a>(DMSTAG_NUMBER_LOCATIONS,&amp;stag-&gt;locationOffsets);
<a name="line1208">1208: </a>  stag-&gt;locationOffsets[<a href="../../../../docs/manualpages/DMSTAG/DMStagStencilLocation.html#DMStagStencilLocation">DMSTAG_DOWN_LEFT</a>]  = 0;
<a name="line1209">1209: </a>  stag-&gt;locationOffsets[<a href="../../../../docs/manualpages/DMSTAG/DMStagStencilLocation.html#DMStagStencilLocation">DMSTAG_DOWN</a>]       = stag-&gt;locationOffsets[<a href="../../../../docs/manualpages/DMSTAG/DMStagStencilLocation.html#DMStagStencilLocation">DMSTAG_DOWN_LEFT</a>]  + stag-&gt;dof[0];
<a name="line1210">1210: </a>  stag-&gt;locationOffsets[<a href="../../../../docs/manualpages/DMSTAG/DMStagStencilLocation.html#DMStagStencilLocation">DMSTAG_DOWN_RIGHT</a>] = stag-&gt;locationOffsets[<a href="../../../../docs/manualpages/DMSTAG/DMStagStencilLocation.html#DMStagStencilLocation">DMSTAG_DOWN_LEFT</a>]  + epe;
<a name="line1211">1211: </a>  stag-&gt;locationOffsets[<a href="../../../../docs/manualpages/DMSTAG/DMStagStencilLocation.html#DMStagStencilLocation">DMSTAG_LEFT</a>]       = stag-&gt;locationOffsets[<a href="../../../../docs/manualpages/DMSTAG/DMStagStencilLocation.html#DMStagStencilLocation">DMSTAG_DOWN</a>]       + stag-&gt;dof[1];
<a name="line1212">1212: </a>  stag-&gt;locationOffsets[<a href="../../../../docs/manualpages/DMSTAG/DMStagStencilLocation.html#DMStagStencilLocation">DMSTAG_ELEMENT</a>]    = stag-&gt;locationOffsets[<a href="../../../../docs/manualpages/DMSTAG/DMStagStencilLocation.html#DMStagStencilLocation">DMSTAG_LEFT</a>]       + stag-&gt;dof[1];
<a name="line1213">1213: </a>  stag-&gt;locationOffsets[<a href="../../../../docs/manualpages/DMSTAG/DMStagStencilLocation.html#DMStagStencilLocation">DMSTAG_RIGHT</a>]      = stag-&gt;locationOffsets[<a href="../../../../docs/manualpages/DMSTAG/DMStagStencilLocation.html#DMStagStencilLocation">DMSTAG_LEFT</a>]       + epe;
<a name="line1214">1214: </a>  stag-&gt;locationOffsets[<a href="../../../../docs/manualpages/DMSTAG/DMStagStencilLocation.html#DMStagStencilLocation">DMSTAG_UP_LEFT</a>]    = stag-&gt;locationOffsets[<a href="../../../../docs/manualpages/DMSTAG/DMStagStencilLocation.html#DMStagStencilLocation">DMSTAG_DOWN_LEFT</a>]  + epr;
<a name="line1215">1215: </a>  stag-&gt;locationOffsets[<a href="../../../../docs/manualpages/DMSTAG/DMStagStencilLocation.html#DMStagStencilLocation">DMSTAG_UP</a>]         = stag-&gt;locationOffsets[<a href="../../../../docs/manualpages/DMSTAG/DMStagStencilLocation.html#DMStagStencilLocation">DMSTAG_DOWN</a>]       + epr;
<a name="line1216">1216: </a>  stag-&gt;locationOffsets[<a href="../../../../docs/manualpages/DMSTAG/DMStagStencilLocation.html#DMStagStencilLocation">DMSTAG_UP_RIGHT</a>]   = stag-&gt;locationOffsets[<a href="../../../../docs/manualpages/DMSTAG/DMStagStencilLocation.html#DMStagStencilLocation">DMSTAG_UP_LEFT</a>]    + epe;
<a name="line1217">1217: </a>  <font color="#4169E1">return</font>(0);
<a name="line1218">1218: </a>}

<a name="line1220">1220: </a><strong><font color="#4169E1"><a name="DMStagPopulateLocalToGlobalInjective_2d"></a>PETSC_INTERN <a href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> DMStagPopulateLocalToGlobalInjective_2d(<a href="../../../../docs/manualpages/DM/DM.html#DM">DM</a> dm)</font></strong>
<a name="line1221">1221: </a>{
<a name="line1222">1222: </a>  <a href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a>  ierr;
<a name="line1223">1223: </a>  DM_Stag * const stag = (DM_Stag*)dm-&gt;data;
<a name="line1224">1224: </a>  <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>        *idxLocal,*idxGlobal,*globalOffsetsRecomputed;
<a name="line1225">1225: </a>  const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>  *globalOffsets;
<a name="line1226">1226: </a>  <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>        i,j,d,count,entriesPerCorner,entriesPerEdge,entriesPerElementRowGhost,entriesPerElementRow,ghostOffsetStart[2];
<a name="line1227">1227: </a>  <a href="../../../../docs/manualpages/IS/IS.html#IS">IS</a>              isLocal,isGlobal;
<a name="line1228">1228: </a>  <a href="../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</a>       dummyEnd[2];

<a name="line1231">1231: </a>  DMStagSetUpBuildGlobalOffsets_2d(dm,&amp;globalOffsetsRecomputed); <font color="#B22222">/* note that we don't actually use all of these. An available optimization is to pass them, when available */</font>
<a name="line1232">1232: </a>  globalOffsets = globalOffsetsRecomputed;
<a name="line1233">1233: </a>  <a href="../../../../docs/manualpages/Sys/PetscMalloc1.html#PetscMalloc1">PetscMalloc1</a>(stag-&gt;entries,&amp;idxLocal);
<a name="line1234">1234: </a>  <a href="../../../../docs/manualpages/Sys/PetscMalloc1.html#PetscMalloc1">PetscMalloc1</a>(stag-&gt;entries,&amp;idxGlobal);
<a name="line1235">1235: </a>  <font color="#4169E1">for</font> (d=0; d&lt;2; ++d) dummyEnd[d]   = (<a href="../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</a>)(stag-&gt;lastRank[d] &amp;&amp; stag-&gt;boundaryType[d] != <a href="../../../../docs/manualpages/DM/DMBoundaryType.html#DMBoundaryType">DM_BOUNDARY_PERIODIC</a>);
<a name="line1236">1236: </a>  entriesPerCorner          = stag-&gt;dof[0];
<a name="line1237">1237: </a>  entriesPerEdge            = stag-&gt;dof[0] + stag-&gt;dof[1];
<a name="line1238">1238: </a>  entriesPerElementRow      = stag-&gt;n[0]     *stag-&gt;entriesPerElement + (dummyEnd[0] ? entriesPerEdge : 0);
<a name="line1239">1239: </a>  entriesPerElementRowGhost = stag-&gt;nGhost[0]*stag-&gt;entriesPerElement;
<a name="line1240">1240: </a>  count = 0;
<a name="line1241">1241: </a>  <font color="#4169E1">for</font> (d=0; d&lt;2; ++d) ghostOffsetStart[d] = stag-&gt;start[d] - stag-&gt;startGhost[d];
<a name="line1242">1242: </a>  {
<a name="line1243">1243: </a>    const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> neighbor     = 4;
<a name="line1244">1244: </a>    const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> globalOffset = globalOffsets[stag-&gt;neighbors[neighbor]];
<a name="line1245">1245: </a>    <font color="#4169E1">for</font> (j=0; j&lt;stag-&gt;n[1]; ++j) {
<a name="line1246">1246: </a>      const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> jghost = j + ghostOffsetStart[1];
<a name="line1247">1247: </a>      <font color="#4169E1">for</font> (i=0; i&lt;stag-&gt;n[0]; ++i) {
<a name="line1248">1248: </a>        const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> ighost = i + ghostOffsetStart[0];
<a name="line1249">1249: </a>        <font color="#4169E1">for</font> (d=0; d&lt;stag-&gt;entriesPerElement; ++d, ++count) {
<a name="line1250">1250: </a>          idxGlobal[count] = globalOffset + j     *entriesPerElementRow       + i     *stag-&gt;entriesPerElement + d;
<a name="line1251">1251: </a>          idxLocal[count]  =                jghost*entriesPerElementRowGhost  + ighost*stag-&gt;entriesPerElement + d;
<a name="line1252">1252: </a>        }
<a name="line1253">1253: </a>      }
<a name="line1254">1254: </a>      <font color="#4169E1">if</font> (dummyEnd[0]) {
<a name="line1255">1255: </a>        const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> ighost = i + ghostOffsetStart[0];
<a name="line1256">1256: </a>        i = stag-&gt;n[0];
<a name="line1257">1257: </a>        <font color="#4169E1">for</font> (d=0; d&lt;stag-&gt;dof[0]; ++d, ++count) { <font color="#B22222">/* vertex first */</font>
<a name="line1258">1258: </a>          idxGlobal[count] = globalOffset + j     *entriesPerElementRow      + i     *stag-&gt;entriesPerElement + d;
<a name="line1259">1259: </a>          idxLocal[count]  =                jghost*entriesPerElementRowGhost + ighost*stag-&gt;entriesPerElement + d;
<a name="line1260">1260: </a>        }
<a name="line1261">1261: </a>        <font color="#4169E1">for</font> (d=0; d&lt;stag-&gt;dof[1]; ++d, ++count) { <font color="#B22222">/* then left ege (skipping bottom edge) */</font>
<a name="line1262">1262: </a>          idxGlobal[count] = globalOffset + j     *entriesPerElementRow       + i     *stag-&gt;entriesPerElement + stag-&gt;dof[0]                + d;
<a name="line1263">1263: </a>          idxLocal[count]  =                jghost*entriesPerElementRowGhost  + ighost*stag-&gt;entriesPerElement + stag-&gt;dof[0] + stag-&gt;dof[1] + d;
<a name="line1264">1264: </a>        }
<a name="line1265">1265: </a>      }
<a name="line1266">1266: </a>    }
<a name="line1267">1267: </a>    <font color="#4169E1">if</font> (dummyEnd[1]) {
<a name="line1268">1268: </a>      const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> jghost = j + ghostOffsetStart[1];
<a name="line1269">1269: </a>      j = stag-&gt;n[1];
<a name="line1270">1270: </a>      <font color="#4169E1">for</font> (i=0; i&lt;stag-&gt;n[0]; ++i) {
<a name="line1271">1271: </a>        const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> ighost = i + ghostOffsetStart[0];
<a name="line1272">1272: </a>        <font color="#4169E1">for</font> (d=0; d&lt;entriesPerEdge; ++d, ++count) { <font color="#B22222">/* vertex and bottom edge (which are the first entries) */</font>
<a name="line1273">1273: </a>          idxGlobal[count] = globalOffset + j     *entriesPerElementRow +      i*entriesPerEdge               + d; <font color="#B22222">/* note i increment by entriesPerEdge */</font>
<a name="line1274">1274: </a>          idxLocal[count]  =                jghost*entriesPerElementRowGhost + ighost*stag-&gt;entriesPerElement + d;
<a name="line1275">1275: </a>        }
<a name="line1276">1276: </a>      }
<a name="line1277">1277: </a>      <font color="#4169E1">if</font> (dummyEnd[0]) {
<a name="line1278">1278: </a>        const <a href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> ighost = i + ghostOffsetStart[0];
<a name="line1279">1279: </a>        i = stag-&gt;n[0];
<a name="line1280">1280: </a>        <font color="#4169E1">for</font> (d=0; d&lt;entriesPerCorner; ++d, ++count) { <font color="#B22222">/* vertex only */</font>
<a name="line1281">1281: </a>          idxGlobal[count] = globalOffset + j     *entriesPerElementRow       + i     *entriesPerEdge          + d; <font color="#B22222">/* note i increment by entriesPerEdge */</font>
<a name="line1282">1282: </a>          idxLocal[count]  =                jghost*entriesPerElementRowGhost  + ighost*stag-&gt;entriesPerElement + d;
<a name="line1283">1283: </a>        }
<a name="line1284">1284: </a>      }
<a name="line1285">1285: </a>    }
<a name="line1286">1286: </a>  }
<a name="line1287">1287: </a>  <a href="../../../../docs/manualpages/IS/ISCreateGeneral.html#ISCreateGeneral">ISCreateGeneral</a>(<a href="../../../../docs/manualpages/Sys/PetscObjectComm.html#PetscObjectComm">PetscObjectComm</a>((<a href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)dm),stag-&gt;entries,idxLocal,<a href="../../../../docs/manualpages/Sys/PetscCopyMode.html#PetscCopyMode">PETSC_OWN_POINTER</a>,&amp;isLocal);
<a name="line1288">1288: </a>  <a href="../../../../docs/manualpages/IS/ISCreateGeneral.html#ISCreateGeneral">ISCreateGeneral</a>(<a href="../../../../docs/manualpages/Sys/PetscObjectComm.html#PetscObjectComm">PetscObjectComm</a>((<a href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)dm),stag-&gt;entries,idxGlobal,<a href="../../../../docs/manualpages/Sys/PetscCopyMode.html#PetscCopyMode">PETSC_OWN_POINTER</a>,&amp;isGlobal);
<a name="line1289">1289: </a>  {
<a name="line1290">1290: </a>    <a href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</a> local,global;
<a name="line1291">1291: </a>    <a href="../../../../docs/manualpages/Vec/VecCreateMPIWithArray.html#VecCreateMPIWithArray">VecCreateMPIWithArray</a>(<a href="../../../../docs/manualpages/Sys/PetscObjectComm.html#PetscObjectComm">PetscObjectComm</a>((<a href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)dm),1,stag-&gt;entries,<a href="../../../../docs/manualpages/Sys/PETSC_DECIDE.html#PETSC_DECIDE">PETSC_DECIDE</a>,NULL,&amp;global);
<a name="line1292">1292: </a>    <a href="../../../../docs/manualpages/Vec/VecCreateSeqWithArray.html#VecCreateSeqWithArray">VecCreateSeqWithArray</a>(<a href="../../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</a>,stag-&gt;entriesPerElement,stag-&gt;entriesGhost,NULL,&amp;local);
<a name="line1293">1293: </a>    <a href="../../../../docs/manualpages/Vec/VecScatterCreate.html#VecScatterCreate">VecScatterCreate</a>(local,isLocal,global,isGlobal,&amp;stag-&gt;ltog_injective);
<a name="line1294">1294: </a>    <a href="../../../../docs/manualpages/Vec/VecDestroy.html#VecDestroy">VecDestroy</a>(&amp;global);
<a name="line1295">1295: </a>    <a href="../../../../docs/manualpages/Vec/VecDestroy.html#VecDestroy">VecDestroy</a>(&amp;local);
<a name="line1296">1296: </a>  }
<a name="line1297">1297: </a>  <a href="../../../../docs/manualpages/IS/ISDestroy.html#ISDestroy">ISDestroy</a>(&amp;isLocal);
<a name="line1298">1298: </a>  <a href="../../../../docs/manualpages/IS/ISDestroy.html#ISDestroy">ISDestroy</a>(&amp;isGlobal);
<a name="line1299">1299: </a>  <font color="#4169E1">if</font> (globalOffsetsRecomputed) {
<a name="line1300">1300: </a>    <a href="../../../../docs/manualpages/Sys/PetscFree.html#PetscFree">PetscFree</a>(globalOffsetsRecomputed);
<a name="line1301">1301: </a>  }
<a name="line1302">1302: </a>  <font color="#4169E1">return</font>(0);
<a name="line1303">1303: </a>}
</pre>
</body>

</html>

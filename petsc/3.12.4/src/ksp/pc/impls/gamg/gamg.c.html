<center><a href="gamg.c">Actual source code: gamg.c</a></center><br>

<html>
<head> <link rel="canonical" href="http://www.mcs.anl.gov/petsc/petsc-current/src/ksp/pc/impls/gamg/gamg.c.html" />
<title></title>
<meta name="generator" content="c2html 0.9.4">
<meta name="date" content="2020-02-04T17:12:45+00:00">
</head>

<body bgcolor="#FFFFFF">
   <div id="version" align=right><b>petsc-3.12.4 2020-02-04</b></div>
   <div id="bugreport" align=right><a href="mailto:petsc-maint@mcs.anl.gov?subject=Typo or Error in Documentation &body=Please describe the typo or error in the documentation: petsc-3.12.4 v3.12.4 src/ksp/pc/impls/gamg/gamg.c.html "><small>Report Typos and Errors</small></a></div>
<pre width="80">
<a name="line1">  1: </a><font color="#B22222">/*</font>
<a name="line2">  2: </a><font color="#B22222"> GAMG geometric-algebric multigrid <a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a> - Mark Adams 2011</font>
<a name="line3">  3: </a><font color="#B22222"> */</font>
<a name="line4">  4: </a> #include <A href="../../../../../include/petsc/private/matimpl.h.html">&lt;petsc/private/matimpl.h&gt;</A>
<a name="line5">  5: </a> #include <A href="../../../../../include/../src/ksp/pc/impls/gamg/gamg.h.html">&lt;../src/ksp/pc/impls/gamg/gamg.h&gt;</A>
<a name="line6">  6: </a><font color="#A020F0">#include &lt;../src/ksp/pc/impls/bjacobi/bjacobi.h&gt; </font><font color="#B22222">/* Hack to access same_local_solves */</font><font color="#A020F0"></font>

<a name="line8">  8: </a><font color="#A020F0">#if defined PETSC_GAMG_USE_LOG</font>
<a name="line9">  9: </a><a href="../../../../../docs/manualpages/Profiling/PetscLogEvent.html#PetscLogEvent">PetscLogEvent</a> petsc_gamg_setup_events[NUM_SET];
<a name="line10"> 10: </a><font color="#A020F0">#endif</font>

<a name="line12"> 12: </a><font color="#A020F0">#if defined PETSC_USE_LOG</font>
<a name="line13"> 13: </a><a href="../../../../../docs/manualpages/Profiling/PetscLogEvent.html#PetscLogEvent">PetscLogEvent</a> PC_GAMGGraph_AGG;
<a name="line14"> 14: </a><a href="../../../../../docs/manualpages/Profiling/PetscLogEvent.html#PetscLogEvent">PetscLogEvent</a> PC_GAMGGraph_GEO;
<a name="line15"> 15: </a><a href="../../../../../docs/manualpages/Profiling/PetscLogEvent.html#PetscLogEvent">PetscLogEvent</a> PC_GAMGCoarsen_AGG;
<a name="line16"> 16: </a><a href="../../../../../docs/manualpages/Profiling/PetscLogEvent.html#PetscLogEvent">PetscLogEvent</a> PC_GAMGCoarsen_GEO;
<a name="line17"> 17: </a><a href="../../../../../docs/manualpages/Profiling/PetscLogEvent.html#PetscLogEvent">PetscLogEvent</a> PC_GAMGProlongator_AGG;
<a name="line18"> 18: </a><a href="../../../../../docs/manualpages/Profiling/PetscLogEvent.html#PetscLogEvent">PetscLogEvent</a> PC_GAMGProlongator_GEO;
<a name="line19"> 19: </a><a href="../../../../../docs/manualpages/Profiling/PetscLogEvent.html#PetscLogEvent">PetscLogEvent</a> PC_GAMGOptProlongator_AGG;
<a name="line20"> 20: </a><font color="#A020F0">#endif</font>

<a name="line22"> 22: </a><font color="#B22222">/* #define GAMG_STAGES */</font>
<a name="line23"> 23: </a><font color="#A020F0">#if (defined PETSC_GAMG_USE_LOG &amp;&amp; defined GAMG_STAGES)</font>
<a name="line24"> 24: </a>static <a href="../../../../../docs/manualpages/Profiling/PetscLogStage.html#PetscLogStage">PetscLogStage</a> gamg_stages[PETSC_GAMG_MAXLEVELS];
<a name="line25"> 25: </a><font color="#A020F0">#endif</font>

<a name="line27"> 27: </a>static <a href="../../../../../docs/manualpages/Sys/PetscFunctionList.html#PetscFunctionList">PetscFunctionList</a> GAMGList = 0;
<a name="line28"> 28: </a>static <a href="../../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</a> PCGAMGPackageInitialized;

<a name="line30"> 30: </a><font color="#B22222">/* ----------------------------------------------------------------------------- */</font>
<a name="line31"> 31: </a><strong><font color="#4169E1"><a name="PCReset_GAMG"></a><a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> PCReset_GAMG(<a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a> pc)</font></strong>
<a name="line32"> 32: </a>{
<a name="line34"> 34: </a>  PC_MG          *mg      = (PC_MG*)pc-&gt;data;
<a name="line35"> 35: </a>  PC_GAMG        *pc_gamg = (PC_GAMG*)mg-&gt;innerctx;

<a name="line38"> 38: </a>  <a href="../../../../../docs/manualpages/Sys/PetscFree.html#PetscFree">PetscFree</a>(pc_gamg-&gt;data);
<a name="line39"> 39: </a>  pc_gamg-&gt;data_sz = 0;
<a name="line40"> 40: </a>  <a href="../../../../../docs/manualpages/Sys/PetscFree.html#PetscFree">PetscFree</a>(pc_gamg-&gt;orig_data);
<a name="line41"> 41: </a>  <font color="#4169E1">return</font>(0);
<a name="line42"> 42: </a>}

<a name="line44"> 44: </a><font color="#B22222">/* -------------------------------------------------------------------------- */</font>
<a name="line45"> 45: </a><font color="#B22222">/*</font>
<a name="line46"> 46: </a><font color="#B22222">   PCGAMGCreateLevel_GAMG: create coarse op with RAP.  repartition and/or reduce number</font>
<a name="line47"> 47: </a><font color="#B22222">     of active processors.</font>

<a name="line49"> 49: </a><font color="#B22222">   Input Parameter:</font>
<a name="line50"> 50: </a><font color="#B22222">   . pc - parameters + side effect: coarse data in 'pc_gamg-&gt;data' and</font>
<a name="line51"> 51: </a><font color="#B22222">          'pc_gamg-&gt;data_sz' are changed via repartitioning/reduction.</font>
<a name="line52"> 52: </a><font color="#B22222">   . Amat_fine - matrix on this fine (k) level</font>
<a name="line53"> 53: </a><font color="#B22222">   . cr_bs - coarse block size</font>
<a name="line54"> 54: </a><font color="#B22222">   In/Output Parameter:</font>
<a name="line55"> 55: </a><font color="#B22222">   . a_P_inout - prolongation operator to the next level (k--&gt;k-1)</font>
<a name="line56"> 56: </a><font color="#B22222">   . a_nactive_proc - number of active procs</font>
<a name="line57"> 57: </a><font color="#B22222">   Output Parameter:</font>
<a name="line58"> 58: </a><font color="#B22222">   . a_Amat_crs - coarse matrix that is created (k-1)</font>
<a name="line59"> 59: </a><font color="#B22222">*/</font>

<a name="line61"> 61: </a><strong><font color="#4169E1"><a name="PCGAMGCreateLevel_GAMG"></a>static <a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> PCGAMGCreateLevel_GAMG(<a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a> pc,<a href="../../../../../docs/manualpages/Mat/Mat.html#Mat">Mat</a> Amat_fine,<a href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> cr_bs,<a href="../../../../../docs/manualpages/Mat/Mat.html#Mat">Mat</a> *a_P_inout,<a href="../../../../../docs/manualpages/Mat/Mat.html#Mat">Mat</a> *a_Amat_crs,<a href="../../../../../docs/manualpages/Sys/PetscMPIInt.html#PetscMPIInt">PetscMPIInt</a> *a_nactive_proc,<a href="../../../../../docs/manualpages/IS/IS.html#IS">IS</a> * Pcolumnperm, <a href="../../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</a> is_last)</font></strong>
<a name="line62"> 62: </a>{
<a name="line63"> 63: </a>  <a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a>  ierr;
<a name="line64"> 64: </a>  PC_MG           *mg         = (PC_MG*)pc-&gt;data;
<a name="line65"> 65: </a>  PC_GAMG         *pc_gamg    = (PC_GAMG*)mg-&gt;innerctx;
<a name="line66"> 66: </a>  <a href="../../../../../docs/manualpages/Mat/Mat.html#Mat">Mat</a>             Cmat,Pold=*a_P_inout;
<a name="line67"> 67: </a>  <a href="../../../../../docs/manualpages/Sys/MPI_Comm.html#MPI_Comm">MPI_Comm</a>        comm;
<a name="line68"> 68: </a>  <a href="../../../../../docs/manualpages/Sys/PetscMPIInt.html#PetscMPIInt">PetscMPIInt</a>     rank,size,new_size,nactive=*a_nactive_proc;
<a name="line69"> 69: </a>  <a href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>        ncrs_eq,ncrs,f_bs;

<a name="line72"> 72: </a>  <a href="../../../../../docs/manualpages/Sys/PetscObjectGetComm.html#PetscObjectGetComm">PetscObjectGetComm</a>((<a href="../../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)Amat_fine,&amp;comm);
<a name="line73"> 73: </a>  <a href="http://www.mpich.org/static/docs/latest/www3/MPI_Comm_rank.html#MPI_Comm_rank">MPI_Comm_rank</a>(comm, &amp;rank);
<a name="line74"> 74: </a>  <a href="http://www.mpich.org/static/docs/latest/www3/MPI_Comm_size.html#MPI_Comm_size">MPI_Comm_size</a>(comm, &amp;size);
<a name="line75"> 75: </a>  <a href="../../../../../docs/manualpages/Mat/MatGetBlockSize.html#MatGetBlockSize">MatGetBlockSize</a>(Amat_fine, &amp;f_bs);
<a name="line76"> 76: </a>  <a href="../../../../../docs/manualpages/Mat/MatPtAP.html#MatPtAP">MatPtAP</a>(Amat_fine, Pold, <a href="../../../../../docs/manualpages/Mat/MatReuse.html#MatReuse">MAT_INITIAL_MATRIX</a>, 2.0, &amp;Cmat);

<a name="line78"> 78: </a>  <font color="#4169E1">if</font> (Pcolumnperm) *Pcolumnperm = NULL;

<a name="line80"> 80: </a>  <font color="#B22222">/* set 'ncrs' (nodes), 'ncrs_eq' (equations)*/</font>
<a name="line81"> 81: </a>  <a href="../../../../../docs/manualpages/Mat/MatGetLocalSize.html#MatGetLocalSize">MatGetLocalSize</a>(Cmat, &amp;ncrs_eq, NULL);
<a name="line82"> 82: </a>  <font color="#4169E1">if</font> (pc_gamg-&gt;data_cell_rows&gt;0) {
<a name="line83"> 83: </a>    ncrs = pc_gamg-&gt;data_sz/pc_gamg-&gt;data_cell_cols/pc_gamg-&gt;data_cell_rows;
<a name="line84"> 84: </a>  } <font color="#4169E1">else</font> {
<a name="line85"> 85: </a>    <a href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>  bs;
<a name="line86"> 86: </a>    <a href="../../../../../docs/manualpages/Mat/MatGetBlockSize.html#MatGetBlockSize">MatGetBlockSize</a>(Cmat, &amp;bs);
<a name="line87"> 87: </a>    ncrs = ncrs_eq/bs;
<a name="line88"> 88: </a>  }
<a name="line89"> 89: </a>  <font color="#B22222">/* get number of PEs to make active 'new_size', reduce, can be any integer 1-P */</font>
<a name="line90"> 90: </a>  <font color="#4169E1">if</font> (is_last &amp;&amp; !pc_gamg-&gt;use_parallel_coarse_grid_solver) new_size = 1;
<a name="line91"> 91: </a>  <font color="#4169E1">else</font> {
<a name="line92"> 92: </a>    <a href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> ncrs_eq_glob;
<a name="line93"> 93: </a>    <a href="../../../../../docs/manualpages/Mat/MatGetSize.html#MatGetSize">MatGetSize</a>(Cmat, &amp;ncrs_eq_glob, NULL);
<a name="line94"> 94: </a>    new_size = (<a href="../../../../../docs/manualpages/Sys/PetscMPIInt.html#PetscMPIInt">PetscMPIInt</a>)((float)ncrs_eq_glob/(float)pc_gamg-&gt;min_eq_proc + 0.5); <font color="#B22222">/* hardwire min. number of eq/proc */</font>
<a name="line95"> 95: </a>    <font color="#4169E1">if</font> (!new_size) new_size = 1; <font color="#B22222">/* not likely, posible? */</font>
<a name="line96"> 96: </a>    <font color="#4169E1">else</font> <font color="#4169E1">if</font> (new_size &gt;= nactive) new_size = nactive; <font color="#B22222">/* no change, rare */</font>
<a name="line97"> 97: </a>  }

<a name="line99"> 99: </a>  <font color="#4169E1">if</font> (new_size==nactive) {
<a name="line100">100: </a>    *a_Amat_crs = Cmat; <font color="#B22222">/* output - no repartitioning or reduction - could bail here */</font>
<a name="line101">101: </a>    <font color="#4169E1">if</font> (new_size &lt; size) {
<a name="line102">102: </a>      <font color="#B22222">/* odd case where multiple coarse grids are on one processor or no coarsening ... */</font>
<a name="line103">103: </a>      PetscInfo1(pc,<font color="#666666">"reduced grid using same number of processors (%d) as last grid (use larger coarse grid)\n"</font>,nactive);
<a name="line104">104: </a>      <font color="#4169E1">if</font> (pc_gamg-&gt;cpu_pin_coarse_grids) {
<a name="line105">105: </a>        <a href="../../../../../docs/manualpages/Mat/MatPinToCPU.html#MatPinToCPU">MatPinToCPU</a>(*a_Amat_crs,<a href="../../../../../docs/manualpages/Sys/PETSC_TRUE.html#PETSC_TRUE">PETSC_TRUE</a>);
<a name="line106">106: </a>        <a href="../../../../../docs/manualpages/Mat/MatPinToCPU.html#MatPinToCPU">MatPinToCPU</a>(*a_P_inout,<a href="../../../../../docs/manualpages/Sys/PETSC_TRUE.html#PETSC_TRUE">PETSC_TRUE</a>);
<a name="line107">107: </a>      }
<a name="line108">108: </a>    }
<a name="line109">109: </a>    <font color="#B22222">/* we know that the grid structure can be reused in <a href="../../../../../docs/manualpages/Mat/MatPtAP.html#MatPtAP">MatPtAP</a> */</font>
<a name="line110">110: </a>  } <font color="#4169E1">else</font> { <font color="#B22222">/* reduce active processors - we know that the grid structure can NOT be reused in <a href="../../../../../docs/manualpages/Mat/MatPtAP.html#MatPtAP">MatPtAP</a> */</font>
<a name="line111">111: </a>    <a href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>       *counts,*newproc_idx,ii,jj,kk,strideNew,*tidx,ncrs_new,ncrs_eq_new,nloc_old,expand_factor=1,rfactor=1;
<a name="line112">112: </a>    <a href="../../../../../docs/manualpages/IS/IS.html#IS">IS</a>             is_eq_newproc,is_eq_num,is_eq_num_prim,new_eq_indices;
<a name="line113">113: </a>    nloc_old = ncrs_eq/cr_bs;
<a name="line114">114: </a>    <font color="#4169E1">if</font> (ncrs_eq % cr_bs) <a href="../../../../../docs/manualpages/Sys/SETERRQ2.html#SETERRQ2">SETERRQ2</a>(<a href="../../../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</a>,PETSC_ERR_PLIB,<font color="#666666">"ncrs_eq %D not divisible by cr_bs %D"</font>,ncrs_eq,cr_bs);
<a name="line115">115: </a><font color="#A020F0">#if defined PETSC_GAMG_USE_LOG</font>
<a name="line116">116: </a>    <a href="../../../../../docs/manualpages/Profiling/PetscLogEventBegin.html#PetscLogEventBegin">PetscLogEventBegin</a>(petsc_gamg_setup_events[SET12],0,0,0,0);
<a name="line117">117: </a><font color="#A020F0">#endif</font>
<a name="line118">118: </a>    <font color="#B22222">/* get new_size and rfactor */</font>
<a name="line119">119: </a>    <font color="#4169E1">if</font> (pc_gamg-&gt;layout_type==<a href="../../../../../docs/manualpages/PC/PCGAMGLayoutType.html#PCGAMGLayoutType">PCGAMG_LAYOUT_SPREAD</a> || !pc_gamg-&gt;repart) {
<a name="line120">120: </a>      <font color="#B22222">/* find factor */</font>
<a name="line121">121: </a>      <font color="#4169E1">if</font> (new_size == 1) rfactor = size; <font color="#B22222">/* don't modify */</font>
<a name="line122">122: </a>      <font color="#4169E1">else</font> {
<a name="line123">123: </a>        <a href="../../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> best_fact = 0.;
<a name="line124">124: </a>        jj = -1;
<a name="line125">125: </a>        <font color="#4169E1">for</font> (kk = 1 ; kk &lt;= size ; kk++) {
<a name="line126">126: </a>          <font color="#4169E1">if</font> (!(size%kk)) { <font color="#B22222">/* a candidate */</font>
<a name="line127">127: </a>            <a href="../../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> nactpe = (<a href="../../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a>)size/(<a href="../../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a>)kk, fact = nactpe/(<a href="../../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a>)new_size;
<a name="line128">128: </a>            <font color="#4169E1">if</font> (fact &gt; 1.0) fact = 1./fact; <font color="#B22222">/* keep fact &lt; 1 */</font>
<a name="line129">129: </a>            <font color="#4169E1">if</font> (fact &gt; best_fact) {
<a name="line130">130: </a>              best_fact = fact; jj = kk;
<a name="line131">131: </a>            }
<a name="line132">132: </a>          }
<a name="line133">133: </a>        }
<a name="line134">134: </a>        <font color="#4169E1">if</font> (jj != -1) rfactor = jj;
<a name="line135">135: </a>        <font color="#4169E1">else</font> rfactor = 1; <font color="#B22222">/* a prime */</font>
<a name="line136">136: </a>        <font color="#4169E1">if</font> (pc_gamg-&gt;layout_type == <a href="../../../../../docs/manualpages/PC/PCGAMGLayoutType.html#PCGAMGLayoutType">PCGAMG_LAYOUT_COMPACT</a>) expand_factor = 1;
<a name="line137">137: </a>        <font color="#4169E1">else</font> expand_factor = rfactor;
<a name="line138">138: </a>      }
<a name="line139">139: </a>      new_size = size/rfactor; <font color="#B22222">/* make new size one that is factor */</font>
<a name="line140">140: </a>      <font color="#4169E1">if</font> (new_size==nactive) {
<a name="line141">141: </a>        *a_Amat_crs = Cmat; <font color="#B22222">/* output - no repartitioning or reduction, bail out because nested here */</font>
<a name="line142">142: </a>        PetscInfo2(pc,<font color="#666666">"Finding factorable processor set stopped reduction: new_size=%d, neq(loc)=%D\n"</font>,new_size,ncrs_eq);
<a name="line143">143: </a><font color="#A020F0">#if defined PETSC_GAMG_USE_LOG</font>
<a name="line144">144: </a>        <a href="../../../../../docs/manualpages/Profiling/PetscLogEventEnd.html#PetscLogEventEnd">PetscLogEventEnd</a>(petsc_gamg_setup_events[SET12],0,0,0,0);
<a name="line145">145: </a><font color="#A020F0">#endif</font>
<a name="line146">146: </a>        <font color="#4169E1">return</font>(0);
<a name="line147">147: </a>      }
<a name="line148">148: </a>    }
<a name="line149">149: </a>    <font color="#B22222">/* make 'is_eq_newproc' */</font>
<a name="line150">150: </a>    <a href="../../../../../docs/manualpages/Sys/PetscMalloc1.html#PetscMalloc1">PetscMalloc1</a>(size, &amp;counts);
<a name="line151">151: </a>    <font color="#4169E1">if</font> (pc_gamg-&gt;repart) {
<a name="line152">152: </a>      <font color="#B22222">/* Repartition Cmat_{k} and move colums of P^{k}_{k-1} and coordinates of primal part accordingly */</font>
<a name="line153">153: </a>      <a href="../../../../../docs/manualpages/Mat/Mat.html#Mat">Mat</a>      adj;
<a name="line154">154: </a>      PetscInfo4(pc,<font color="#666666">"Repartition: size (active): %d --&gt; %d, %D local equations, using %s process layout\n"</font>,*a_nactive_proc, new_size, ncrs_eq, (pc_gamg-&gt;layout_type==<a href="../../../../../docs/manualpages/PC/PCGAMGLayoutType.html#PCGAMGLayoutType">PCGAMG_LAYOUT_COMPACT</a>) ? <font color="#666666">"compact"</font> : <font color="#666666">"spread"</font>);
<a name="line155">155: </a>      <font color="#B22222">/* get 'adj' */</font>
<a name="line156">156: </a>      <font color="#4169E1">if</font> (cr_bs == 1) {
<a name="line157">157: </a>        <a href="../../../../../docs/manualpages/Mat/MatConvert.html#MatConvert">MatConvert</a>(Cmat, <a href="../../../../../docs/manualpages/Mat/MATMPIADJ.html#MATMPIADJ">MATMPIADJ</a>, <a href="../../../../../docs/manualpages/Mat/MatReuse.html#MatReuse">MAT_INITIAL_MATRIX</a>, &amp;adj);
<a name="line158">158: </a>      } <font color="#4169E1">else</font> {
<a name="line159">159: </a>        <font color="#B22222">/* make a scalar matrix to partition (no Stokes here) */</font>
<a name="line160">160: </a>        <a href="../../../../../docs/manualpages/Mat/Mat.html#Mat">Mat</a>               tMat;
<a name="line161">161: </a>        <a href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>          Istart_crs,Iend_crs,ncols,jj,Ii;
<a name="line162">162: </a>        const <a href="../../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> *vals;
<a name="line163">163: </a>        const <a href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>    *idx;
<a name="line164">164: </a>        <a href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>          *d_nnz, *o_nnz, M, N;
<a name="line165">165: </a>        static <a href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>   llev = 0; <font color="#B22222">/* ugly but just used for debugging */</font>
<a name="line166">166: </a>        <a href="../../../../../docs/manualpages/Mat/MatType.html#MatType">MatType</a>           mtype;

<a name="line168">168: </a>        <a href="../../../../../docs/manualpages/Sys/PetscMalloc2.html#PetscMalloc2">PetscMalloc2</a>(ncrs, &amp;d_nnz,ncrs, &amp;o_nnz);
<a name="line169">169: </a>        <a href="../../../../../docs/manualpages/Mat/MatGetOwnershipRange.html#MatGetOwnershipRange">MatGetOwnershipRange</a>(Cmat, &amp;Istart_crs, &amp;Iend_crs);
<a name="line170">170: </a>        <a href="../../../../../docs/manualpages/Mat/MatGetSize.html#MatGetSize">MatGetSize</a>(Cmat, &amp;M, &amp;N);
<a name="line171">171: </a>        <font color="#4169E1">for</font> (Ii = Istart_crs, jj = 0; Ii &lt; Iend_crs; Ii += cr_bs, jj++) {
<a name="line172">172: </a>          <a href="../../../../../docs/manualpages/Mat/MatGetRow.html#MatGetRow">MatGetRow</a>(Cmat,Ii,&amp;ncols,0,0);
<a name="line173">173: </a>          d_nnz[jj] = ncols/cr_bs;
<a name="line174">174: </a>          o_nnz[jj] = ncols/cr_bs;
<a name="line175">175: </a>          <a href="../../../../../docs/manualpages/Mat/MatRestoreRow.html#MatRestoreRow">MatRestoreRow</a>(Cmat,Ii,&amp;ncols,0,0);
<a name="line176">176: </a>          <font color="#4169E1">if</font> (d_nnz[jj] &gt; ncrs) d_nnz[jj] = ncrs;
<a name="line177">177: </a>          <font color="#4169E1">if</font> (o_nnz[jj] &gt; (M/cr_bs-ncrs)) o_nnz[jj] = M/cr_bs-ncrs;
<a name="line178">178: </a>        }

<a name="line180">180: </a>        <a href="../../../../../docs/manualpages/Mat/MatGetType.html#MatGetType">MatGetType</a>(Amat_fine,&amp;mtype);
<a name="line181">181: </a>        <a href="../../../../../docs/manualpages/Mat/MatCreate.html#MatCreate">MatCreate</a>(comm, &amp;tMat);
<a name="line182">182: </a>        <a href="../../../../../docs/manualpages/Mat/MatSetSizes.html#MatSetSizes">MatSetSizes</a>(tMat, ncrs, ncrs,<a href="../../../../../docs/manualpages/Sys/PETSC_DETERMINE.html#PETSC_DETERMINE">PETSC_DETERMINE</a>, <a href="../../../../../docs/manualpages/Sys/PETSC_DETERMINE.html#PETSC_DETERMINE">PETSC_DETERMINE</a>);
<a name="line183">183: </a>        <a href="../../../../../docs/manualpages/Mat/MatSetType.html#MatSetType">MatSetType</a>(tMat,mtype);
<a name="line184">184: </a>        <a href="../../../../../docs/manualpages/Mat/MatSeqAIJSetPreallocation.html#MatSeqAIJSetPreallocation">MatSeqAIJSetPreallocation</a>(tMat,0,d_nnz);
<a name="line185">185: </a>        <a href="../../../../../docs/manualpages/Mat/MatMPIAIJSetPreallocation.html#MatMPIAIJSetPreallocation">MatMPIAIJSetPreallocation</a>(tMat,0,d_nnz,0,o_nnz);
<a name="line186">186: </a>        <a href="../../../../../docs/manualpages/Sys/PetscFree2.html#PetscFree2">PetscFree2</a>(d_nnz,o_nnz);

<a name="line188">188: </a>        <font color="#4169E1">for</font> (ii = Istart_crs; ii &lt; Iend_crs; ii++) {
<a name="line189">189: </a>          <a href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> dest_row = ii/cr_bs;
<a name="line190">190: </a>          <a href="../../../../../docs/manualpages/Mat/MatGetRow.html#MatGetRow">MatGetRow</a>(Cmat,ii,&amp;ncols,&amp;idx,&amp;vals);
<a name="line191">191: </a>          <font color="#4169E1">for</font> (jj = 0; jj &lt; ncols; jj++) {
<a name="line192">192: </a>            <a href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>    dest_col = idx[jj]/cr_bs;
<a name="line193">193: </a>            <a href="../../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> v        = 1.0;
<a name="line194">194: </a>            <a href="../../../../../docs/manualpages/Mat/MatSetValues.html#MatSetValues">MatSetValues</a>(tMat,1,&amp;dest_row,1,&amp;dest_col,&amp;v,<a href="../../../../../docs/manualpages/Sys/ADD_VALUES.html#ADD_VALUES">ADD_VALUES</a>);
<a name="line195">195: </a>          }
<a name="line196">196: </a>          <a href="../../../../../docs/manualpages/Mat/MatRestoreRow.html#MatRestoreRow">MatRestoreRow</a>(Cmat,ii,&amp;ncols,&amp;idx,&amp;vals);
<a name="line197">197: </a>        }
<a name="line198">198: </a>        <a href="../../../../../docs/manualpages/Mat/MatAssemblyBegin.html#MatAssemblyBegin">MatAssemblyBegin</a>(tMat,<a href="../../../../../docs/manualpages/Mat/MatAssemblyType.html#MatAssemblyType">MAT_FINAL_ASSEMBLY</a>);
<a name="line199">199: </a>        <a href="../../../../../docs/manualpages/Mat/MatAssemblyEnd.html#MatAssemblyEnd">MatAssemblyEnd</a>(tMat,<a href="../../../../../docs/manualpages/Mat/MatAssemblyType.html#MatAssemblyType">MAT_FINAL_ASSEMBLY</a>);

<a name="line201">201: </a>        <font color="#4169E1">if</font> (llev++ == -1) {
<a name="line202">202: </a>          <a href="../../../../../docs/manualpages/Viewer/PetscViewer.html#PetscViewer">PetscViewer</a> viewer; char fname[32];
<a name="line203">203: </a>          <a href="../../../../../docs/manualpages/Sys/PetscSNPrintf.html#PetscSNPrintf">PetscSNPrintf</a>(fname,<font color="#4169E1">sizeof</font>(fname),<font color="#666666">"part_mat_%D.mat"</font>,llev);
<a name="line204">204: </a>          <a href="../../../../../docs/manualpages/Viewer/PetscViewerBinaryOpen.html#PetscViewerBinaryOpen">PetscViewerBinaryOpen</a>(comm,fname,<a href="../../../../../docs/manualpages/Sys/PetscFileMode.html#PetscFileMode">FILE_MODE_WRITE</a>,&amp;viewer);
<a name="line205">205: </a>          <a href="../../../../../docs/manualpages/Mat/MatView.html#MatView">MatView</a>(tMat, viewer);
<a name="line206">206: </a>          <a href="../../../../../docs/manualpages/Viewer/PetscViewerDestroy.html#PetscViewerDestroy">PetscViewerDestroy</a>(&amp;viewer);
<a name="line207">207: </a>        }
<a name="line208">208: </a>        <a href="../../../../../docs/manualpages/Mat/MatConvert.html#MatConvert">MatConvert</a>(tMat, <a href="../../../../../docs/manualpages/Mat/MATMPIADJ.html#MATMPIADJ">MATMPIADJ</a>, <a href="../../../../../docs/manualpages/Mat/MatReuse.html#MatReuse">MAT_INITIAL_MATRIX</a>, &amp;adj);
<a name="line209">209: </a>        <a href="../../../../../docs/manualpages/Mat/MatDestroy.html#MatDestroy">MatDestroy</a>(&amp;tMat);
<a name="line210">210: </a>      } <font color="#B22222">/* create 'adj' */</font>

<a name="line212">212: </a>      { <font color="#B22222">/* partition: get newproc_idx */</font>
<a name="line213">213: </a>        char            prefix[256];
<a name="line214">214: </a>        const char      *pcpre;
<a name="line215">215: </a>        const <a href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>  *is_idx;
<a name="line216">216: </a>        <a href="../../../../../docs/manualpages/Mat/MatPartitioning.html#MatPartitioning">MatPartitioning</a> mpart;
<a name="line217">217: </a>        <a href="../../../../../docs/manualpages/IS/IS.html#IS">IS</a>              proc_is;

<a name="line219">219: </a>        <a href="../../../../../docs/manualpages/MatOrderings/MatPartitioningCreate.html#MatPartitioningCreate">MatPartitioningCreate</a>(comm, &amp;mpart);
<a name="line220">220: </a>        <a href="../../../../../docs/manualpages/MatOrderings/MatPartitioningSetAdjacency.html#MatPartitioningSetAdjacency">MatPartitioningSetAdjacency</a>(mpart, adj);
<a name="line221">221: </a>        <a href="../../../../../docs/manualpages/PC/PCGetOptionsPrefix.html#PCGetOptionsPrefix">PCGetOptionsPrefix</a>(pc, &amp;pcpre);
<a name="line222">222: </a>        <a href="../../../../../docs/manualpages/Sys/PetscSNPrintf.html#PetscSNPrintf">PetscSNPrintf</a>(prefix,<font color="#4169E1">sizeof</font>(prefix),<font color="#666666">"%spc_gamg_"</font>,pcpre ? pcpre : <font color="#666666">""</font>);
<a name="line223">223: </a>        <a href="../../../../../docs/manualpages/Sys/PetscObjectSetOptionsPrefix.html#PetscObjectSetOptionsPrefix">PetscObjectSetOptionsPrefix</a>((<a href="../../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)mpart,prefix);
<a name="line224">224: </a>        <a href="../../../../../docs/manualpages/MatOrderings/MatPartitioningSetFromOptions.html#MatPartitioningSetFromOptions">MatPartitioningSetFromOptions</a>(mpart);
<a name="line225">225: </a>        <a href="../../../../../docs/manualpages/MatOrderings/MatPartitioningSetNParts.html#MatPartitioningSetNParts">MatPartitioningSetNParts</a>(mpart, new_size);
<a name="line226">226: </a>        <a href="../../../../../docs/manualpages/MatOrderings/MatPartitioningApply.html#MatPartitioningApply">MatPartitioningApply</a>(mpart, &amp;proc_is);
<a name="line227">227: </a>        <a href="../../../../../docs/manualpages/MatOrderings/MatPartitioningDestroy.html#MatPartitioningDestroy">MatPartitioningDestroy</a>(&amp;mpart);

<a name="line229">229: </a>        <font color="#B22222">/* collect <a href="../../../../../docs/manualpages/IS/IS.html#IS">IS</a> info */</font>
<a name="line230">230: </a>        <a href="../../../../../docs/manualpages/Sys/PetscMalloc1.html#PetscMalloc1">PetscMalloc1</a>(ncrs_eq, &amp;newproc_idx);
<a name="line231">231: </a>        <a href="../../../../../docs/manualpages/IS/ISGetIndices.html#ISGetIndices">ISGetIndices</a>(proc_is, &amp;is_idx);
<a name="line232">232: </a>        <font color="#4169E1">for</font> (kk = jj = 0 ; kk &lt; nloc_old ; kk++) {
<a name="line233">233: </a>          <font color="#4169E1">for</font> (ii = 0 ; ii &lt; cr_bs ; ii++, jj++) {
<a name="line234">234: </a>            newproc_idx[jj] = is_idx[kk] * expand_factor; <font color="#B22222">/* distribution */</font>
<a name="line235">235: </a>          }
<a name="line236">236: </a>        }
<a name="line237">237: </a>        <a href="../../../../../docs/manualpages/IS/ISRestoreIndices.html#ISRestoreIndices">ISRestoreIndices</a>(proc_is, &amp;is_idx);
<a name="line238">238: </a>        <a href="../../../../../docs/manualpages/IS/ISDestroy.html#ISDestroy">ISDestroy</a>(&amp;proc_is);
<a name="line239">239: </a>      }
<a name="line240">240: </a>      <a href="../../../../../docs/manualpages/Mat/MatDestroy.html#MatDestroy">MatDestroy</a>(&amp;adj);

<a name="line242">242: </a>      <a href="../../../../../docs/manualpages/IS/ISCreateGeneral.html#ISCreateGeneral">ISCreateGeneral</a>(comm, ncrs_eq, newproc_idx, <a href="../../../../../docs/manualpages/Sys/PetscCopyMode.html#PetscCopyMode">PETSC_COPY_VALUES</a>, &amp;is_eq_newproc);
<a name="line243">243: </a>      <a href="../../../../../docs/manualpages/Sys/PetscFree.html#PetscFree">PetscFree</a>(newproc_idx);
<a name="line244">244: </a>    } <font color="#4169E1">else</font> { <font color="#B22222">/* simple aggregation of parts -- 'is_eq_newproc' */</font>
<a name="line245">245: </a>      <a href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> targetPE;
<a name="line246">246: </a>      <font color="#4169E1">if</font> (new_size==nactive) {
<a name="line247">247: </a>        *a_Amat_crs = Cmat; <font color="#B22222">/* output - no repartitioning or reduction, bail out because nested here */</font>
<a name="line248">248: </a>        <a href="../../../../../docs/manualpages/Sys/PetscFree.html#PetscFree">PetscFree</a>(counts);
<a name="line249">249: </a>        PetscInfo2(pc,<font color="#666666">"Aggregate processors noop: new_size=%d, neq(loc)=%D\n"</font>,new_size,ncrs_eq);
<a name="line250">250: </a><font color="#A020F0">#if defined PETSC_GAMG_USE_LOG</font>
<a name="line251">251: </a>        <a href="../../../../../docs/manualpages/Profiling/PetscLogEventEnd.html#PetscLogEventEnd">PetscLogEventEnd</a>(petsc_gamg_setup_events[SET12],0,0,0,0);
<a name="line252">252: </a><font color="#A020F0">#endif</font>
<a name="line253">253: </a>        <font color="#4169E1">return</font>(0);
<a name="line254">254: </a>      }
<a name="line255">255: </a>      PetscInfo1(pc,<font color="#666666">"Number of equations (loc) %D with simple aggregation\n"</font>,ncrs_eq);
<a name="line256">256: </a>      targetPE = (rank/rfactor)*expand_factor;
<a name="line257">257: </a>      <a href="../../../../../docs/manualpages/IS/ISCreateStride.html#ISCreateStride">ISCreateStride</a>(comm, ncrs_eq, targetPE, 0, &amp;is_eq_newproc);
<a name="line258">258: </a>    } <font color="#B22222">/* end simple 'is_eq_newproc' */</font>

<a name="line260">260: </a>    <font color="#B22222">/*</font>
<a name="line261">261: </a><font color="#B22222">      Create an index set from the is_eq_newproc index set to indicate the mapping TO</font>
<a name="line262">262: </a><font color="#B22222">    */</font>
<a name="line263">263: </a>    <a href="../../../../../docs/manualpages/IS/ISPartitioningToNumbering.html#ISPartitioningToNumbering">ISPartitioningToNumbering</a>(is_eq_newproc, &amp;is_eq_num);
<a name="line264">264: </a>    is_eq_num_prim = is_eq_num;
<a name="line265">265: </a>    <font color="#B22222">/*</font>
<a name="line266">266: </a><font color="#B22222">      Determine how many equations/vertices are assigned to each processor</font>
<a name="line267">267: </a><font color="#B22222">    */</font>
<a name="line268">268: </a>    <a href="../../../../../docs/manualpages/IS/ISPartitioningCount.html#ISPartitioningCount">ISPartitioningCount</a>(is_eq_newproc, size, counts);
<a name="line269">269: </a>    ncrs_eq_new = counts[rank];
<a name="line270">270: </a>    <a href="../../../../../docs/manualpages/IS/ISDestroy.html#ISDestroy">ISDestroy</a>(&amp;is_eq_newproc);
<a name="line271">271: </a>    ncrs_new = ncrs_eq_new/cr_bs;

<a name="line273">273: </a>    <a href="../../../../../docs/manualpages/Sys/PetscFree.html#PetscFree">PetscFree</a>(counts);
<a name="line274">274: </a><font color="#A020F0">#if defined PETSC_GAMG_USE_LOG</font>
<a name="line275">275: </a>    <a href="../../../../../docs/manualpages/Profiling/PetscLogEventEnd.html#PetscLogEventEnd">PetscLogEventEnd</a>(petsc_gamg_setup_events[SET12],0,0,0,0);
<a name="line276">276: </a><font color="#A020F0">#endif</font>
<a name="line277">277: </a>    <font color="#B22222">/* data movement scope -- this could be moved to subclasses so that we don't try to cram all auxilary data into some complex abstracted thing */</font>
<a name="line278">278: </a>    {
<a name="line279">279: </a>      <a href="../../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</a>            src_crd, dest_crd;
<a name="line280">280: </a>      const <a href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> *idx,ndata_rows=pc_gamg-&gt;data_cell_rows,ndata_cols=pc_gamg-&gt;data_cell_cols,node_data_sz=ndata_rows*ndata_cols;
<a name="line281">281: </a>      <a href="../../../../../docs/manualpages/Vec/VecScatter.html#VecScatter">VecScatter</a>     vecscat;
<a name="line282">282: </a>      <a href="../../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a>    *array;
<a name="line283">283: </a>      <a href="../../../../../docs/manualpages/IS/IS.html#IS">IS</a> isscat;
<a name="line284">284: </a>      <font color="#B22222">/* move data (for primal equations only) */</font>
<a name="line285">285: </a>      <font color="#B22222">/* Create a vector to contain the newly ordered element information */</font>
<a name="line286">286: </a>      <a href="../../../../../docs/manualpages/Vec/VecCreate.html#VecCreate">VecCreate</a>(comm, &amp;dest_crd);
<a name="line287">287: </a>      <a href="../../../../../docs/manualpages/Vec/VecSetSizes.html#VecSetSizes">VecSetSizes</a>(dest_crd, node_data_sz*ncrs_new, <a href="../../../../../docs/manualpages/Sys/PETSC_DECIDE.html#PETSC_DECIDE">PETSC_DECIDE</a>);
<a name="line288">288: </a>      <a href="../../../../../docs/manualpages/Vec/VecSetType.html#VecSetType">VecSetType</a>(dest_crd,<a href="../../../../../docs/manualpages/Vec/VECSTANDARD.html#VECSTANDARD">VECSTANDARD</a>); <font color="#B22222">/* this is needed! */</font>
<a name="line289">289: </a>      <font color="#B22222">/*</font>
<a name="line290">290: </a><font color="#B22222">        There are 'ndata_rows*ndata_cols' data items per node, (one can think of the vectors of having</font>
<a name="line291">291: </a><font color="#B22222">        a block size of ...).  Note, ISs are expanded into equation space by 'cr_bs'.</font>
<a name="line292">292: </a><font color="#B22222">      */</font>
<a name="line293">293: </a>      <a href="../../../../../docs/manualpages/Sys/PetscMalloc1.html#PetscMalloc1">PetscMalloc1</a>(ncrs*node_data_sz, &amp;tidx);
<a name="line294">294: </a>      <a href="../../../../../docs/manualpages/IS/ISGetIndices.html#ISGetIndices">ISGetIndices</a>(is_eq_num_prim, &amp;idx);
<a name="line295">295: </a>      <font color="#4169E1">for</font> (ii=0,jj=0; ii&lt;ncrs; ii++) {
<a name="line296">296: </a>        <a href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> id = idx[ii*cr_bs]/cr_bs; <font color="#B22222">/* get node back */</font>
<a name="line297">297: </a>        <font color="#4169E1">for</font> (kk=0; kk&lt;node_data_sz; kk++, jj++) tidx[jj] = id*node_data_sz + kk;
<a name="line298">298: </a>      }
<a name="line299">299: </a>      <a href="../../../../../docs/manualpages/IS/ISRestoreIndices.html#ISRestoreIndices">ISRestoreIndices</a>(is_eq_num_prim, &amp;idx);
<a name="line300">300: </a>      <a href="../../../../../docs/manualpages/IS/ISCreateGeneral.html#ISCreateGeneral">ISCreateGeneral</a>(comm, node_data_sz*ncrs, tidx, <a href="../../../../../docs/manualpages/Sys/PetscCopyMode.html#PetscCopyMode">PETSC_COPY_VALUES</a>, &amp;isscat);
<a name="line301">301: </a>      <a href="../../../../../docs/manualpages/Sys/PetscFree.html#PetscFree">PetscFree</a>(tidx);
<a name="line302">302: </a>      <font color="#B22222">/*</font>
<a name="line303">303: </a><font color="#B22222">        Create a vector to contain the original vertex information for each element</font>
<a name="line304">304: </a><font color="#B22222">      */</font>
<a name="line305">305: </a>      <a href="../../../../../docs/manualpages/Vec/VecCreateSeq.html#VecCreateSeq">VecCreateSeq</a>(<a href="../../../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</a>, node_data_sz*ncrs, &amp;src_crd);
<a name="line306">306: </a>      <font color="#4169E1">for</font> (jj=0; jj&lt;ndata_cols; jj++) {
<a name="line307">307: </a>        const <a href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> stride0=ncrs*pc_gamg-&gt;data_cell_rows;
<a name="line308">308: </a>        <font color="#4169E1">for</font> (ii=0; ii&lt;ncrs; ii++) {
<a name="line309">309: </a>          <font color="#4169E1">for</font> (kk=0; kk&lt;ndata_rows; kk++) {
<a name="line310">310: </a>            <a href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>    ix = ii*ndata_rows + kk + jj*stride0, jx = ii*node_data_sz + kk*ndata_cols + jj;
<a name="line311">311: </a>            <a href="../../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> tt = (<a href="../../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a>)pc_gamg-&gt;data[ix];
<a name="line312">312: </a>            <a href="../../../../../docs/manualpages/Vec/VecSetValues.html#VecSetValues">VecSetValues</a>(src_crd, 1, &amp;jx, &amp;tt, <a href="../../../../../docs/manualpages/Sys/INSERT_VALUES.html#INSERT_VALUES">INSERT_VALUES</a>);
<a name="line313">313: </a>          }
<a name="line314">314: </a>        }
<a name="line315">315: </a>      }
<a name="line316">316: </a>      <a href="../../../../../docs/manualpages/Vec/VecAssemblyBegin.html#VecAssemblyBegin">VecAssemblyBegin</a>(src_crd);
<a name="line317">317: </a>      <a href="../../../../../docs/manualpages/Vec/VecAssemblyEnd.html#VecAssemblyEnd">VecAssemblyEnd</a>(src_crd);
<a name="line318">318: </a>      <font color="#B22222">/*</font>
<a name="line319">319: </a><font color="#B22222">        Scatter the element vertex information (still in the original vertex ordering)</font>
<a name="line320">320: </a><font color="#B22222">        to the correct processor</font>
<a name="line321">321: </a><font color="#B22222">      */</font>
<a name="line322">322: </a>      <a href="../../../../../docs/manualpages/Vec/VecScatterCreate.html#VecScatterCreate">VecScatterCreate</a>(src_crd, NULL, dest_crd, isscat, &amp;vecscat);
<a name="line323">323: </a>      <a href="../../../../../docs/manualpages/IS/ISDestroy.html#ISDestroy">ISDestroy</a>(&amp;isscat);
<a name="line324">324: </a>      <a href="../../../../../docs/manualpages/Vec/VecScatterBegin.html#VecScatterBegin">VecScatterBegin</a>(vecscat,src_crd,dest_crd,<a href="../../../../../docs/manualpages/Sys/INSERT_VALUES.html#INSERT_VALUES">INSERT_VALUES</a>,<a href="../../../../../docs/manualpages/Vec/SCATTER_FORWARD.html#SCATTER_FORWARD">SCATTER_FORWARD</a>);
<a name="line325">325: </a>      <a href="../../../../../docs/manualpages/Vec/VecScatterEnd.html#VecScatterEnd">VecScatterEnd</a>(vecscat,src_crd,dest_crd,<a href="../../../../../docs/manualpages/Sys/INSERT_VALUES.html#INSERT_VALUES">INSERT_VALUES</a>,<a href="../../../../../docs/manualpages/Vec/SCATTER_FORWARD.html#SCATTER_FORWARD">SCATTER_FORWARD</a>);
<a name="line326">326: </a>      <a href="../../../../../docs/manualpages/Vec/VecScatterDestroy.html#VecScatterDestroy">VecScatterDestroy</a>(&amp;vecscat);
<a name="line327">327: </a>      <a href="../../../../../docs/manualpages/Vec/VecDestroy.html#VecDestroy">VecDestroy</a>(&amp;src_crd);
<a name="line328">328: </a>      <font color="#B22222">/*</font>
<a name="line329">329: </a><font color="#B22222">        Put the element vertex data into a new allocation of the gdata-&gt;ele</font>
<a name="line330">330: </a><font color="#B22222">      */</font>
<a name="line331">331: </a>      <a href="../../../../../docs/manualpages/Sys/PetscFree.html#PetscFree">PetscFree</a>(pc_gamg-&gt;data);
<a name="line332">332: </a>      <a href="../../../../../docs/manualpages/Sys/PetscMalloc1.html#PetscMalloc1">PetscMalloc1</a>(node_data_sz*ncrs_new, &amp;pc_gamg-&gt;data);

<a name="line334">334: </a>      pc_gamg-&gt;data_sz = node_data_sz*ncrs_new;
<a name="line335">335: </a>      strideNew        = ncrs_new*ndata_rows;

<a name="line337">337: </a>      <a href="../../../../../docs/manualpages/Vec/VecGetArray.html#VecGetArray">VecGetArray</a>(dest_crd, &amp;array);
<a name="line338">338: </a>      <font color="#4169E1">for</font> (jj=0; jj&lt;ndata_cols; jj++) {
<a name="line339">339: </a>        <font color="#4169E1">for</font> (ii=0; ii&lt;ncrs_new; ii++) {
<a name="line340">340: </a>          <font color="#4169E1">for</font> (kk=0; kk&lt;ndata_rows; kk++) {
<a name="line341">341: </a>            <a href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> ix = ii*ndata_rows + kk + jj*strideNew, jx = ii*node_data_sz + kk*ndata_cols + jj;
<a name="line342">342: </a>            pc_gamg-&gt;data[ix] = <a href="../../../../../docs/manualpages/Sys/PetscRealPart.html#PetscRealPart">PetscRealPart</a>(array[jx]);
<a name="line343">343: </a>          }
<a name="line344">344: </a>        }
<a name="line345">345: </a>      }
<a name="line346">346: </a>      <a href="../../../../../docs/manualpages/Vec/VecRestoreArray.html#VecRestoreArray">VecRestoreArray</a>(dest_crd, &amp;array);
<a name="line347">347: </a>      <a href="../../../../../docs/manualpages/Vec/VecDestroy.html#VecDestroy">VecDestroy</a>(&amp;dest_crd);
<a name="line348">348: </a>    }
<a name="line349">349: </a>    <font color="#B22222">/* move A and P (columns) with new layout */</font>
<a name="line350">350: </a><font color="#A020F0">#if defined PETSC_GAMG_USE_LOG</font>
<a name="line351">351: </a>    <a href="../../../../../docs/manualpages/Profiling/PetscLogEventBegin.html#PetscLogEventBegin">PetscLogEventBegin</a>(petsc_gamg_setup_events[SET13],0,0,0,0);
<a name="line352">352: </a><font color="#A020F0">#endif</font>
<a name="line353">353: </a>    <font color="#B22222">/*</font>
<a name="line354">354: </a><font color="#B22222">      Invert for <a href="../../../../../docs/manualpages/Mat/MatCreateSubMatrix.html#MatCreateSubMatrix">MatCreateSubMatrix</a></font>
<a name="line355">355: </a><font color="#B22222">    */</font>
<a name="line356">356: </a>    <a href="../../../../../docs/manualpages/IS/ISInvertPermutation.html#ISInvertPermutation">ISInvertPermutation</a>(is_eq_num, ncrs_eq_new, &amp;new_eq_indices);
<a name="line357">357: </a>    <a href="../../../../../docs/manualpages/IS/ISSort.html#ISSort">ISSort</a>(new_eq_indices); <font color="#B22222">/* is this needed? */</font>
<a name="line358">358: </a>    <a href="../../../../../docs/manualpages/IS/ISSetBlockSize.html#ISSetBlockSize">ISSetBlockSize</a>(new_eq_indices, cr_bs);
<a name="line359">359: </a>    <font color="#4169E1">if</font> (is_eq_num != is_eq_num_prim) {
<a name="line360">360: </a>      <a href="../../../../../docs/manualpages/IS/ISDestroy.html#ISDestroy">ISDestroy</a>(&amp;is_eq_num_prim); <font color="#B22222">/* could be same as 'is_eq_num' */</font>
<a name="line361">361: </a>    }
<a name="line362">362: </a>    <font color="#4169E1">if</font> (Pcolumnperm) {
<a name="line363">363: </a>      <a href="../../../../../docs/manualpages/Sys/PetscObjectReference.html#PetscObjectReference">PetscObjectReference</a>((<a href="../../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)new_eq_indices);
<a name="line364">364: </a>      *Pcolumnperm = new_eq_indices;
<a name="line365">365: </a>    }
<a name="line366">366: </a>    <a href="../../../../../docs/manualpages/IS/ISDestroy.html#ISDestroy">ISDestroy</a>(&amp;is_eq_num);
<a name="line367">367: </a><font color="#A020F0">#if defined PETSC_GAMG_USE_LOG</font>
<a name="line368">368: </a>    <a href="../../../../../docs/manualpages/Profiling/PetscLogEventEnd.html#PetscLogEventEnd">PetscLogEventEnd</a>(petsc_gamg_setup_events[SET13],0,0,0,0);
<a name="line369">369: </a>    <a href="../../../../../docs/manualpages/Profiling/PetscLogEventBegin.html#PetscLogEventBegin">PetscLogEventBegin</a>(petsc_gamg_setup_events[SET14],0,0,0,0);
<a name="line370">370: </a><font color="#A020F0">#endif</font>
<a name="line371">371: </a>    <font color="#B22222">/* 'a_Amat_crs' output */</font>
<a name="line372">372: </a>    {
<a name="line373">373: </a>      <a href="../../../../../docs/manualpages/Mat/Mat.html#Mat">Mat</a> mat;
<a name="line374">374: </a>      <a href="../../../../../docs/manualpages/Mat/MatCreateSubMatrix.html#MatCreateSubMatrix">MatCreateSubMatrix</a>(Cmat, new_eq_indices, new_eq_indices, <a href="../../../../../docs/manualpages/Mat/MatReuse.html#MatReuse">MAT_INITIAL_MATRIX</a>, &amp;mat);
<a name="line375">375: </a>      *a_Amat_crs = mat;
<a name="line376">376: </a>    }
<a name="line377">377: </a>    <a href="../../../../../docs/manualpages/Mat/MatDestroy.html#MatDestroy">MatDestroy</a>(&amp;Cmat);

<a name="line379">379: </a><font color="#A020F0">#if defined PETSC_GAMG_USE_LOG</font>
<a name="line380">380: </a>    <a href="../../../../../docs/manualpages/Profiling/PetscLogEventEnd.html#PetscLogEventEnd">PetscLogEventEnd</a>(petsc_gamg_setup_events[SET14],0,0,0,0);
<a name="line381">381: </a><font color="#A020F0">#endif</font>
<a name="line382">382: </a>    <font color="#B22222">/* prolongator */</font>
<a name="line383">383: </a>    {
<a name="line384">384: </a>      <a href="../../../../../docs/manualpages/IS/IS.html#IS">IS</a>       findices;
<a name="line385">385: </a>      <a href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> Istart,Iend;
<a name="line386">386: </a>      <a href="../../../../../docs/manualpages/Mat/Mat.html#Mat">Mat</a>      Pnew;

<a name="line388">388: </a>      <a href="../../../../../docs/manualpages/Mat/MatGetOwnershipRange.html#MatGetOwnershipRange">MatGetOwnershipRange</a>(Pold, &amp;Istart, &amp;Iend);
<a name="line389">389: </a><font color="#A020F0">#if defined PETSC_GAMG_USE_LOG</font>
<a name="line390">390: </a>      <a href="../../../../../docs/manualpages/Profiling/PetscLogEventBegin.html#PetscLogEventBegin">PetscLogEventBegin</a>(petsc_gamg_setup_events[SET15],0,0,0,0);
<a name="line391">391: </a><font color="#A020F0">#endif</font>
<a name="line392">392: </a>      <a href="../../../../../docs/manualpages/IS/ISCreateStride.html#ISCreateStride">ISCreateStride</a>(comm,Iend-Istart,Istart,1,&amp;findices);
<a name="line393">393: </a>      <a href="../../../../../docs/manualpages/IS/ISSetBlockSize.html#ISSetBlockSize">ISSetBlockSize</a>(findices,f_bs);
<a name="line394">394: </a>      <a href="../../../../../docs/manualpages/Mat/MatCreateSubMatrix.html#MatCreateSubMatrix">MatCreateSubMatrix</a>(Pold, findices, new_eq_indices, <a href="../../../../../docs/manualpages/Mat/MatReuse.html#MatReuse">MAT_INITIAL_MATRIX</a>, &amp;Pnew);
<a name="line395">395: </a>      <a href="../../../../../docs/manualpages/IS/ISDestroy.html#ISDestroy">ISDestroy</a>(&amp;findices);

<a name="line397">397: </a><font color="#A020F0">#if defined PETSC_GAMG_USE_LOG</font>
<a name="line398">398: </a>      <a href="../../../../../docs/manualpages/Profiling/PetscLogEventEnd.html#PetscLogEventEnd">PetscLogEventEnd</a>(petsc_gamg_setup_events[SET15],0,0,0,0);
<a name="line399">399: </a><font color="#A020F0">#endif</font>
<a name="line400">400: </a>      <a href="../../../../../docs/manualpages/Mat/MatDestroy.html#MatDestroy">MatDestroy</a>(a_P_inout);

<a name="line402">402: </a>      <font color="#B22222">/* output - repartitioned */</font>
<a name="line403">403: </a>      *a_P_inout = Pnew;
<a name="line404">404: </a>    }
<a name="line405">405: </a>    <a href="../../../../../docs/manualpages/IS/ISDestroy.html#ISDestroy">ISDestroy</a>(&amp;new_eq_indices);

<a name="line407">407: </a>    *a_nactive_proc = new_size; <font color="#B22222">/* output */</font>

<a name="line409">409: </a>    <font color="#B22222">/* pinning on reduced grids, not a bad heuristic and optimization gets folded into process reduction optimization */</font>
<a name="line410">410: </a>    <font color="#4169E1">if</font> (pc_gamg-&gt;cpu_pin_coarse_grids) {
<a name="line411">411: </a><font color="#A020F0">#if defined(PETSC_HAVE_VIENNACL) || defined(PETSC_HAVE_CUDA)</font>
<a name="line412">412: </a>      static <a href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> llev = 2;
<a name="line413">413: </a>      PetscInfo1(pc,<font color="#666666">"Pinning level %D to the CPU\n"</font>,llev++);
<a name="line414">414: </a><font color="#A020F0">#endif</font>
<a name="line415">415: </a>      <a href="../../../../../docs/manualpages/Mat/MatPinToCPU.html#MatPinToCPU">MatPinToCPU</a>(*a_Amat_crs,<a href="../../../../../docs/manualpages/Sys/PETSC_TRUE.html#PETSC_TRUE">PETSC_TRUE</a>);
<a name="line416">416: </a>      <a href="../../../../../docs/manualpages/Mat/MatPinToCPU.html#MatPinToCPU">MatPinToCPU</a>(*a_P_inout,<a href="../../../../../docs/manualpages/Sys/PETSC_TRUE.html#PETSC_TRUE">PETSC_TRUE</a>);
<a name="line417">417: </a>      <font color="#4169E1">if</font> (1) { <font color="#B22222">/* lvec is created, need to pin it, this is done in MatSetUpMultiply_MPIAIJ. Hack */</font>
<a name="line418">418: </a>        <a href="../../../../../docs/manualpages/Mat/Mat.html#Mat">Mat</a>         A = *a_Amat_crs, P = *a_P_inout;
<a name="line419">419: </a>        <a href="../../../../../docs/manualpages/Sys/PetscMPIInt.html#PetscMPIInt">PetscMPIInt</a> size;
<a name="line420">420: </a>        <a href="http://www.mpich.org/static/docs/latest/www3/MPI_Comm_size.html#MPI_Comm_size">MPI_Comm_size</a>(<a href="../../../../../docs/manualpages/Sys/PetscObjectComm.html#PetscObjectComm">PetscObjectComm</a>((<a href="../../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)A),&amp;size);
<a name="line421">421: </a>        <font color="#4169E1">if</font> (size &gt; 1) {
<a name="line422">422: </a>          Mat_MPIAIJ     *a = (Mat_MPIAIJ*)A-&gt;data, *p = (Mat_MPIAIJ*)P-&gt;data;
<a name="line423">423: </a>          <a href="../../../../../docs/manualpages/Vec/VecPinToCPU.html#VecPinToCPU">VecPinToCPU</a>(a-&gt;lvec,<a href="../../../../../docs/manualpages/Sys/PETSC_TRUE.html#PETSC_TRUE">PETSC_TRUE</a>);
<a name="line424">424: </a>          <a href="../../../../../docs/manualpages/Vec/VecPinToCPU.html#VecPinToCPU">VecPinToCPU</a>(p-&gt;lvec,<a href="../../../../../docs/manualpages/Sys/PETSC_TRUE.html#PETSC_TRUE">PETSC_TRUE</a>);
<a name="line425">425: </a>        }
<a name="line426">426: </a>      }
<a name="line427">427: </a>    }
<a name="line428">428: </a>  }
<a name="line429">429: </a>  <font color="#4169E1">return</font>(0);
<a name="line430">430: </a>}

<a name="line432">432: </a><font color="#B22222">/* -------------------------------------------------------------------------- */</font>
<a name="line433">433: </a><font color="#B22222">/*</font>
<a name="line434">434: </a><font color="#B22222">   PCSetUp_GAMG - Prepares for the use of the GAMG preconditioner</font>
<a name="line435">435: </a><font color="#B22222">                    by setting data structures and options.</font>

<a name="line437">437: </a><font color="#B22222">   Input Parameter:</font>
<a name="line438">438: </a><font color="#B22222">.  pc - the preconditioner context</font>

<a name="line440">440: </a><font color="#B22222">*/</font>
<a name="line441">441: </a><strong><font color="#4169E1"><a name="PCSetUp_GAMG"></a><a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> PCSetUp_GAMG(<a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a> pc)</font></strong>
<a name="line442">442: </a>{
<a name="line444">444: </a>  PC_MG          *mg      = (PC_MG*)pc-&gt;data;
<a name="line445">445: </a>  PC_GAMG        *pc_gamg = (PC_GAMG*)mg-&gt;innerctx;
<a name="line446">446: </a>  <a href="../../../../../docs/manualpages/Mat/Mat.html#Mat">Mat</a>            Pmat     = pc-&gt;pmat;
<a name="line447">447: </a>  <a href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>       fine_level,level,level1,bs,M,N,qq,lidx,nASMBlocksArr[PETSC_GAMG_MAXLEVELS];
<a name="line448">448: </a>  <a href="../../../../../docs/manualpages/Sys/MPI_Comm.html#MPI_Comm">MPI_Comm</a>       comm;
<a name="line449">449: </a>  <a href="../../../../../docs/manualpages/Sys/PetscMPIInt.html#PetscMPIInt">PetscMPIInt</a>    rank,size,nactivepe;
<a name="line450">450: </a>  <a href="../../../../../docs/manualpages/Mat/Mat.html#Mat">Mat</a>            Aarr[PETSC_GAMG_MAXLEVELS],Parr[PETSC_GAMG_MAXLEVELS];
<a name="line451">451: </a>  <a href="../../../../../docs/manualpages/IS/IS.html#IS">IS</a>             *ASMLocalIDsArr[PETSC_GAMG_MAXLEVELS];
<a name="line452">452: </a>  <a href="../../../../../docs/manualpages/Sys/PetscLogDouble.html#PetscLogDouble">PetscLogDouble</a> nnz0=0.,nnztot=0.;
<a name="line453">453: </a>  <a href="../../../../../docs/manualpages/Mat/MatInfo.html#MatInfo">MatInfo</a>        info;
<a name="line454">454: </a>  <a href="../../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</a>      is_last = <a href="../../../../../docs/manualpages/Sys/PETSC_FALSE.html#PETSC_FALSE">PETSC_FALSE</a>;

<a name="line457">457: </a>  <a href="../../../../../docs/manualpages/Sys/PetscObjectGetComm.html#PetscObjectGetComm">PetscObjectGetComm</a>((<a href="../../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)pc,&amp;comm);
<a name="line458">458: </a>  <a href="http://www.mpich.org/static/docs/latest/www3/MPI_Comm_rank.html#MPI_Comm_rank">MPI_Comm_rank</a>(comm,&amp;rank);
<a name="line459">459: </a>  <a href="http://www.mpich.org/static/docs/latest/www3/MPI_Comm_size.html#MPI_Comm_size">MPI_Comm_size</a>(comm,&amp;size);

<a name="line461">461: </a>  <font color="#4169E1">if</font> (pc_gamg-&gt;setup_count++ &gt; 0) {
<a name="line462">462: </a>    <font color="#4169E1">if</font> ((<a href="../../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</a>)(!pc_gamg-&gt;reuse_prol)) {
<a name="line463">463: </a>      <font color="#B22222">/* reset everything */</font>
<a name="line464">464: </a>      PCReset_MG(pc);
<a name="line465">465: </a>      pc-&gt;setupcalled = 0;
<a name="line466">466: </a>    } <font color="#4169E1">else</font> {
<a name="line467">467: </a>      PC_MG_Levels **mglevels = mg-&gt;levels;
<a name="line468">468: </a>      <font color="#B22222">/* just do Galerkin grids */</font>
<a name="line469">469: </a>      <a href="../../../../../docs/manualpages/Mat/Mat.html#Mat">Mat</a>          B,dA,dB;

<a name="line471">471: </a>      <font color="#4169E1">if</font> (!pc-&gt;setupcalled) <a href="../../../../../docs/manualpages/Sys/SETERRQ.html#SETERRQ">SETERRQ</a>(<a href="../../../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</a>,PETSC_ERR_PLIB,<font color="#666666">"<a href="../../../../../docs/manualpages/PC/PCSetUp.html#PCSetUp">PCSetUp</a>() has not been called yet"</font>);
<a name="line472">472: </a>      <font color="#4169E1">if</font> (pc_gamg-&gt;Nlevels &gt; 1) {
<a name="line473">473: </a>        <font color="#B22222">/* currently only handle case where mat and pmat are the same on coarser levels */</font>
<a name="line474">474: </a>        <a href="../../../../../docs/manualpages/KSP/KSPGetOperators.html#KSPGetOperators">KSPGetOperators</a>(mglevels[pc_gamg-&gt;Nlevels-1]-&gt;smoothd,&amp;dA,&amp;dB);
<a name="line475">475: </a>        <font color="#B22222">/* (re)set to get dirty flag */</font>
<a name="line476">476: </a>        <a href="../../../../../docs/manualpages/KSP/KSPSetOperators.html#KSPSetOperators">KSPSetOperators</a>(mglevels[pc_gamg-&gt;Nlevels-1]-&gt;smoothd,dA,dB);

<a name="line478">478: </a>        <font color="#4169E1">for</font> (level=pc_gamg-&gt;Nlevels-2; level&gt;=0; level--) {
<a name="line479">479: </a>          <font color="#B22222">/* 2nd solve, matrix structure can change from repartitioning or process reduction but don't know if we have process reduction here. Should fix */</font>
<a name="line480">480: </a>          <font color="#4169E1">if</font> (pc_gamg-&gt;setup_count==2 <font color="#B22222">/* &amp;&amp; pc_gamg-&gt;repart||reduction */</font>) {
<a name="line481">481: </a>            PetscInfo2(pc,<font color="#666666">"new RAP after first solve level %D, %D setup\n"</font>,level,pc_gamg-&gt;setup_count);
<a name="line482">482: </a>            <a href="../../../../../docs/manualpages/Mat/MatPtAP.html#MatPtAP">MatPtAP</a>(dB,mglevels[level+1]-&gt;interpolate,<a href="../../../../../docs/manualpages/Mat/MatReuse.html#MatReuse">MAT_INITIAL_MATRIX</a>,2.0,&amp;B);
<a name="line483">483: </a>            <a href="../../../../../docs/manualpages/Mat/MatDestroy.html#MatDestroy">MatDestroy</a>(&amp;mglevels[level]-&gt;A);
<a name="line484">484: </a>            mglevels[level]-&gt;A = B;
<a name="line485">485: </a>          } <font color="#4169E1">else</font> {
<a name="line486">486: </a>            PetscInfo2(pc,<font color="#666666">"RAP after first solve reusing matrix level %D, %D setup\n"</font>,level,pc_gamg-&gt;setup_count);
<a name="line487">487: </a>            <a href="../../../../../docs/manualpages/KSP/KSPGetOperators.html#KSPGetOperators">KSPGetOperators</a>(mglevels[level]-&gt;smoothd,NULL,&amp;B);
<a name="line488">488: </a>            <a href="../../../../../docs/manualpages/Mat/MatPtAP.html#MatPtAP">MatPtAP</a>(dB,mglevels[level+1]-&gt;interpolate,<a href="../../../../../docs/manualpages/Mat/MatReuse.html#MatReuse">MAT_REUSE_MATRIX</a>,1.0,&amp;B);
<a name="line489">489: </a>          }
<a name="line490">490: </a>          <a href="../../../../../docs/manualpages/KSP/KSPSetOperators.html#KSPSetOperators">KSPSetOperators</a>(mglevels[level]-&gt;smoothd,B,B);
<a name="line491">491: </a>          dB   = B;
<a name="line492">492: </a>        }
<a name="line493">493: </a>      }

<a name="line495">495: </a>      PCSetUp_MG(pc);
<a name="line496">496: </a>      <font color="#4169E1">return</font>(0);
<a name="line497">497: </a>    }
<a name="line498">498: </a>  }

<a name="line500">500: </a>  <font color="#4169E1">if</font> (!pc_gamg-&gt;data) {
<a name="line501">501: </a>    <font color="#4169E1">if</font> (pc_gamg-&gt;orig_data) {
<a name="line502">502: </a>      <a href="../../../../../docs/manualpages/Mat/MatGetBlockSize.html#MatGetBlockSize">MatGetBlockSize</a>(Pmat, &amp;bs);
<a name="line503">503: </a>      <a href="../../../../../docs/manualpages/Mat/MatGetLocalSize.html#MatGetLocalSize">MatGetLocalSize</a>(Pmat, &amp;qq, NULL);

<a name="line505">505: </a>      pc_gamg-&gt;data_sz        = (qq/bs)*pc_gamg-&gt;orig_data_cell_rows*pc_gamg-&gt;orig_data_cell_cols;
<a name="line506">506: </a>      pc_gamg-&gt;data_cell_rows = pc_gamg-&gt;orig_data_cell_rows;
<a name="line507">507: </a>      pc_gamg-&gt;data_cell_cols = pc_gamg-&gt;orig_data_cell_cols;

<a name="line509">509: </a>      <a href="../../../../../docs/manualpages/Sys/PetscMalloc1.html#PetscMalloc1">PetscMalloc1</a>(pc_gamg-&gt;data_sz, &amp;pc_gamg-&gt;data);
<a name="line510">510: </a>      <font color="#4169E1">for</font> (qq=0; qq&lt;pc_gamg-&gt;data_sz; qq++) pc_gamg-&gt;data[qq] = pc_gamg-&gt;orig_data[qq];
<a name="line511">511: </a>    } <font color="#4169E1">else</font> {
<a name="line512">512: </a>      <font color="#4169E1">if</font> (!pc_gamg-&gt;ops-&gt;createdefaultdata) <a href="../../../../../docs/manualpages/Sys/SETERRQ.html#SETERRQ">SETERRQ</a>(comm,PETSC_ERR_PLIB,<font color="#666666">"'createdefaultdata' not set(?) need to support NULL data"</font>);
<a name="line513">513: </a>      pc_gamg-&gt;ops-&gt;createdefaultdata(pc,Pmat);
<a name="line514">514: </a>    }
<a name="line515">515: </a>  }

<a name="line517">517: </a>  <font color="#B22222">/* cache original data for reuse */</font>
<a name="line518">518: </a>  <font color="#4169E1">if</font> (!pc_gamg-&gt;orig_data &amp;&amp; (<a href="../../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</a>)(!pc_gamg-&gt;reuse_prol)) {
<a name="line519">519: </a>    <a href="../../../../../docs/manualpages/Sys/PetscMalloc1.html#PetscMalloc1">PetscMalloc1</a>(pc_gamg-&gt;data_sz, &amp;pc_gamg-&gt;orig_data);
<a name="line520">520: </a>    <font color="#4169E1">for</font> (qq=0; qq&lt;pc_gamg-&gt;data_sz; qq++) pc_gamg-&gt;orig_data[qq] = pc_gamg-&gt;data[qq];
<a name="line521">521: </a>    pc_gamg-&gt;orig_data_cell_rows = pc_gamg-&gt;data_cell_rows;
<a name="line522">522: </a>    pc_gamg-&gt;orig_data_cell_cols = pc_gamg-&gt;data_cell_cols;
<a name="line523">523: </a>  }

<a name="line525">525: </a>  <font color="#B22222">/* get basic dims */</font>
<a name="line526">526: </a>  <a href="../../../../../docs/manualpages/Mat/MatGetBlockSize.html#MatGetBlockSize">MatGetBlockSize</a>(Pmat, &amp;bs);
<a name="line527">527: </a>  <a href="../../../../../docs/manualpages/Mat/MatGetSize.html#MatGetSize">MatGetSize</a>(Pmat, &amp;M, &amp;N);

<a name="line529">529: </a>  <a href="../../../../../docs/manualpages/Mat/MatGetInfo.html#MatGetInfo">MatGetInfo</a>(Pmat,<a href="../../../../../docs/manualpages/Mat/MatInfoType.html#MatInfoType">MAT_GLOBAL_SUM</a>,&amp;info); <font color="#B22222">/* global reduction */</font>
<a name="line530">530: </a>  nnz0   = info.nz_used;
<a name="line531">531: </a>  nnztot = info.nz_used;
<a name="line532">532: </a>  PetscInfo6(pc,<font color="#666666">"level %d) N=%D, n data rows=%d, n data cols=%d, nnz/row (ave)=%d, np=%d\n"</font>,0,M,pc_gamg-&gt;data_cell_rows,pc_gamg-&gt;data_cell_cols,(int)(nnz0/(<a href="../../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a>)M+0.5),size);

<a name="line534">534: </a>  <font color="#B22222">/* Get A_i and R_i */</font>
<a name="line535">535: </a>  <font color="#4169E1">for</font> (level=0, Aarr[0]=Pmat, nactivepe = size; level &lt; (pc_gamg-&gt;Nlevels-1) &amp;&amp; (!level || M&gt;pc_gamg-&gt;coarse_eq_limit); level++) {
<a name="line536">536: </a>    pc_gamg-&gt;current_level = level;
<a name="line537">537: </a>    level1 = level + 1;
<a name="line538">538: </a><font color="#A020F0">#if defined PETSC_GAMG_USE_LOG</font>
<a name="line539">539: </a>    <a href="../../../../../docs/manualpages/Profiling/PetscLogEventBegin.html#PetscLogEventBegin">PetscLogEventBegin</a>(petsc_gamg_setup_events[SET1],0,0,0,0);
<a name="line540">540: </a><font color="#A020F0">#if (defined GAMG_STAGES)</font>
<a name="line541">541: </a>    <a href="../../../../../docs/manualpages/Profiling/PetscLogStagePush.html#PetscLogStagePush">PetscLogStagePush</a>(gamg_stages[level]);
<a name="line542">542: </a><font color="#A020F0">#endif</font>
<a name="line543">543: </a><font color="#A020F0">#endif</font>
<a name="line544">544: </a>    { <font color="#B22222">/* construct prolongator */</font>
<a name="line545">545: </a>      <a href="../../../../../docs/manualpages/Mat/Mat.html#Mat">Mat</a>              Gmat;
<a name="line546">546: </a>      PetscCoarsenData *agg_lists;
<a name="line547">547: </a>      <a href="../../../../../docs/manualpages/Mat/Mat.html#Mat">Mat</a>              Prol11;

<a name="line549">549: </a>      pc_gamg-&gt;ops-&gt;graph(pc,Aarr[level], &amp;Gmat);
<a name="line550">550: </a>      pc_gamg-&gt;ops-&gt;coarsen(pc, &amp;Gmat, &amp;agg_lists);
<a name="line551">551: </a>      pc_gamg-&gt;ops-&gt;prolongator(pc,Aarr[level],Gmat,agg_lists,&amp;Prol11);

<a name="line553">553: </a>      <font color="#B22222">/* could have failed to create new level */</font>
<a name="line554">554: </a>      <font color="#4169E1">if</font> (Prol11) {
<a name="line555">555: </a>        <font color="#B22222">/* get new block size of coarse matrices */</font>
<a name="line556">556: </a>        <a href="../../../../../docs/manualpages/Mat/MatGetBlockSizes.html#MatGetBlockSizes">MatGetBlockSizes</a>(Prol11, NULL, &amp;bs);

<a name="line558">558: </a>        <font color="#4169E1">if</font> (pc_gamg-&gt;ops-&gt;optprolongator) {
<a name="line559">559: </a>          <font color="#B22222">/* smooth */</font>
<a name="line560">560: </a>          pc_gamg-&gt;ops-&gt;optprolongator(pc, Aarr[level], &amp;Prol11);
<a name="line561">561: </a>        }

<a name="line563">563: </a>        <font color="#4169E1">if</font> (pc_gamg-&gt;use_aggs_in_asm) {
<a name="line564">564: </a>          <a href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> bs;
<a name="line565">565: </a>          <a href="../../../../../docs/manualpages/Mat/MatGetBlockSizes.html#MatGetBlockSizes">MatGetBlockSizes</a>(Prol11, &amp;bs, NULL);
<a name="line566">566: </a>          PetscCDGetASMBlocks(agg_lists, bs, Gmat, &amp;nASMBlocksArr[level], &amp;ASMLocalIDsArr[level]);
<a name="line567">567: </a>        }

<a name="line569">569: </a>        Parr[level1] = Prol11;
<a name="line570">570: </a>      } <font color="#4169E1">else</font> Parr[level1] = NULL; <font color="#B22222">/* failed to coarsen */</font>

<a name="line572">572: </a>      <a href="../../../../../docs/manualpages/Mat/MatDestroy.html#MatDestroy">MatDestroy</a>(&amp;Gmat);
<a name="line573">573: </a>      PetscCDDestroy(agg_lists);
<a name="line574">574: </a>    } <font color="#B22222">/* construct prolongator scope */</font>
<a name="line575">575: </a><font color="#A020F0">#if defined PETSC_GAMG_USE_LOG</font>
<a name="line576">576: </a>    <a href="../../../../../docs/manualpages/Profiling/PetscLogEventEnd.html#PetscLogEventEnd">PetscLogEventEnd</a>(petsc_gamg_setup_events[SET1],0,0,0,0);
<a name="line577">577: </a><font color="#A020F0">#endif</font>
<a name="line578">578: </a>    <font color="#4169E1">if</font> (!level) Aarr[0] = Pmat; <font color="#B22222">/* use Pmat for finest level setup */</font>
<a name="line579">579: </a>    <font color="#4169E1">if</font> (!Parr[level1]) { <font color="#B22222">/* failed to coarsen */</font>
<a name="line580">580: </a>       PetscInfo1(pc,<font color="#666666">"Stop gridding, level %D\n"</font>,level);
<a name="line581">581: </a><font color="#A020F0">#if defined PETSC_GAMG_USE_LOG &amp;&amp; defined GAMG_STAGES</font>
<a name="line582">582: </a>      <a href="../../../../../docs/manualpages/Profiling/PetscLogStagePop.html#PetscLogStagePop">PetscLogStagePop</a>();
<a name="line583">583: </a><font color="#A020F0">#endif</font>
<a name="line584">584: </a>      <font color="#4169E1">break</font>;
<a name="line585">585: </a>    }
<a name="line586">586: </a><font color="#A020F0">#if defined PETSC_GAMG_USE_LOG</font>
<a name="line587">587: </a>    <a href="../../../../../docs/manualpages/Profiling/PetscLogEventBegin.html#PetscLogEventBegin">PetscLogEventBegin</a>(petsc_gamg_setup_events[SET2],0,0,0,0);
<a name="line588">588: </a><font color="#A020F0">#endif</font>
<a name="line589">589: </a>    <a href="../../../../../docs/manualpages/Mat/MatGetSize.html#MatGetSize">MatGetSize</a>(Parr[level1], &amp;M, &amp;N); <font color="#B22222">/* N is next M, a loop test variables */</font>
<a name="line590">590: </a>    <font color="#4169E1">if</font> (is_last) <a href="../../../../../docs/manualpages/Sys/SETERRQ.html#SETERRQ">SETERRQ</a>(<a href="../../../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</a>,PETSC_ERR_PLIB,<font color="#666666">"Is last ????????"</font>);
<a name="line591">591: </a>    <font color="#4169E1">if</font> (N &lt;= pc_gamg-&gt;coarse_eq_limit) is_last = <a href="../../../../../docs/manualpages/Sys/PETSC_TRUE.html#PETSC_TRUE">PETSC_TRUE</a>;
<a name="line592">592: </a>    <font color="#4169E1">if</font> (level1 == pc_gamg-&gt;Nlevels-1) is_last = <a href="../../../../../docs/manualpages/Sys/PETSC_TRUE.html#PETSC_TRUE">PETSC_TRUE</a>;
<a name="line593">593: </a>    pc_gamg-&gt;ops-&gt;createlevel(pc, Aarr[level], bs, &amp;Parr[level1], &amp;Aarr[level1], &amp;nactivepe, NULL, is_last);

<a name="line595">595: </a><font color="#A020F0">#if defined PETSC_GAMG_USE_LOG</font>
<a name="line596">596: </a>    <a href="../../../../../docs/manualpages/Profiling/PetscLogEventEnd.html#PetscLogEventEnd">PetscLogEventEnd</a>(petsc_gamg_setup_events[SET2],0,0,0,0);
<a name="line597">597: </a><font color="#A020F0">#endif</font>
<a name="line598">598: </a>    <a href="../../../../../docs/manualpages/Mat/MatGetSize.html#MatGetSize">MatGetSize</a>(Aarr[level1], &amp;M, &amp;N); <font color="#B22222">/* M is loop test variables */</font>
<a name="line599">599: </a>    <a href="../../../../../docs/manualpages/Mat/MatGetInfo.html#MatGetInfo">MatGetInfo</a>(Aarr[level1], <a href="../../../../../docs/manualpages/Mat/MatInfoType.html#MatInfoType">MAT_GLOBAL_SUM</a>, &amp;info);
<a name="line600">600: </a>    nnztot += info.nz_used;
<a name="line601">601: </a>    PetscInfo5(pc,<font color="#666666">"%d) N=%D, n data cols=%d, nnz/row (ave)=%d, %d active pes\n"</font>,level1,M,pc_gamg-&gt;data_cell_cols,(int)(info.nz_used/(<a href="../../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a>)M),nactivepe);

<a name="line603">603: </a><font color="#A020F0">#if (defined PETSC_GAMG_USE_LOG &amp;&amp; defined GAMG_STAGES)</font>
<a name="line604">604: </a>    <a href="../../../../../docs/manualpages/Profiling/PetscLogStagePop.html#PetscLogStagePop">PetscLogStagePop</a>();
<a name="line605">605: </a><font color="#A020F0">#endif</font>
<a name="line606">606: </a>    <font color="#B22222">/* stop if one node or one proc -- could pull back for singular problems */</font>
<a name="line607">607: </a>    <font color="#4169E1">if</font> ( (pc_gamg-&gt;data_cell_cols &amp;&amp; M/pc_gamg-&gt;data_cell_cols &lt; 2) || (!pc_gamg-&gt;data_cell_cols &amp;&amp; M/bs &lt; 2) ) {
<a name="line608">608: </a>       PetscInfo2(pc,<font color="#666666">"HARD stop of coarsening on level %D.  Grid too small: %D block nodes\n"</font>,level,M/bs);
<a name="line609">609: </a>      level++;
<a name="line610">610: </a>      <font color="#4169E1">break</font>;
<a name="line611">611: </a>    }
<a name="line612">612: </a>  } <font color="#B22222">/* levels */</font>
<a name="line613">613: </a>  <a href="../../../../../docs/manualpages/Sys/PetscFree.html#PetscFree">PetscFree</a>(pc_gamg-&gt;data);

<a name="line615">615: </a>  PetscInfo2(pc,<font color="#666666">"%D levels, grid complexity = %g\n"</font>,level+1,nnztot/nnz0);
<a name="line616">616: </a>  pc_gamg-&gt;Nlevels = level + 1;
<a name="line617">617: </a>  fine_level       = level;
<a name="line618">618: </a>  <a href="../../../../../docs/manualpages/PC/PCMGSetLevels.html#PCMGSetLevels">PCMGSetLevels</a>(pc,pc_gamg-&gt;Nlevels,NULL);

<a name="line620">620: </a>  <font color="#4169E1">if</font> (pc_gamg-&gt;Nlevels &gt; 1) { <font color="#B22222">/* don't setup MG if one level */</font>
<a name="line621">621: </a>    <font color="#B22222">/* set default smoothers &amp; set operators */</font>
<a name="line622">622: </a>    <font color="#4169E1">for</font> (lidx = 1, level = pc_gamg-&gt;Nlevels-2; lidx &lt;= fine_level; lidx++, level--) {
<a name="line623">623: </a>      <a href="../../../../../docs/manualpages/KSP/KSP.html#KSP">KSP</a> smoother;
<a name="line624">624: </a>      <a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a>  subpc;

<a name="line626">626: </a>      <a href="../../../../../docs/manualpages/PC/PCMGGetSmoother.html#PCMGGetSmoother">PCMGGetSmoother</a>(pc, lidx, &amp;smoother);
<a name="line627">627: </a>      <a href="../../../../../docs/manualpages/KSP/KSPGetPC.html#KSPGetPC">KSPGetPC</a>(smoother, &amp;subpc);

<a name="line629">629: </a>      <a href="../../../../../docs/manualpages/KSP/KSPSetNormType.html#KSPSetNormType">KSPSetNormType</a>(smoother, <a href="../../../../../docs/manualpages/KSP/KSP_NORM_NONE.html#KSP_NORM_NONE">KSP_NORM_NONE</a>);
<a name="line630">630: </a>      <font color="#B22222">/* set ops */</font>
<a name="line631">631: </a>      <a href="../../../../../docs/manualpages/KSP/KSPSetOperators.html#KSPSetOperators">KSPSetOperators</a>(smoother, Aarr[level], Aarr[level]);
<a name="line632">632: </a>      <a href="../../../../../docs/manualpages/PC/PCMGSetInterpolation.html#PCMGSetInterpolation">PCMGSetInterpolation</a>(pc, lidx, Parr[level+1]);

<a name="line634">634: </a>      <font color="#B22222">/* set defaults */</font>
<a name="line635">635: </a>      <a href="../../../../../docs/manualpages/KSP/KSPSetType.html#KSPSetType">KSPSetType</a>(smoother, <a href="../../../../../docs/manualpages/KSP/KSPCHEBYSHEV.html#KSPCHEBYSHEV">KSPCHEBYSHEV</a>);

<a name="line637">637: </a>      <font color="#B22222">/* set blocks for ASM smoother that uses the 'aggregates' */</font>
<a name="line638">638: </a>      <font color="#4169E1">if</font> (pc_gamg-&gt;use_aggs_in_asm) {
<a name="line639">639: </a>        <a href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> sz;
<a name="line640">640: </a>        <a href="../../../../../docs/manualpages/IS/IS.html#IS">IS</a>       *iss;

<a name="line642">642: </a>        sz   = nASMBlocksArr[level];
<a name="line643">643: </a>        iss  = ASMLocalIDsArr[level];
<a name="line644">644: </a>        <a href="../../../../../docs/manualpages/PC/PCSetType.html#PCSetType">PCSetType</a>(subpc, <a href="../../../../../docs/manualpages/PC/PCASM.html#PCASM">PCASM</a>);
<a name="line645">645: </a>        <a href="../../../../../docs/manualpages/PC/PCASMSetOverlap.html#PCASMSetOverlap">PCASMSetOverlap</a>(subpc, 0);
<a name="line646">646: </a>        <a href="../../../../../docs/manualpages/PC/PCASMSetType.html#PCASMSetType">PCASMSetType</a>(subpc,<a href="../../../../../docs/manualpages/PC/PCASMType.html#PCASMType">PC_ASM_BASIC</a>);
<a name="line647">647: </a>        <font color="#4169E1">if</font> (!sz) {
<a name="line648">648: </a>          <a href="../../../../../docs/manualpages/IS/IS.html#IS">IS</a>       is;
<a name="line649">649: </a>          <a href="../../../../../docs/manualpages/IS/ISCreateGeneral.html#ISCreateGeneral">ISCreateGeneral</a>(<a href="../../../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</a>, 0, NULL, <a href="../../../../../docs/manualpages/Sys/PetscCopyMode.html#PetscCopyMode">PETSC_COPY_VALUES</a>, &amp;is);
<a name="line650">650: </a>          <a href="../../../../../docs/manualpages/PC/PCASMSetLocalSubdomains.html#PCASMSetLocalSubdomains">PCASMSetLocalSubdomains</a>(subpc, 1, NULL, &amp;is);
<a name="line651">651: </a>          <a href="../../../../../docs/manualpages/IS/ISDestroy.html#ISDestroy">ISDestroy</a>(&amp;is);
<a name="line652">652: </a>        } <font color="#4169E1">else</font> {
<a name="line653">653: </a>          <a href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> kk;
<a name="line654">654: </a>          <a href="../../../../../docs/manualpages/PC/PCASMSetLocalSubdomains.html#PCASMSetLocalSubdomains">PCASMSetLocalSubdomains</a>(subpc, sz, NULL, iss);
<a name="line655">655: </a>          <font color="#4169E1">for</font> (kk=0; kk&lt;sz; kk++) {
<a name="line656">656: </a>            <a href="../../../../../docs/manualpages/IS/ISDestroy.html#ISDestroy">ISDestroy</a>(&amp;iss[kk]);
<a name="line657">657: </a>          }
<a name="line658">658: </a>          <a href="../../../../../docs/manualpages/Sys/PetscFree.html#PetscFree">PetscFree</a>(iss);
<a name="line659">659: </a>        }
<a name="line660">660: </a>        ASMLocalIDsArr[level] = NULL;
<a name="line661">661: </a>        nASMBlocksArr[level]  = 0;
<a name="line662">662: </a>      } <font color="#4169E1">else</font> {
<a name="line663">663: </a>        <a href="../../../../../docs/manualpages/PC/PCSetType.html#PCSetType">PCSetType</a>(subpc, <a href="../../../../../docs/manualpages/PC/PCSOR.html#PCSOR">PCSOR</a>);
<a name="line664">664: </a>      }
<a name="line665">665: </a>    }
<a name="line666">666: </a>    {
<a name="line667">667: </a>      <font color="#B22222">/* coarse grid */</font>
<a name="line668">668: </a>      <a href="../../../../../docs/manualpages/KSP/KSP.html#KSP">KSP</a> smoother,*k2; <a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a> subpc,pc2; <a href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> ii,first;
<a name="line669">669: </a>      <a href="../../../../../docs/manualpages/Mat/Mat.html#Mat">Mat</a> Lmat = Aarr[(level=pc_gamg-&gt;Nlevels-1)]; lidx = 0;
<a name="line670">670: </a>      <a href="../../../../../docs/manualpages/PC/PCMGGetSmoother.html#PCMGGetSmoother">PCMGGetSmoother</a>(pc, lidx, &amp;smoother);
<a name="line671">671: </a>      <a href="../../../../../docs/manualpages/KSP/KSPSetOperators.html#KSPSetOperators">KSPSetOperators</a>(smoother, Lmat, Lmat);
<a name="line672">672: </a>      <font color="#4169E1">if</font> (!pc_gamg-&gt;use_parallel_coarse_grid_solver) {
<a name="line673">673: </a>        <a href="../../../../../docs/manualpages/KSP/KSPSetNormType.html#KSPSetNormType">KSPSetNormType</a>(smoother, <a href="../../../../../docs/manualpages/KSP/KSP_NORM_NONE.html#KSP_NORM_NONE">KSP_NORM_NONE</a>);
<a name="line674">674: </a>        <a href="../../../../../docs/manualpages/KSP/KSPGetPC.html#KSPGetPC">KSPGetPC</a>(smoother, &amp;subpc);
<a name="line675">675: </a>        <a href="../../../../../docs/manualpages/PC/PCSetType.html#PCSetType">PCSetType</a>(subpc, <a href="../../../../../docs/manualpages/PC/PCBJACOBI.html#PCBJACOBI">PCBJACOBI</a>);
<a name="line676">676: </a>        <a href="../../../../../docs/manualpages/PC/PCSetUp.html#PCSetUp">PCSetUp</a>(subpc);
<a name="line677">677: </a>        <a href="../../../../../docs/manualpages/PC/PCBJacobiGetSubKSP.html#PCBJacobiGetSubKSP">PCBJacobiGetSubKSP</a>(subpc,&amp;ii,&amp;first,&amp;k2);
<a name="line678">678: </a>        <font color="#4169E1">if</font> (ii != 1) <a href="../../../../../docs/manualpages/Sys/SETERRQ1.html#SETERRQ1">SETERRQ1</a>(<a href="../../../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</a>,PETSC_ERR_PLIB,<font color="#666666">"ii %D is not one"</font>,ii);
<a name="line679">679: </a>        <a href="../../../../../docs/manualpages/KSP/KSPGetPC.html#KSPGetPC">KSPGetPC</a>(k2[0],&amp;pc2);
<a name="line680">680: </a>        <a href="../../../../../docs/manualpages/PC/PCSetType.html#PCSetType">PCSetType</a>(pc2, <a href="../../../../../docs/manualpages/PC/PCLU.html#PCLU">PCLU</a>);
<a name="line681">681: </a>        <a href="../../../../../docs/manualpages/PC/PCFactorSetShiftType.html#PCFactorSetShiftType">PCFactorSetShiftType</a>(pc2,MAT_SHIFT_INBLOCKS);
<a name="line682">682: </a>        <a href="../../../../../docs/manualpages/KSP/KSPSetTolerances.html#KSPSetTolerances">KSPSetTolerances</a>(k2[0],<a href="../../../../../docs/manualpages/Sys/PETSC_DEFAULT.html#PETSC_DEFAULT">PETSC_DEFAULT</a>,<a href="../../../../../docs/manualpages/Sys/PETSC_DEFAULT.html#PETSC_DEFAULT">PETSC_DEFAULT</a>,<a href="../../../../../docs/manualpages/Sys/PETSC_DEFAULT.html#PETSC_DEFAULT">PETSC_DEFAULT</a>,1);
<a name="line683">683: </a>        <a href="../../../../../docs/manualpages/KSP/KSPSetType.html#KSPSetType">KSPSetType</a>(k2[0], <a href="../../../../../docs/manualpages/KSP/KSPPREONLY.html#KSPPREONLY">KSPPREONLY</a>);
<a name="line684">684: </a>        <font color="#B22222">/* This flag gets reset by <a href="../../../../../docs/manualpages/PC/PCBJacobiGetSubKSP.html#PCBJacobiGetSubKSP">PCBJacobiGetSubKSP</a>(), but our BJacobi really does the same algorithm everywhere (and in</font>
<a name="line685">685: </a><font color="#B22222">         * fact, all but one process will have zero dofs), so we reset the flag to avoid having PCView_BJacobi attempt to</font>
<a name="line686">686: </a><font color="#B22222">         * view every subdomain as though they were different. */</font>
<a name="line687">687: </a>        ((PC_BJacobi*)subpc-&gt;data)-&gt;same_local_solves = <a href="../../../../../docs/manualpages/Sys/PETSC_TRUE.html#PETSC_TRUE">PETSC_TRUE</a>;
<a name="line688">688: </a>      }
<a name="line689">689: </a>    }

<a name="line691">691: </a>    <font color="#B22222">/* should be called in PCSetFromOptions_GAMG(), but cannot be called prior to <a href="../../../../../docs/manualpages/PC/PCMGSetLevels.html#PCMGSetLevels">PCMGSetLevels</a>() */</font>
<a name="line692">692: </a>    <a href="../../../../../docs/manualpages/Sys/PetscObjectOptionsBegin.html#PetscObjectOptionsBegin">PetscObjectOptionsBegin</a>((<a href="../../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)pc);
<a name="line693">693: </a>    PCSetFromOptions_MG(PetscOptionsObject,pc);
<a name="line694">694: </a>    <a href="../../../../../docs/manualpages/Sys/PetscOptionsEnd.html#PetscOptionsEnd">PetscOptionsEnd</a>();
<a name="line695">695: </a>    <a href="../../../../../docs/manualpages/PC/PCMGSetGalerkin.html#PCMGSetGalerkin">PCMGSetGalerkin</a>(pc,<a href="../../../../../docs/manualpages/PC/PCMGalerkinType.html#PCMGalerkinType">PC_MG_GALERKIN_EXTERNAL</a>);

<a name="line697">697: </a>    <font color="#B22222">/* clean up */</font>
<a name="line698">698: </a>    <font color="#4169E1">for</font> (level=1; level&lt;pc_gamg-&gt;Nlevels; level++) {
<a name="line699">699: </a>      <a href="../../../../../docs/manualpages/Mat/MatDestroy.html#MatDestroy">MatDestroy</a>(&amp;Parr[level]);
<a name="line700">700: </a>      <a href="../../../../../docs/manualpages/Mat/MatDestroy.html#MatDestroy">MatDestroy</a>(&amp;Aarr[level]);
<a name="line701">701: </a>    }
<a name="line702">702: </a>    PCSetUp_MG(pc);
<a name="line703">703: </a>  } <font color="#4169E1">else</font> {
<a name="line704">704: </a>    <a href="../../../../../docs/manualpages/KSP/KSP.html#KSP">KSP</a> smoother;
<a name="line705">705: </a>    <a href="../../../../../docs/manualpages/Profiling/PetscInfo.html#PetscInfo">PetscInfo</a>(pc,<font color="#666666">"One level solver used (system is seen as DD). Using default solver.\n"</font>);
<a name="line706">706: </a>    <a href="../../../../../docs/manualpages/PC/PCMGGetSmoother.html#PCMGGetSmoother">PCMGGetSmoother</a>(pc, 0, &amp;smoother);
<a name="line707">707: </a>    <a href="../../../../../docs/manualpages/KSP/KSPSetOperators.html#KSPSetOperators">KSPSetOperators</a>(smoother, Aarr[0], Aarr[0]);
<a name="line708">708: </a>    <a href="../../../../../docs/manualpages/KSP/KSPSetType.html#KSPSetType">KSPSetType</a>(smoother, <a href="../../../../../docs/manualpages/KSP/KSPPREONLY.html#KSPPREONLY">KSPPREONLY</a>);
<a name="line709">709: </a>    PCSetUp_MG(pc);
<a name="line710">710: </a>  }
<a name="line711">711: </a>  <font color="#4169E1">return</font>(0);
<a name="line712">712: </a>}

<a name="line714">714: </a><font color="#B22222">/* ------------------------------------------------------------------------- */</font>
<a name="line715">715: </a><font color="#B22222">/*</font>
<a name="line716">716: </a><font color="#B22222"> PCDestroy_GAMG - Destroys the private context for the GAMG preconditioner</font>
<a name="line717">717: </a><font color="#B22222">   that was created with PCCreate_GAMG().</font>

<a name="line719">719: </a><font color="#B22222">   Input Parameter:</font>
<a name="line720">720: </a><font color="#B22222">.  pc - the preconditioner context</font>

<a name="line722">722: </a><font color="#B22222">   Application Interface Routine: <a href="../../../../../docs/manualpages/PC/PCDestroy.html#PCDestroy">PCDestroy</a>()</font>
<a name="line723">723: </a><font color="#B22222">*/</font>
<a name="line724">724: </a><strong><font color="#4169E1"><a name="PCDestroy_GAMG"></a><a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> PCDestroy_GAMG(<a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a> pc)</font></strong>
<a name="line725">725: </a>{
<a name="line727">727: </a>  PC_MG          *mg     = (PC_MG*)pc-&gt;data;
<a name="line728">728: </a>  PC_GAMG        *pc_gamg= (PC_GAMG*)mg-&gt;innerctx;

<a name="line731">731: </a>  PCReset_GAMG(pc);
<a name="line732">732: </a>  <font color="#4169E1">if</font> (pc_gamg-&gt;ops-&gt;destroy) {
<a name="line733">733: </a>    (*pc_gamg-&gt;ops-&gt;destroy)(pc);
<a name="line734">734: </a>  }
<a name="line735">735: </a>  <a href="../../../../../docs/manualpages/Sys/PetscFree.html#PetscFree">PetscFree</a>(pc_gamg-&gt;ops);
<a name="line736">736: </a>  <a href="../../../../../docs/manualpages/Sys/PetscFree.html#PetscFree">PetscFree</a>(pc_gamg-&gt;gamg_type_name);
<a name="line737">737: </a>  <a href="../../../../../docs/manualpages/Sys/PetscFree.html#PetscFree">PetscFree</a>(pc_gamg);
<a name="line738">738: </a>  PCDestroy_MG(pc);
<a name="line739">739: </a>  <font color="#4169E1">return</font>(0);
<a name="line740">740: </a>}

<a name="line742">742: </a><font color="#B22222">/*@</font>
<a name="line743">743: </a><font color="#B22222">   <a href="../../../../../docs/manualpages/PC/PCGAMGSetProcEqLim.html#PCGAMGSetProcEqLim">PCGAMGSetProcEqLim</a> - Set number of equations to aim for per process on the coarse grids via processor reduction.</font>

<a name="line745">745: </a><font color="#B22222">   Logically Collective on <a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a></font>

<a name="line747">747: </a><font color="#B22222">   Input Parameters:</font>
<a name="line748">748: </a><font color="#B22222">+  pc - the preconditioner context</font>
<a name="line749">749: </a><font color="#B22222">-  n - the number of equations</font>


<a name="line752">752: </a><font color="#B22222">   Options Database Key:</font>
<a name="line753">753: </a><font color="#B22222">.  -pc_gamg_process_eq_limit &lt;limit&gt;</font>

<a name="line755">755: </a><font color="#B22222">   Notes:</font>
<a name="line756">756: </a><font color="#B22222">    GAMG will reduce the number of MPI processes used directly on the coarse grids so that there are around &lt;limit&gt; equations on each process</font>
<a name="line757">757: </a><font color="#B22222">          that has degrees of freedom</font>

<a name="line759">759: </a><font color="#B22222">   Level: intermediate</font>

<a name="line761">761: </a><font color="#B22222">.seealso: <a href="../../../../../docs/manualpages/PC/PCGAMGSetCoarseEqLim.html#PCGAMGSetCoarseEqLim">PCGAMGSetCoarseEqLim</a>()</font>
<a name="line762">762: </a><font color="#B22222">@*/</font>
<a name="line763">763: </a><strong><font color="#4169E1"><a name="PCGAMGSetProcEqLim"></a><a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a>  <a href="../../../../../docs/manualpages/PC/PCGAMGSetProcEqLim.html#PCGAMGSetProcEqLim">PCGAMGSetProcEqLim</a>(<a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a> pc, <a href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> n)</font></strong>
<a name="line764">764: </a>{

<a name="line769">769: </a>  PetscTryMethod(pc,<font color="#666666">"PCGAMGSetProcEqLim_C"</font>,(<a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a>,<a href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>),(pc,n));
<a name="line770">770: </a>  <font color="#4169E1">return</font>(0);
<a name="line771">771: </a>}

<a name="line773">773: </a><strong><font color="#4169E1"><a name="PCGAMGSetProcEqLim_GAMG"></a>static <a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> PCGAMGSetProcEqLim_GAMG(<a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a> pc, <a href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> n)</font></strong>
<a name="line774">774: </a>{
<a name="line775">775: </a>  PC_MG   *mg      = (PC_MG*)pc-&gt;data;
<a name="line776">776: </a>  PC_GAMG *pc_gamg = (PC_GAMG*)mg-&gt;innerctx;

<a name="line779">779: </a>  <font color="#4169E1">if</font> (n&gt;0) pc_gamg-&gt;min_eq_proc = n;
<a name="line780">780: </a>  <font color="#4169E1">return</font>(0);
<a name="line781">781: </a>}

<a name="line783">783: </a><font color="#B22222">/*@</font>
<a name="line784">784: </a><font color="#B22222">   <a href="../../../../../docs/manualpages/PC/PCGAMGSetCoarseEqLim.html#PCGAMGSetCoarseEqLim">PCGAMGSetCoarseEqLim</a> - Set maximum number of equations on coarsest grid.</font>

<a name="line786">786: </a><font color="#B22222"> Collective on <a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a></font>

<a name="line788">788: </a><font color="#B22222">   Input Parameters:</font>
<a name="line789">789: </a><font color="#B22222">+  pc - the preconditioner context</font>
<a name="line790">790: </a><font color="#B22222">-  n - maximum number of equations to aim for</font>

<a name="line792">792: </a><font color="#B22222">   Options Database Key:</font>
<a name="line793">793: </a><font color="#B22222">.  -pc_gamg_coarse_eq_limit &lt;limit&gt;</font>

<a name="line795">795: </a><font color="#B22222">   Notes: For example -pc_gamg_coarse_eq_limit 1000 will stop coarsening once the coarse grid</font>
<a name="line796">796: </a><font color="#B22222">     has less than 1000 unknowns.</font>

<a name="line798">798: </a><font color="#B22222">   Level: intermediate</font>

<a name="line800">800: </a><font color="#B22222">.seealso: <a href="../../../../../docs/manualpages/PC/PCGAMGSetProcEqLim.html#PCGAMGSetProcEqLim">PCGAMGSetProcEqLim</a>()</font>
<a name="line801">801: </a><font color="#B22222">@*/</font>
<a name="line802">802: </a><strong><font color="#4169E1"><a name="PCGAMGSetCoarseEqLim"></a><a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> <a href="../../../../../docs/manualpages/PC/PCGAMGSetCoarseEqLim.html#PCGAMGSetCoarseEqLim">PCGAMGSetCoarseEqLim</a>(<a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a> pc, <a href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> n)</font></strong>
<a name="line803">803: </a>{

<a name="line808">808: </a>  PetscTryMethod(pc,<font color="#666666">"PCGAMGSetCoarseEqLim_C"</font>,(<a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a>,<a href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>),(pc,n));
<a name="line809">809: </a>  <font color="#4169E1">return</font>(0);
<a name="line810">810: </a>}

<a name="line812">812: </a><strong><font color="#4169E1"><a name="PCGAMGSetCoarseEqLim_GAMG"></a>static <a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> PCGAMGSetCoarseEqLim_GAMG(<a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a> pc, <a href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> n)</font></strong>
<a name="line813">813: </a>{
<a name="line814">814: </a>  PC_MG   *mg      = (PC_MG*)pc-&gt;data;
<a name="line815">815: </a>  PC_GAMG *pc_gamg = (PC_GAMG*)mg-&gt;innerctx;

<a name="line818">818: </a>  <font color="#4169E1">if</font> (n&gt;0) pc_gamg-&gt;coarse_eq_limit = n;
<a name="line819">819: </a>  <font color="#4169E1">return</font>(0);
<a name="line820">820: </a>}

<a name="line822">822: </a><font color="#B22222">/*@</font>
<a name="line823">823: </a><font color="#B22222">   <a href="../../../../../docs/manualpages/PC/PCGAMGSetRepartition.html#PCGAMGSetRepartition">PCGAMGSetRepartition</a> - Repartition the degrees of freedom across the processors on the coarser grids</font>

<a name="line825">825: </a><font color="#B22222">   Collective on <a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a></font>

<a name="line827">827: </a><font color="#B22222">   Input Parameters:</font>
<a name="line828">828: </a><font color="#B22222">+  pc - the preconditioner context</font>
<a name="line829">829: </a><font color="#B22222">-  n - <a href="../../../../../docs/manualpages/Sys/PETSC_TRUE.html#PETSC_TRUE">PETSC_TRUE</a> or <a href="../../../../../docs/manualpages/Sys/PETSC_FALSE.html#PETSC_FALSE">PETSC_FALSE</a></font>

<a name="line831">831: </a><font color="#B22222">   Options Database Key:</font>
<a name="line832">832: </a><font color="#B22222">.  -pc_gamg_repartition &lt;true,false&gt;</font>

<a name="line834">834: </a><font color="#B22222">   Notes:</font>
<a name="line835">835: </a><font color="#B22222">    this will generally improve the loading balancing of the work on each level</font>

<a name="line837">837: </a><font color="#B22222">   Level: intermediate</font>

<a name="line839">839: </a><font color="#B22222">.seealso: ()</font>
<a name="line840">840: </a><font color="#B22222">@*/</font>
<a name="line841">841: </a><strong><font color="#4169E1"><a name="PCGAMGSetRepartition"></a><a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> <a href="../../../../../docs/manualpages/PC/PCGAMGSetRepartition.html#PCGAMGSetRepartition">PCGAMGSetRepartition</a>(<a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a> pc, <a href="../../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</a> n)</font></strong>
<a name="line842">842: </a>{

<a name="line847">847: </a>  PetscTryMethod(pc,<font color="#666666">"PCGAMGSetRepartition_C"</font>,(<a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a>,<a href="../../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</a>),(pc,n));
<a name="line848">848: </a>  <font color="#4169E1">return</font>(0);
<a name="line849">849: </a>}

<a name="line851">851: </a><strong><font color="#4169E1"><a name="PCGAMGSetRepartition_GAMG"></a>static <a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> PCGAMGSetRepartition_GAMG(<a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a> pc, <a href="../../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</a> n)</font></strong>
<a name="line852">852: </a>{
<a name="line853">853: </a>  PC_MG   *mg      = (PC_MG*)pc-&gt;data;
<a name="line854">854: </a>  PC_GAMG *pc_gamg = (PC_GAMG*)mg-&gt;innerctx;

<a name="line857">857: </a>  pc_gamg-&gt;repart = n;
<a name="line858">858: </a>  <font color="#4169E1">return</font>(0);
<a name="line859">859: </a>}

<a name="line861">861: </a><font color="#B22222">/*@</font>
<a name="line862">862: </a><font color="#B22222">   <a href="../../../../../docs/manualpages/PC/PCGAMGSetReuseInterpolation.html#PCGAMGSetReuseInterpolation">PCGAMGSetReuseInterpolation</a> - Reuse prolongation when rebuilding algebraic multigrid preconditioner</font>

<a name="line864">864: </a><font color="#B22222">   Collective on <a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a></font>

<a name="line866">866: </a><font color="#B22222">   Input Parameters:</font>
<a name="line867">867: </a><font color="#B22222">+  pc - the preconditioner context</font>
<a name="line868">868: </a><font color="#B22222">-  n - <a href="../../../../../docs/manualpages/Sys/PETSC_TRUE.html#PETSC_TRUE">PETSC_TRUE</a> or <a href="../../../../../docs/manualpages/Sys/PETSC_FALSE.html#PETSC_FALSE">PETSC_FALSE</a></font>

<a name="line870">870: </a><font color="#B22222">   Options Database Key:</font>
<a name="line871">871: </a><font color="#B22222">.  -pc_gamg_reuse_interpolation &lt;true,false&gt;</font>

<a name="line873">873: </a><font color="#B22222">   Level: intermediate</font>

<a name="line875">875: </a><font color="#B22222">   Notes:</font>
<a name="line876">876: </a><font color="#B22222">    this may negatively affect the convergence rate of the method on new matrices if the matrix entries change a great deal, but allows</font>
<a name="line877">877: </a><font color="#B22222">          rebuilding the preconditioner quicker.</font>

<a name="line879">879: </a><font color="#B22222">.seealso: ()</font>
<a name="line880">880: </a><font color="#B22222">@*/</font>
<a name="line881">881: </a><strong><font color="#4169E1"><a name="PCGAMGSetReuseInterpolation"></a><a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> <a href="../../../../../docs/manualpages/PC/PCGAMGSetReuseInterpolation.html#PCGAMGSetReuseInterpolation">PCGAMGSetReuseInterpolation</a>(<a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a> pc, <a href="../../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</a> n)</font></strong>
<a name="line882">882: </a>{

<a name="line887">887: </a>  PetscTryMethod(pc,<font color="#666666">"PCGAMGSetReuseInterpolation_C"</font>,(<a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a>,<a href="../../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</a>),(pc,n));
<a name="line888">888: </a>  <font color="#4169E1">return</font>(0);
<a name="line889">889: </a>}

<a name="line891">891: </a><strong><font color="#4169E1"><a name="PCGAMGSetReuseInterpolation_GAMG"></a>static <a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> PCGAMGSetReuseInterpolation_GAMG(<a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a> pc, <a href="../../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</a> n)</font></strong>
<a name="line892">892: </a>{
<a name="line893">893: </a>  PC_MG   *mg      = (PC_MG*)pc-&gt;data;
<a name="line894">894: </a>  PC_GAMG *pc_gamg = (PC_GAMG*)mg-&gt;innerctx;

<a name="line897">897: </a>  pc_gamg-&gt;reuse_prol = n;
<a name="line898">898: </a>  <font color="#4169E1">return</font>(0);
<a name="line899">899: </a>}

<a name="line901">901: </a><font color="#B22222">/*@</font>
<a name="line902">902: </a><font color="#B22222">   <a href="../../../../../docs/manualpages/PC/PCGAMGASMSetUseAggs.html#PCGAMGASMSetUseAggs">PCGAMGASMSetUseAggs</a> - Have the <a href="../../../../../docs/manualpages/PC/PCGAMG.html#PCGAMG">PCGAMG</a> smoother on each level use the aggregates defined by the coarsening process as the subdomains for the additive Schwarz preconditioner.</font>

<a name="line904">904: </a><font color="#B22222">   Collective on <a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a></font>

<a name="line906">906: </a><font color="#B22222">   Input Parameters:</font>
<a name="line907">907: </a><font color="#B22222">+  pc - the preconditioner context</font>
<a name="line908">908: </a><font color="#B22222">-  flg - <a href="../../../../../docs/manualpages/Sys/PETSC_TRUE.html#PETSC_TRUE">PETSC_TRUE</a> to use aggregates, <a href="../../../../../docs/manualpages/Sys/PETSC_FALSE.html#PETSC_FALSE">PETSC_FALSE</a> to not</font>

<a name="line910">910: </a><font color="#B22222">   Options Database Key:</font>
<a name="line911">911: </a><font color="#B22222">.  -pc_gamg_asm_use_agg</font>

<a name="line913">913: </a><font color="#B22222">   Level: intermediate</font>

<a name="line915">915: </a><font color="#B22222">.seealso: ()</font>
<a name="line916">916: </a><font color="#B22222">@*/</font>
<a name="line917">917: </a><strong><font color="#4169E1"><a name="PCGAMGASMSetUseAggs"></a><a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> <a href="../../../../../docs/manualpages/PC/PCGAMGASMSetUseAggs.html#PCGAMGASMSetUseAggs">PCGAMGASMSetUseAggs</a>(<a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a> pc, <a href="../../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</a> flg)</font></strong>
<a name="line918">918: </a>{

<a name="line923">923: </a>  PetscTryMethod(pc,<font color="#666666">"PCGAMGASMSetUseAggs_C"</font>,(<a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a>,<a href="../../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</a>),(pc,flg));
<a name="line924">924: </a>  <font color="#4169E1">return</font>(0);
<a name="line925">925: </a>}

<a name="line927">927: </a><strong><font color="#4169E1"><a name="PCGAMGASMSetUseAggs_GAMG"></a>static <a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> PCGAMGASMSetUseAggs_GAMG(<a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a> pc, <a href="../../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</a> flg)</font></strong>
<a name="line928">928: </a>{
<a name="line929">929: </a>  PC_MG   *mg      = (PC_MG*)pc-&gt;data;
<a name="line930">930: </a>  PC_GAMG *pc_gamg = (PC_GAMG*)mg-&gt;innerctx;

<a name="line933">933: </a>  pc_gamg-&gt;use_aggs_in_asm = flg;
<a name="line934">934: </a>  <font color="#4169E1">return</font>(0);
<a name="line935">935: </a>}

<a name="line937">937: </a><font color="#B22222">/*@</font>
<a name="line938">938: </a><font color="#B22222">   <a href="../../../../../docs/manualpages/PC/PCGAMGSetUseParallelCoarseGridSolve.html#PCGAMGSetUseParallelCoarseGridSolve">PCGAMGSetUseParallelCoarseGridSolve</a> - allow a parallel coarse grid solver</font>

<a name="line940">940: </a><font color="#B22222">   Collective on <a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a></font>

<a name="line942">942: </a><font color="#B22222">   Input Parameters:</font>
<a name="line943">943: </a><font color="#B22222">+  pc - the preconditioner context</font>
<a name="line944">944: </a><font color="#B22222">-  flg - <a href="../../../../../docs/manualpages/Sys/PETSC_TRUE.html#PETSC_TRUE">PETSC_TRUE</a> to not force coarse grid onto one processor</font>

<a name="line946">946: </a><font color="#B22222">   Options Database Key:</font>
<a name="line947">947: </a><font color="#B22222">.  -pc_gamg_use_parallel_coarse_grid_solver</font>

<a name="line949">949: </a><font color="#B22222">   Level: intermediate</font>

<a name="line951">951: </a><font color="#B22222">.seealso: <a href="../../../../../docs/manualpages/PC/PCGAMGSetCoarseGridLayoutType.html#PCGAMGSetCoarseGridLayoutType">PCGAMGSetCoarseGridLayoutType</a>(), <a href="../../../../../docs/manualpages/PC/PCGAMGSetCpuPinCoarseGrids.html#PCGAMGSetCpuPinCoarseGrids">PCGAMGSetCpuPinCoarseGrids</a>()</font>
<a name="line952">952: </a><font color="#B22222">@*/</font>
<a name="line953">953: </a><strong><font color="#4169E1"><a name="PCGAMGSetUseParallelCoarseGridSolve"></a><a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> <a href="../../../../../docs/manualpages/PC/PCGAMGSetUseParallelCoarseGridSolve.html#PCGAMGSetUseParallelCoarseGridSolve">PCGAMGSetUseParallelCoarseGridSolve</a>(<a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a> pc, <a href="../../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</a> flg)</font></strong>
<a name="line954">954: </a>{

<a name="line959">959: </a>  PetscTryMethod(pc,<font color="#666666">"PCGAMGSetUseParallelCoarseGridSolve_C"</font>,(<a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a>,<a href="../../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</a>),(pc,flg));
<a name="line960">960: </a>  <font color="#4169E1">return</font>(0);
<a name="line961">961: </a>}

<a name="line963">963: </a><strong><font color="#4169E1"><a name="PCGAMGSetUseParallelCoarseGridSolve_GAMG"></a>static <a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> PCGAMGSetUseParallelCoarseGridSolve_GAMG(<a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a> pc, <a href="../../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</a> flg)</font></strong>
<a name="line964">964: </a>{
<a name="line965">965: </a>  PC_MG   *mg      = (PC_MG*)pc-&gt;data;
<a name="line966">966: </a>  PC_GAMG *pc_gamg = (PC_GAMG*)mg-&gt;innerctx;

<a name="line969">969: </a>  pc_gamg-&gt;use_parallel_coarse_grid_solver = flg;
<a name="line970">970: </a>  <font color="#4169E1">return</font>(0);
<a name="line971">971: </a>}

<a name="line973">973: </a><font color="#B22222">/*@</font>
<a name="line974">974: </a><font color="#B22222">   <a href="../../../../../docs/manualpages/PC/PCGAMGSetCpuPinCoarseGrids.html#PCGAMGSetCpuPinCoarseGrids">PCGAMGSetCpuPinCoarseGrids</a> - pin reduced grids to CPU</font>

<a name="line976">976: </a><font color="#B22222">   Collective on <a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a></font>

<a name="line978">978: </a><font color="#B22222">   Input Parameters:</font>
<a name="line979">979: </a><font color="#B22222">+  pc - the preconditioner context</font>
<a name="line980">980: </a><font color="#B22222">-  flg - <a href="../../../../../docs/manualpages/Sys/PETSC_TRUE.html#PETSC_TRUE">PETSC_TRUE</a> to pin coarse grids to CPU</font>

<a name="line982">982: </a><font color="#B22222">   Options Database Key:</font>
<a name="line983">983: </a><font color="#B22222">.  -pc_gamg_cpu_pin_coarse_grids</font>

<a name="line985">985: </a><font color="#B22222">   Level: intermediate</font>

<a name="line987">987: </a><font color="#B22222">.seealso: <a href="../../../../../docs/manualpages/PC/PCGAMGSetCoarseGridLayoutType.html#PCGAMGSetCoarseGridLayoutType">PCGAMGSetCoarseGridLayoutType</a>(), <a href="../../../../../docs/manualpages/PC/PCGAMGSetUseParallelCoarseGridSolve.html#PCGAMGSetUseParallelCoarseGridSolve">PCGAMGSetUseParallelCoarseGridSolve</a>()</font>
<a name="line988">988: </a><font color="#B22222">@*/</font>
<a name="line989">989: </a><strong><font color="#4169E1"><a name="PCGAMGSetCpuPinCoarseGrids"></a><a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> <a href="../../../../../docs/manualpages/PC/PCGAMGSetCpuPinCoarseGrids.html#PCGAMGSetCpuPinCoarseGrids">PCGAMGSetCpuPinCoarseGrids</a>(<a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a> pc, <a href="../../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</a> flg)</font></strong>
<a name="line990">990: </a>{

<a name="line995">995: </a>  PetscTryMethod(pc,<font color="#666666">"PCGAMGSetCpuPinCoarseGrids_C"</font>,(<a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a>,<a href="../../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</a>),(pc,flg));
<a name="line996">996: </a>  <font color="#4169E1">return</font>(0);
<a name="line997">997: </a>}

<a name="line999">999: </a><strong><font color="#4169E1"><a name="PCGAMGSetCpuPinCoarseGrids_GAMG"></a>static <a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> PCGAMGSetCpuPinCoarseGrids_GAMG(<a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a> pc, <a href="../../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</a> flg)</font></strong>
<a name="line1000">1000: </a>{
<a name="line1001">1001: </a>  PC_MG   *mg      = (PC_MG*)pc-&gt;data;
<a name="line1002">1002: </a>  PC_GAMG *pc_gamg = (PC_GAMG*)mg-&gt;innerctx;

<a name="line1005">1005: </a>  pc_gamg-&gt;cpu_pin_coarse_grids = flg;
<a name="line1006">1006: </a>  <font color="#4169E1">return</font>(0);
<a name="line1007">1007: </a>}

<a name="line1009">1009: </a><font color="#B22222">/*@</font>
<a name="line1010">1010: </a><font color="#B22222">   <a href="../../../../../docs/manualpages/PC/PCGAMGSetCoarseGridLayoutType.html#PCGAMGSetCoarseGridLayoutType">PCGAMGSetCoarseGridLayoutType</a> - place reduce grids on processors with natural order (compact type)</font>

<a name="line1012">1012: </a><font color="#B22222">   Collective on <a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a></font>

<a name="line1014">1014: </a><font color="#B22222">   Input Parameters:</font>
<a name="line1015">1015: </a><font color="#B22222">+  pc - the preconditioner context</font>
<a name="line1016">1016: </a><font color="#B22222">-  flg - Layout type</font>

<a name="line1018">1018: </a><font color="#B22222">   Options Database Key:</font>
<a name="line1019">1019: </a><font color="#B22222">.  -pc_gamg_coarse_grid_layout_type</font>

<a name="line1021">1021: </a><font color="#B22222">   Level: intermediate</font>

<a name="line1023">1023: </a><font color="#B22222">.seealso: <a href="../../../../../docs/manualpages/PC/PCGAMGSetUseParallelCoarseGridSolve.html#PCGAMGSetUseParallelCoarseGridSolve">PCGAMGSetUseParallelCoarseGridSolve</a>(), <a href="../../../../../docs/manualpages/PC/PCGAMGSetCpuPinCoarseGrids.html#PCGAMGSetCpuPinCoarseGrids">PCGAMGSetCpuPinCoarseGrids</a>()</font>
<a name="line1024">1024: </a><font color="#B22222">@*/</font>
<a name="line1025">1025: </a><strong><font color="#4169E1"><a name="PCGAMGSetCoarseGridLayoutType"></a><a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> <a href="../../../../../docs/manualpages/PC/PCGAMGSetCoarseGridLayoutType.html#PCGAMGSetCoarseGridLayoutType">PCGAMGSetCoarseGridLayoutType</a>(<a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a> pc, <a href="../../../../../docs/manualpages/PC/PCGAMGLayoutType.html#PCGAMGLayoutType">PCGAMGLayoutType</a> flg)</font></strong>
<a name="line1026">1026: </a>{

<a name="line1031">1031: </a>  PetscTryMethod(pc,<font color="#666666">"PCGAMGSetCoarseGridLayoutType_C"</font>,(<a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a>,<a href="../../../../../docs/manualpages/PC/PCGAMGLayoutType.html#PCGAMGLayoutType">PCGAMGLayoutType</a>),(pc,flg));
<a name="line1032">1032: </a>  <font color="#4169E1">return</font>(0);
<a name="line1033">1033: </a>}

<a name="line1035">1035: </a><strong><font color="#4169E1"><a name="PCGAMGSetCoarseGridLayoutType_GAMG"></a>static <a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> PCGAMGSetCoarseGridLayoutType_GAMG(<a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a> pc, <a href="../../../../../docs/manualpages/PC/PCGAMGLayoutType.html#PCGAMGLayoutType">PCGAMGLayoutType</a> flg)</font></strong>
<a name="line1036">1036: </a>{
<a name="line1037">1037: </a>  PC_MG   *mg      = (PC_MG*)pc-&gt;data;
<a name="line1038">1038: </a>  PC_GAMG *pc_gamg = (PC_GAMG*)mg-&gt;innerctx;

<a name="line1041">1041: </a>  pc_gamg-&gt;layout_type = flg;
<a name="line1042">1042: </a>  <font color="#4169E1">return</font>(0);
<a name="line1043">1043: </a>}

<a name="line1045">1045: </a><font color="#B22222">/*@</font>
<a name="line1046">1046: </a><font color="#B22222">   <a href="../../../../../docs/manualpages/PC/PCGAMGSetNlevels.html#PCGAMGSetNlevels">PCGAMGSetNlevels</a> -  Sets the maximum number of levels <a href="../../../../../docs/manualpages/PC/PCGAMG.html#PCGAMG">PCGAMG</a> will use</font>

<a name="line1048">1048: </a><font color="#B22222">   Not collective on <a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a></font>

<a name="line1050">1050: </a><font color="#B22222">   Input Parameters:</font>
<a name="line1051">1051: </a><font color="#B22222">+  pc - the preconditioner</font>
<a name="line1052">1052: </a><font color="#B22222">-  n - the maximum number of levels to use</font>

<a name="line1054">1054: </a><font color="#B22222">   Options Database Key:</font>
<a name="line1055">1055: </a><font color="#B22222">.  -pc_mg_levels</font>

<a name="line1057">1057: </a><font color="#B22222">   Level: intermediate</font>

<a name="line1059">1059: </a><font color="#B22222">.seealso: ()</font>
<a name="line1060">1060: </a><font color="#B22222">@*/</font>
<a name="line1061">1061: </a><strong><font color="#4169E1"><a name="PCGAMGSetNlevels"></a><a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> <a href="../../../../../docs/manualpages/PC/PCGAMGSetNlevels.html#PCGAMGSetNlevels">PCGAMGSetNlevels</a>(<a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a> pc, <a href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> n)</font></strong>
<a name="line1062">1062: </a>{

<a name="line1067">1067: </a>  PetscTryMethod(pc,<font color="#666666">"PCGAMGSetNlevels_C"</font>,(<a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a>,<a href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>),(pc,n));
<a name="line1068">1068: </a>  <font color="#4169E1">return</font>(0);
<a name="line1069">1069: </a>}

<a name="line1071">1071: </a><strong><font color="#4169E1"><a name="PCGAMGSetNlevels_GAMG"></a>static <a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> PCGAMGSetNlevels_GAMG(<a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a> pc, <a href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> n)</font></strong>
<a name="line1072">1072: </a>{
<a name="line1073">1073: </a>  PC_MG   *mg      = (PC_MG*)pc-&gt;data;
<a name="line1074">1074: </a>  PC_GAMG *pc_gamg = (PC_GAMG*)mg-&gt;innerctx;

<a name="line1077">1077: </a>  pc_gamg-&gt;Nlevels = n;
<a name="line1078">1078: </a>  <font color="#4169E1">return</font>(0);
<a name="line1079">1079: </a>}

<a name="line1081">1081: </a><font color="#B22222">/*@</font>
<a name="line1082">1082: </a><font color="#B22222">   <a href="../../../../../docs/manualpages/PC/PCGAMGSetThreshold.html#PCGAMGSetThreshold">PCGAMGSetThreshold</a> - Relative threshold to use for dropping edges in aggregation graph</font>

<a name="line1084">1084: </a><font color="#B22222">   Not collective on <a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a></font>

<a name="line1086">1086: </a><font color="#B22222">   Input Parameters:</font>
<a name="line1087">1087: </a><font color="#B22222">+  pc - the preconditioner context</font>
<a name="line1088">1088: </a><font color="#B22222">-  threshold - the threshold value, 0.0 means keep all nonzero entries in the graph; negative means keep even zero entries in the graph</font>

<a name="line1090">1090: </a><font color="#B22222">   Options Database Key:</font>
<a name="line1091">1091: </a><font color="#B22222">.  -pc_gamg_threshold &lt;threshold&gt;</font>

<a name="line1093">1093: </a><font color="#B22222">   Notes:</font>
<a name="line1094">1094: </a><font color="#B22222">    Increasing the threshold decreases the rate of coarsening. Conversely reducing the threshold increases the rate of coarsening (aggressive coarsening) and thereby reduces the complexity of the coarse grids, and generally results in slower solver converge rates. Reducing coarse grid complexity reduced the complexity of Galerkin coarse grid construction considerably.</font>
<a name="line1095">1095: </a><font color="#B22222">    Before coarsening or aggregating the graph, GAMG removes small values from the graph with this threshold, and thus reducing the coupling in the graph and a different (perhaps better) coarser set of points.</font>

<a name="line1097">1097: </a><font color="#B22222">   Level: intermediate</font>

<a name="line1099">1099: </a><font color="#B22222">.seealso: <a href="../../../../../docs/manualpages/PC/PCGAMGFilterGraph.html#PCGAMGFilterGraph">PCGAMGFilterGraph</a>(), <a href="../../../../../docs/manualpages/PC/PCGAMGSetSquareGraph.html#PCGAMGSetSquareGraph">PCGAMGSetSquareGraph</a>()</font>
<a name="line1100">1100: </a><font color="#B22222">@*/</font>
<a name="line1101">1101: </a><strong><font color="#4169E1"><a name="PCGAMGSetThreshold"></a><a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> <a href="../../../../../docs/manualpages/PC/PCGAMGSetThreshold.html#PCGAMGSetThreshold">PCGAMGSetThreshold</a>(<a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a> pc, <a href="../../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> v[], <a href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> n)</font></strong>
<a name="line1102">1102: </a>{

<a name="line1107">1107: </a>  PetscTryMethod(pc,<font color="#666666">"PCGAMGSetThreshold_C"</font>,(<a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a>,<a href="../../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a>[],<a href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>),(pc,v,n));
<a name="line1108">1108: </a>  <font color="#4169E1">return</font>(0);
<a name="line1109">1109: </a>}

<a name="line1111">1111: </a><strong><font color="#4169E1"><a name="PCGAMGSetThreshold_GAMG"></a>static <a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> PCGAMGSetThreshold_GAMG(<a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a> pc, <a href="../../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> v[], <a href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> n)</font></strong>
<a name="line1112">1112: </a>{
<a name="line1113">1113: </a>  PC_MG   *mg      = (PC_MG*)pc-&gt;data;
<a name="line1114">1114: </a>  PC_GAMG *pc_gamg = (PC_GAMG*)mg-&gt;innerctx;
<a name="line1115">1115: </a>  <a href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> i;
<a name="line1117">1117: </a>  <font color="#4169E1">for</font> (i=0;i&lt;n;i++) pc_gamg-&gt;threshold[i] = v[i];
<a name="line1118">1118: </a>  <font color="#4169E1">do</font> {pc_gamg-&gt;threshold[i] = pc_gamg-&gt;threshold[i-1]*pc_gamg-&gt;threshold_scale;} <font color="#4169E1">while</font> (++i&lt;PETSC_GAMG_MAXLEVELS);
<a name="line1119">1119: </a>  <font color="#4169E1">return</font>(0);
<a name="line1120">1120: </a>}

<a name="line1122">1122: </a><font color="#B22222">/*@</font>
<a name="line1123">1123: </a><font color="#B22222">   <a href="../../../../../docs/manualpages/PC/PCGAMGSetThresholdScale.html#PCGAMGSetThresholdScale">PCGAMGSetThresholdScale</a> - Relative threshold reduction at each level</font>

<a name="line1125">1125: </a><font color="#B22222">   Not collective on <a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a></font>

<a name="line1127">1127: </a><font color="#B22222">   Input Parameters:</font>
<a name="line1128">1128: </a><font color="#B22222">+  pc - the preconditioner context</font>
<a name="line1129">1129: </a><font color="#B22222">-  scale - the threshold value reduction, ussually &lt; 1.0</font>

<a name="line1131">1131: </a><font color="#B22222">   Options Database Key:</font>
<a name="line1132">1132: </a><font color="#B22222">.  -pc_gamg_threshold_scale &lt;v&gt;</font>

<a name="line1134">1134: </a><font color="#B22222">   Level: advanced</font>

<a name="line1136">1136: </a><font color="#B22222">.seealso: ()</font>
<a name="line1137">1137: </a><font color="#B22222">@*/</font>
<a name="line1138">1138: </a><strong><font color="#4169E1"><a name="PCGAMGSetThresholdScale"></a><a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> <a href="../../../../../docs/manualpages/PC/PCGAMGSetThresholdScale.html#PCGAMGSetThresholdScale">PCGAMGSetThresholdScale</a>(<a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a> pc, <a href="../../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> v)</font></strong>
<a name="line1139">1139: </a>{

<a name="line1144">1144: </a>  PetscTryMethod(pc,<font color="#666666">"PCGAMGSetThresholdScale_C"</font>,(<a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a>,<a href="../../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a>),(pc,v));
<a name="line1145">1145: </a>  <font color="#4169E1">return</font>(0);
<a name="line1146">1146: </a>}

<a name="line1148">1148: </a><strong><font color="#4169E1"><a name="PCGAMGSetThresholdScale_GAMG"></a>static <a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> PCGAMGSetThresholdScale_GAMG(<a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a> pc, <a href="../../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> v)</font></strong>
<a name="line1149">1149: </a>{
<a name="line1150">1150: </a>  PC_MG   *mg      = (PC_MG*)pc-&gt;data;
<a name="line1151">1151: </a>  PC_GAMG *pc_gamg = (PC_GAMG*)mg-&gt;innerctx;
<a name="line1153">1153: </a>  pc_gamg-&gt;threshold_scale = v;
<a name="line1154">1154: </a>  <font color="#4169E1">return</font>(0);
<a name="line1155">1155: </a>}

<a name="line1157">1157: </a><font color="#B22222">/*@C</font>
<a name="line1158">1158: </a><font color="#B22222">   <a href="../../../../../docs/manualpages/PC/PCGAMGSetType.html#PCGAMGSetType">PCGAMGSetType</a> - Set solution method</font>

<a name="line1160">1160: </a><font color="#B22222">   Collective on <a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a></font>

<a name="line1162">1162: </a><font color="#B22222">   Input Parameters:</font>
<a name="line1163">1163: </a><font color="#B22222">+  pc - the preconditioner context</font>
<a name="line1164">1164: </a><font color="#B22222">-  type - PCGAMGAGG, PCGAMGGEO, or PCGAMGCLASSICAL</font>

<a name="line1166">1166: </a><font color="#B22222">   Options Database Key:</font>
<a name="line1167">1167: </a><font color="#B22222">.  -pc_gamg_type &lt;agg,geo,classical&gt; - type of algebraic multigrid to apply</font>

<a name="line1169">1169: </a><font color="#B22222">   Level: intermediate</font>

<a name="line1171">1171: </a><font color="#B22222">.seealso: <a href="../../../../../docs/manualpages/PC/PCGAMGGetType.html#PCGAMGGetType">PCGAMGGetType</a>(), <a href="../../../../../docs/manualpages/PC/PCGAMG.html#PCGAMG">PCGAMG</a>, <a href="../../../../../docs/manualpages/PC/PCGAMGType.html#PCGAMGType">PCGAMGType</a></font>
<a name="line1172">1172: </a><font color="#B22222">@*/</font>
<a name="line1173">1173: </a><strong><font color="#4169E1"><a name="PCGAMGSetType"></a><a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> <a href="../../../../../docs/manualpages/PC/PCGAMGSetType.html#PCGAMGSetType">PCGAMGSetType</a>(<a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a> pc, <a href="../../../../../docs/manualpages/PC/PCGAMGType.html#PCGAMGType">PCGAMGType</a> type)</font></strong>
<a name="line1174">1174: </a>{

<a name="line1179">1179: </a>  PetscTryMethod(pc,<font color="#666666">"PCGAMGSetType_C"</font>,(<a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a>,<a href="../../../../../docs/manualpages/PC/PCGAMGType.html#PCGAMGType">PCGAMGType</a>),(pc,type));
<a name="line1180">1180: </a>  <font color="#4169E1">return</font>(0);
<a name="line1181">1181: </a>}

<a name="line1183">1183: </a><font color="#B22222">/*@C</font>
<a name="line1184">1184: </a><font color="#B22222">   <a href="../../../../../docs/manualpages/PC/PCGAMGGetType.html#PCGAMGGetType">PCGAMGGetType</a> - Get solution method</font>

<a name="line1186">1186: </a><font color="#B22222">   Collective on <a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a></font>

<a name="line1188">1188: </a><font color="#B22222">   Input Parameter:</font>
<a name="line1189">1189: </a><font color="#B22222">.  pc - the preconditioner context</font>

<a name="line1191">1191: </a><font color="#B22222">   Output Parameter:</font>
<a name="line1192">1192: </a><font color="#B22222">.  type - the type of algorithm used</font>

<a name="line1194">1194: </a><font color="#B22222">   Level: intermediate</font>

<a name="line1196">1196: </a><font color="#B22222">.seealso: <a href="../../../../../docs/manualpages/PC/PCGAMGSetType.html#PCGAMGSetType">PCGAMGSetType</a>(), <a href="../../../../../docs/manualpages/PC/PCGAMGType.html#PCGAMGType">PCGAMGType</a></font>
<a name="line1197">1197: </a><font color="#B22222">@*/</font>
<a name="line1198">1198: </a><strong><font color="#4169E1"><a name="PCGAMGGetType"></a><a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> <a href="../../../../../docs/manualpages/PC/PCGAMGGetType.html#PCGAMGGetType">PCGAMGGetType</a>(<a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a> pc, <a href="../../../../../docs/manualpages/PC/PCGAMGType.html#PCGAMGType">PCGAMGType</a> *type)</font></strong>
<a name="line1199">1199: </a>{

<a name="line1204">1204: </a>  PetscUseMethod(pc,<font color="#666666">"PCGAMGGetType_C"</font>,(<a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a>,<a href="../../../../../docs/manualpages/PC/PCGAMGType.html#PCGAMGType">PCGAMGType</a>*),(pc,type));
<a name="line1205">1205: </a>  <font color="#4169E1">return</font>(0);
<a name="line1206">1206: </a>}

<a name="line1208">1208: </a><strong><font color="#4169E1"><a name="PCGAMGGetType_GAMG"></a>static <a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> PCGAMGGetType_GAMG(<a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a> pc, <a href="../../../../../docs/manualpages/PC/PCGAMGType.html#PCGAMGType">PCGAMGType</a> *type)</font></strong>
<a name="line1209">1209: </a>{
<a name="line1210">1210: </a>  PC_MG          *mg      = (PC_MG*)pc-&gt;data;
<a name="line1211">1211: </a>  PC_GAMG        *pc_gamg = (PC_GAMG*)mg-&gt;innerctx;

<a name="line1214">1214: </a>  *type = pc_gamg-&gt;type;
<a name="line1215">1215: </a>  <font color="#4169E1">return</font>(0);
<a name="line1216">1216: </a>}

<a name="line1218">1218: </a><strong><font color="#4169E1"><a name="PCGAMGSetType_GAMG"></a>static <a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> PCGAMGSetType_GAMG(<a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a> pc, <a href="../../../../../docs/manualpages/PC/PCGAMGType.html#PCGAMGType">PCGAMGType</a> type)</font></strong>
<a name="line1219">1219: </a>{
<a name="line1220">1220: </a>  <a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> ierr,(*r)(<a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a>);
<a name="line1221">1221: </a>  PC_MG          *mg      = (PC_MG*)pc-&gt;data;
<a name="line1222">1222: </a>  PC_GAMG        *pc_gamg = (PC_GAMG*)mg-&gt;innerctx;

<a name="line1225">1225: </a>  pc_gamg-&gt;type = type;
<a name="line1226">1226: </a>  <a href="../../../../../docs/manualpages/Sys/PetscFunctionListFind.html#PetscFunctionListFind">PetscFunctionListFind</a>(GAMGList,type,&amp;r);
<a name="line1227">1227: </a>  <font color="#4169E1">if</font> (!r) <a href="../../../../../docs/manualpages/Sys/SETERRQ1.html#SETERRQ1">SETERRQ1</a>(<a href="../../../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</a>,PETSC_ERR_ARG_UNKNOWN_TYPE,<font color="#666666">"Unknown GAMG type %s given"</font>,type);
<a name="line1228">1228: </a>  <font color="#4169E1">if</font> (pc_gamg-&gt;ops-&gt;destroy) {
<a name="line1229">1229: </a>    (*pc_gamg-&gt;ops-&gt;destroy)(pc);
<a name="line1230">1230: </a>    <a href="../../../../../docs/manualpages/Sys/PetscMemzero.html#PetscMemzero">PetscMemzero</a>(pc_gamg-&gt;ops,<font color="#4169E1">sizeof</font>(<font color="#4169E1">struct _PCGAMGOps</font>));
<a name="line1231">1231: </a>    pc_gamg-&gt;ops-&gt;createlevel = PCGAMGCreateLevel_GAMG;
<a name="line1232">1232: </a>    <font color="#B22222">/* cleaning up common data in pc_gamg - this should disapear someday */</font>
<a name="line1233">1233: </a>    pc_gamg-&gt;data_cell_cols = 0;
<a name="line1234">1234: </a>    pc_gamg-&gt;data_cell_rows = 0;
<a name="line1235">1235: </a>    pc_gamg-&gt;orig_data_cell_cols = 0;
<a name="line1236">1236: </a>    pc_gamg-&gt;orig_data_cell_rows = 0;
<a name="line1237">1237: </a>    <a href="../../../../../docs/manualpages/Sys/PetscFree.html#PetscFree">PetscFree</a>(pc_gamg-&gt;data);
<a name="line1238">1238: </a>    pc_gamg-&gt;data_sz = 0;
<a name="line1239">1239: </a>  }
<a name="line1240">1240: </a>  <a href="../../../../../docs/manualpages/Sys/PetscFree.html#PetscFree">PetscFree</a>(pc_gamg-&gt;gamg_type_name);
<a name="line1241">1241: </a>  <a href="../../../../../docs/manualpages/Sys/PetscStrallocpy.html#PetscStrallocpy">PetscStrallocpy</a>(type,&amp;pc_gamg-&gt;gamg_type_name);
<a name="line1242">1242: </a>  (*r)(pc);
<a name="line1243">1243: </a>  <font color="#4169E1">return</font>(0);
<a name="line1244">1244: </a>}

<a name="line1246">1246: </a><font color="#B22222">/* -------------------------------------------------------------------------- */</font>
<a name="line1247">1247: </a><font color="#B22222">/*</font>
<a name="line1248">1248: </a><font color="#B22222">   PCMGGetGridComplexity - compute coarse grid complexity of MG hierarchy</font>

<a name="line1250">1250: </a><font color="#B22222">   Input Parameter:</font>
<a name="line1251">1251: </a><font color="#B22222">.  pc - the preconditioner context</font>

<a name="line1253">1253: </a><font color="#B22222">   Output Parameter:</font>
<a name="line1254">1254: </a><font color="#B22222">.  gc - grid complexity = sum_i(nnz_i) / nnz_0</font>

<a name="line1256">1256: </a><font color="#B22222">   Level: advanced</font>
<a name="line1257">1257: </a><font color="#B22222">*/</font>
<a name="line1258">1258: </a><strong><font color="#4169E1"><a name="PCMGGetGridComplexity"></a>static <a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> PCMGGetGridComplexity(<a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a> pc, <a href="../../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> *gc)</font></strong>
<a name="line1259">1259: </a>{
<a name="line1261">1261: </a>  PC_MG          *mg      = (PC_MG*)pc-&gt;data;
<a name="line1262">1262: </a>  PC_MG_Levels   **mglevels = mg-&gt;levels;
<a name="line1263">1263: </a>  <a href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>       lev;
<a name="line1264">1264: </a>  <a href="../../../../../docs/manualpages/Sys/PetscLogDouble.html#PetscLogDouble">PetscLogDouble</a> nnz0 = 0, sgc = 0;
<a name="line1265">1265: </a>  <a href="../../../../../docs/manualpages/Mat/MatInfo.html#MatInfo">MatInfo</a>        info;

<a name="line1268">1268: </a>  <font color="#4169E1">if</font> (!mg-&gt;nlevels) <a href="../../../../../docs/manualpages/Sys/SETERRQ.html#SETERRQ">SETERRQ</a>(<a href="../../../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</a>,PETSC_ERR_PLIB,<font color="#666666">"MG has no levels"</font>);
<a name="line1269">1269: </a>  <font color="#4169E1">for</font> (lev=0; lev&lt;mg-&gt;nlevels; lev++) {
<a name="line1270">1270: </a>    <a href="../../../../../docs/manualpages/Mat/Mat.html#Mat">Mat</a> dB;
<a name="line1271">1271: </a>    <a href="../../../../../docs/manualpages/KSP/KSPGetOperators.html#KSPGetOperators">KSPGetOperators</a>(mglevels[lev]-&gt;smoothd,NULL,&amp;dB);
<a name="line1272">1272: </a>    <a href="../../../../../docs/manualpages/Mat/MatGetInfo.html#MatGetInfo">MatGetInfo</a>(dB,<a href="../../../../../docs/manualpages/Mat/MatInfoType.html#MatInfoType">MAT_GLOBAL_SUM</a>,&amp;info); <font color="#B22222">/* global reduction */</font>
<a name="line1273">1273: </a>    sgc += info.nz_used;
<a name="line1274">1274: </a>    <font color="#4169E1">if</font> (lev==mg-&gt;nlevels-1) nnz0 = info.nz_used;
<a name="line1275">1275: </a>  }
<a name="line1276">1276: </a>  <font color="#4169E1">if</font> (nnz0 &gt; 0) *gc = (<a href="../../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a>)(sgc/nnz0);
<a name="line1277">1277: </a>  <font color="#4169E1">else</font> <a href="../../../../../docs/manualpages/Sys/SETERRQ.html#SETERRQ">SETERRQ</a>(<a href="../../../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</a>,PETSC_ERR_PLIB,<font color="#666666">"Number for grid points on finest level is not available"</font>);
<a name="line1278">1278: </a>  <font color="#4169E1">return</font>(0);
<a name="line1279">1279: </a>}

<a name="line1281">1281: </a><strong><font color="#4169E1"><a name="PCView_GAMG"></a>static <a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> PCView_GAMG(<a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a> pc,<a href="../../../../../docs/manualpages/Viewer/PetscViewer.html#PetscViewer">PetscViewer</a> viewer)</font></strong>
<a name="line1282">1282: </a>{
<a name="line1283">1283: </a>  <a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> ierr,i;
<a name="line1284">1284: </a>  PC_MG          *mg      = (PC_MG*)pc-&gt;data;
<a name="line1285">1285: </a>  PC_GAMG        *pc_gamg = (PC_GAMG*)mg-&gt;innerctx;
<a name="line1286">1286: </a>  <a href="../../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a>       gc=0;
<a name="line1288">1288: </a>  <a href="../../../../../docs/manualpages/Viewer/PetscViewerASCIIPrintf.html#PetscViewerASCIIPrintf">PetscViewerASCIIPrintf</a>(viewer,<font color="#666666">"    GAMG specific options\n"</font>);
<a name="line1289">1289: </a>  <a href="../../../../../docs/manualpages/Viewer/PetscViewerASCIIPrintf.html#PetscViewerASCIIPrintf">PetscViewerASCIIPrintf</a>(viewer,<font color="#666666">"      Threshold for dropping small values in graph on each level ="</font>);
<a name="line1290">1290: </a>  <font color="#4169E1">for</font> (i=0;i&lt;pc_gamg-&gt;current_level;i++) {
<a name="line1291">1291: </a>    <a href="../../../../../docs/manualpages/Viewer/PetscViewerASCIIPrintf.html#PetscViewerASCIIPrintf">PetscViewerASCIIPrintf</a>(viewer,<font color="#666666">" %g"</font>,(double)pc_gamg-&gt;threshold[i]);
<a name="line1292">1292: </a>  }
<a name="line1293">1293: </a>  <a href="../../../../../docs/manualpages/Viewer/PetscViewerASCIIPrintf.html#PetscViewerASCIIPrintf">PetscViewerASCIIPrintf</a>(viewer,<font color="#666666">"\n"</font>);
<a name="line1294">1294: </a>  <a href="../../../../../docs/manualpages/Viewer/PetscViewerASCIIPrintf.html#PetscViewerASCIIPrintf">PetscViewerASCIIPrintf</a>(viewer,<font color="#666666">"      Threshold scaling factor for each level not specified = %g\n"</font>,(double)pc_gamg-&gt;threshold_scale);
<a name="line1295">1295: </a>  <font color="#4169E1">if</font> (pc_gamg-&gt;use_aggs_in_asm) {
<a name="line1296">1296: </a>    <a href="../../../../../docs/manualpages/Viewer/PetscViewerASCIIPrintf.html#PetscViewerASCIIPrintf">PetscViewerASCIIPrintf</a>(viewer,<font color="#666666">"      Using aggregates from coarsening process to define subdomains for <a href="../../../../../docs/manualpages/PC/PCASM.html#PCASM">PCASM</a>\n"</font>);
<a name="line1297">1297: </a>  }
<a name="line1298">1298: </a>  <font color="#4169E1">if</font> (pc_gamg-&gt;use_parallel_coarse_grid_solver) {
<a name="line1299">1299: </a>    <a href="../../../../../docs/manualpages/Viewer/PetscViewerASCIIPrintf.html#PetscViewerASCIIPrintf">PetscViewerASCIIPrintf</a>(viewer,<font color="#666666">"      Using parallel coarse grid solver (all coarse grid equations not put on one process)\n"</font>);
<a name="line1300">1300: </a>  }
<a name="line1301">1301: </a><font color="#A020F0">#if defined(PETSC_HAVE_VIENNACL) || defined(PETSC_HAVE_CUDA)</font>
<a name="line1302">1302: </a>  <font color="#4169E1">if</font> (pc_gamg-&gt;cpu_pin_coarse_grids) {
<a name="line1303">1303: </a>    <font color="#B22222">/* <a href="../../../../../docs/manualpages/Viewer/PetscViewerASCIIPrintf.html#PetscViewerASCIIPrintf">PetscViewerASCIIPrintf</a>(viewer,"      Pinning coarse grids to the CPU)\n"); */</font>
<a name="line1304">1304: </a>  }
<a name="line1305">1305: </a><font color="#A020F0">#endif</font>
<a name="line1306">1306: </a>  <font color="#B22222">/* if (pc_gamg-&gt;layout_type==<a href="../../../../../docs/manualpages/PC/PCGAMGLayoutType.html#PCGAMGLayoutType">PCGAMG_LAYOUT_COMPACT</a>) { */</font>
<a name="line1307">1307: </a>  <font color="#B22222">/*   <a href="../../../../../docs/manualpages/Viewer/PetscViewerASCIIPrintf.html#PetscViewerASCIIPrintf">PetscViewerASCIIPrintf</a>(viewer,"      Put reduced grids on processes in natural order (ie, 0,1,2...)\n"); */</font>
<a name="line1308">1308: </a>  <font color="#B22222">/* } else { */</font>
<a name="line1309">1309: </a>  <font color="#B22222">/*   <a href="../../../../../docs/manualpages/Viewer/PetscViewerASCIIPrintf.html#PetscViewerASCIIPrintf">PetscViewerASCIIPrintf</a>(viewer,"      Put reduced grids on whole machine (ie, 0,1*f,2*f...,np-f)\n"); */</font>
<a name="line1310">1310: </a>  <font color="#B22222">/* } */</font>
<a name="line1311">1311: </a>  <font color="#4169E1">if</font> (pc_gamg-&gt;ops-&gt;view) {
<a name="line1312">1312: </a>    (*pc_gamg-&gt;ops-&gt;view)(pc,viewer);
<a name="line1313">1313: </a>  }
<a name="line1314">1314: </a>  PCMGGetGridComplexity(pc,&amp;gc);
<a name="line1315">1315: </a>  <a href="../../../../../docs/manualpages/Viewer/PetscViewerASCIIPrintf.html#PetscViewerASCIIPrintf">PetscViewerASCIIPrintf</a>(viewer,<font color="#666666">"      Complexity:    grid = %g\n"</font>,gc);
<a name="line1316">1316: </a>  <font color="#4169E1">return</font>(0);
<a name="line1317">1317: </a>}

<a name="line1319">1319: </a><strong><font color="#4169E1"><a name="PCSetFromOptions_GAMG"></a><a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> PCSetFromOptions_GAMG(PetscOptionItems *PetscOptionsObject,<a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a> pc)</font></strong>
<a name="line1320">1320: </a>{
<a name="line1322">1322: </a>  PC_MG          *mg      = (PC_MG*)pc-&gt;data;
<a name="line1323">1323: </a>  PC_GAMG        *pc_gamg = (PC_GAMG*)mg-&gt;innerctx;
<a name="line1324">1324: </a>  <a href="../../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</a>      flag;
<a name="line1325">1325: </a>  <a href="../../../../../docs/manualpages/Sys/MPI_Comm.html#MPI_Comm">MPI_Comm</a>       comm;
<a name="line1326">1326: </a>  char           prefix[256];
<a name="line1327">1327: </a>  <a href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>       i,n;
<a name="line1328">1328: </a>  const char     *pcpre;
<a name="line1329">1329: </a>  static const char *LayoutTypes[] = {<font color="#666666">"compact"</font>,<font color="#666666">"spread"</font>,<font color="#666666">"<a href="../../../../../docs/manualpages/PC/PCGAMGLayoutType.html#PCGAMGLayoutType">PCGAMGLayoutType</a>"</font>,<font color="#666666">"PC_GAMG_LAYOUT"</font>,0};
<a name="line1331">1331: </a>  <a href="../../../../../docs/manualpages/Sys/PetscObjectGetComm.html#PetscObjectGetComm">PetscObjectGetComm</a>((<a href="../../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)pc,&amp;comm);
<a name="line1332">1332: </a>  <a href="../../../../../docs/manualpages/Sys/PetscOptionsHead.html#PetscOptionsHead">PetscOptionsHead</a>(PetscOptionsObject,<font color="#666666">"GAMG options"</font>);
<a name="line1333">1333: </a>  {
<a name="line1334">1334: </a>    char tname[256];
<a name="line1335">1335: </a>    <a href="../../../../../docs/manualpages/Sys/PetscOptionsFList.html#PetscOptionsFList">PetscOptionsFList</a>(<font color="#666666">"-pc_gamg_type"</font>,<font color="#666666">"Type of AMG method"</font>,<font color="#666666">"<a href="../../../../../docs/manualpages/PC/PCGAMGSetType.html#PCGAMGSetType">PCGAMGSetType</a>"</font>,GAMGList, pc_gamg-&gt;gamg_type_name, tname, <font color="#4169E1">sizeof</font>(tname), &amp;flag);
<a name="line1336">1336: </a>    <font color="#4169E1">if</font> (flag) {
<a name="line1337">1337: </a>      <a href="../../../../../docs/manualpages/PC/PCGAMGSetType.html#PCGAMGSetType">PCGAMGSetType</a>(pc,tname);
<a name="line1338">1338: </a>    }
<a name="line1339">1339: </a>    <a href="../../../../../docs/manualpages/Sys/PetscOptionsBool.html#PetscOptionsBool">PetscOptionsBool</a>(<font color="#666666">"-pc_gamg_repartition"</font>,<font color="#666666">"Repartion coarse grids"</font>,<font color="#666666">"<a href="../../../../../docs/manualpages/PC/PCGAMGSetRepartition.html#PCGAMGSetRepartition">PCGAMGSetRepartition</a>"</font>,pc_gamg-&gt;repart,&amp;pc_gamg-&gt;repart,NULL);
<a name="line1340">1340: </a>    <a href="../../../../../docs/manualpages/Sys/PetscOptionsBool.html#PetscOptionsBool">PetscOptionsBool</a>(<font color="#666666">"-pc_gamg_reuse_interpolation"</font>,<font color="#666666">"Reuse prolongation operator"</font>,<font color="#666666">"PCGAMGReuseInterpolation"</font>,pc_gamg-&gt;reuse_prol,&amp;pc_gamg-&gt;reuse_prol,NULL);
<a name="line1341">1341: </a>    <a href="../../../../../docs/manualpages/Sys/PetscOptionsBool.html#PetscOptionsBool">PetscOptionsBool</a>(<font color="#666666">"-pc_gamg_asm_use_agg"</font>,<font color="#666666">"Use aggregation aggregates for ASM smoother"</font>,<font color="#666666">"<a href="../../../../../docs/manualpages/PC/PCGAMGASMSetUseAggs.html#PCGAMGASMSetUseAggs">PCGAMGASMSetUseAggs</a>"</font>,pc_gamg-&gt;use_aggs_in_asm,&amp;pc_gamg-&gt;use_aggs_in_asm,NULL);
<a name="line1342">1342: </a>    <a href="../../../../../docs/manualpages/Sys/PetscOptionsBool.html#PetscOptionsBool">PetscOptionsBool</a>(<font color="#666666">"-pc_gamg_use_parallel_coarse_grid_solver"</font>,<font color="#666666">"Use parallel coarse grid solver (otherwise put last grid on one process)"</font>,<font color="#666666">"<a href="../../../../../docs/manualpages/PC/PCGAMGSetUseParallelCoarseGridSolve.html#PCGAMGSetUseParallelCoarseGridSolve">PCGAMGSetUseParallelCoarseGridSolve</a>"</font>,pc_gamg-&gt;use_parallel_coarse_grid_solver,&amp;pc_gamg-&gt;use_parallel_coarse_grid_solver,NULL);
<a name="line1343">1343: </a>    <a href="../../../../../docs/manualpages/Sys/PetscOptionsBool.html#PetscOptionsBool">PetscOptionsBool</a>(<font color="#666666">"-pc_gamg_cpu_pin_coarse_grids"</font>,<font color="#666666">"Pin coarse grids to the CPU"</font>,<font color="#666666">"<a href="../../../../../docs/manualpages/PC/PCGAMGSetCpuPinCoarseGrids.html#PCGAMGSetCpuPinCoarseGrids">PCGAMGSetCpuPinCoarseGrids</a>"</font>,pc_gamg-&gt;cpu_pin_coarse_grids,&amp;pc_gamg-&gt;cpu_pin_coarse_grids,NULL);
<a name="line1344">1344: </a>    <a href="../../../../../docs/manualpages/Sys/PetscOptionsEnum.html#PetscOptionsEnum">PetscOptionsEnum</a>(<font color="#666666">"-pc_gamg_coarse_grid_layout_type"</font>,<font color="#666666">"compact: place reduced grids on processes in natural order; spread: distribute to whole machine for more memory bandwidth"</font>,<font color="#666666">"<a href="../../../../../docs/manualpages/PC/PCGAMGSetCoarseGridLayoutType.html#PCGAMGSetCoarseGridLayoutType">PCGAMGSetCoarseGridLayoutType</a>"</font>,LayoutTypes,(<a href="../../../../../docs/manualpages/Sys/PetscEnum.html#PetscEnum">PetscEnum</a>)pc_gamg-&gt;layout_type,(<a href="../../../../../docs/manualpages/Sys/PetscEnum.html#PetscEnum">PetscEnum</a>*)&amp;pc_gamg-&gt;layout_type,NULL);
<a name="line1345">1345: </a>    <a href="../../../../../docs/manualpages/Sys/PetscOptionsInt.html#PetscOptionsInt">PetscOptionsInt</a>(<font color="#666666">"-pc_gamg_process_eq_limit"</font>,<font color="#666666">"Limit (goal) on number of equations per process on coarse grids"</font>,<font color="#666666">"<a href="../../../../../docs/manualpages/PC/PCGAMGSetProcEqLim.html#PCGAMGSetProcEqLim">PCGAMGSetProcEqLim</a>"</font>,pc_gamg-&gt;min_eq_proc,&amp;pc_gamg-&gt;min_eq_proc,NULL);
<a name="line1346">1346: </a>    <a href="../../../../../docs/manualpages/Sys/PetscOptionsInt.html#PetscOptionsInt">PetscOptionsInt</a>(<font color="#666666">"-pc_gamg_coarse_eq_limit"</font>,<font color="#666666">"Limit on number of equations for the coarse grid"</font>,<font color="#666666">"<a href="../../../../../docs/manualpages/PC/PCGAMGSetCoarseEqLim.html#PCGAMGSetCoarseEqLim">PCGAMGSetCoarseEqLim</a>"</font>,pc_gamg-&gt;coarse_eq_limit,&amp;pc_gamg-&gt;coarse_eq_limit,NULL);
<a name="line1347">1347: </a>    <a href="../../../../../docs/manualpages/Sys/PetscOptionsReal.html#PetscOptionsReal">PetscOptionsReal</a>(<font color="#666666">"-pc_gamg_threshold_scale"</font>,<font color="#666666">"Scaling of threshold for each level not specified"</font>,<font color="#666666">"<a href="../../../../../docs/manualpages/PC/PCGAMGSetThresholdScale.html#PCGAMGSetThresholdScale">PCGAMGSetThresholdScale</a>"</font>,pc_gamg-&gt;threshold_scale,&amp;pc_gamg-&gt;threshold_scale,NULL);
<a name="line1348">1348: </a>    n = PETSC_GAMG_MAXLEVELS;
<a name="line1349">1349: </a>    <a href="../../../../../docs/manualpages/Sys/PetscOptionsRealArray.html#PetscOptionsRealArray">PetscOptionsRealArray</a>(<font color="#666666">"-pc_gamg_threshold"</font>,<font color="#666666">"Relative threshold to use for dropping edges in aggregation graph"</font>,<font color="#666666">"<a href="../../../../../docs/manualpages/PC/PCGAMGSetThreshold.html#PCGAMGSetThreshold">PCGAMGSetThreshold</a>"</font>,pc_gamg-&gt;threshold,&amp;n,&amp;flag);
<a name="line1350">1350: </a>    <font color="#4169E1">if</font> (!flag || n &lt; PETSC_GAMG_MAXLEVELS) {
<a name="line1351">1351: </a>      <font color="#4169E1">if</font> (!flag) n = 1;
<a name="line1352">1352: </a>      i = n;
<a name="line1353">1353: </a>      <font color="#4169E1">do</font> {pc_gamg-&gt;threshold[i] = pc_gamg-&gt;threshold[i-1]*pc_gamg-&gt;threshold_scale;} <font color="#4169E1">while</font> (++i&lt;PETSC_GAMG_MAXLEVELS);
<a name="line1354">1354: </a>    }
<a name="line1355">1355: </a>    <a href="../../../../../docs/manualpages/Sys/PetscOptionsInt.html#PetscOptionsInt">PetscOptionsInt</a>(<font color="#666666">"-pc_mg_levels"</font>,<font color="#666666">"Set number of MG levels"</font>,<font color="#666666">"<a href="../../../../../docs/manualpages/PC/PCGAMGSetNlevels.html#PCGAMGSetNlevels">PCGAMGSetNlevels</a>"</font>,pc_gamg-&gt;Nlevels,&amp;pc_gamg-&gt;Nlevels,NULL);

<a name="line1357">1357: </a>    <font color="#B22222">/* set options for subtype */</font>
<a name="line1358">1358: </a>    <font color="#4169E1">if</font> (pc_gamg-&gt;ops-&gt;setfromoptions) {(*pc_gamg-&gt;ops-&gt;setfromoptions)(PetscOptionsObject,pc);}
<a name="line1359">1359: </a>  }
<a name="line1360">1360: </a>  <a href="../../../../../docs/manualpages/PC/PCGetOptionsPrefix.html#PCGetOptionsPrefix">PCGetOptionsPrefix</a>(pc, &amp;pcpre);
<a name="line1361">1361: </a>  <a href="../../../../../docs/manualpages/Sys/PetscSNPrintf.html#PetscSNPrintf">PetscSNPrintf</a>(prefix,<font color="#4169E1">sizeof</font>(prefix),<font color="#666666">"%spc_gamg_"</font>,pcpre ? pcpre : <font color="#666666">""</font>);
<a name="line1362">1362: </a>  <a href="../../../../../docs/manualpages/Sys/PetscOptionsTail.html#PetscOptionsTail">PetscOptionsTail</a>();
<a name="line1363">1363: </a>  <font color="#4169E1">return</font>(0);
<a name="line1364">1364: </a>}

<a name="line1366">1366: </a><font color="#B22222">/* -------------------------------------------------------------------------- */</font>
<a name="line1367">1367: </a><font color="#B22222">/*MC</font>
<a name="line1368">1368: </a><font color="#B22222">     <a href="../../../../../docs/manualpages/PC/PCGAMG.html#PCGAMG">PCGAMG</a> - Geometric algebraic multigrid (AMG) preconditioner</font>

<a name="line1370">1370: </a><font color="#B22222">   Options Database Keys:</font>
<a name="line1371">1371: </a><font color="#B22222">+   -pc_gamg_type &lt;type&gt; - one of agg, geo, or classical</font>
<a name="line1372">1372: </a><font color="#B22222">.   -pc_gamg_repartition  &lt;true,default=false&gt; - repartition the degrees of freedom accross the coarse grids as they are determined</font>
<a name="line1373">1373: </a><font color="#B22222">.   -pc_gamg_reuse_interpolation &lt;true,default=false&gt; - when rebuilding the algebraic multigrid preconditioner reuse the previously computed interpolations</font>
<a name="line1374">1374: </a><font color="#B22222">.   -pc_gamg_asm_use_agg &lt;true,default=false&gt; - use the aggregates from the coasening process to defined the subdomains on each level for the <a href="../../../../../docs/manualpages/PC/PCASM.html#PCASM">PCASM</a> smoother</font>
<a name="line1375">1375: </a><font color="#B22222">.   -pc_gamg_process_eq_limit &lt;limit, default=50&gt; - GAMG will reduce the number of MPI processes used directly on the coarse grids so that there are around &lt;limit&gt;</font>
<a name="line1376">1376: </a><font color="#B22222">                                        equations on each process that has degrees of freedom</font>
<a name="line1377">1377: </a><font color="#B22222">.   -pc_gamg_coarse_eq_limit &lt;limit, default=50&gt; - Set maximum number of equations on coarsest grid to aim for.</font>
<a name="line1378">1378: </a><font color="#B22222">.   -pc_gamg_threshold[] &lt;thresh,default=0&gt; - Before aggregating the graph GAMG will remove small values from the graph on each level</font>
<a name="line1379">1379: </a><font color="#B22222">-   -pc_gamg_threshold_scale &lt;scale,default=1&gt; - Scaling of threshold on each coarser grid if not specified</font>

<a name="line1381">1381: </a><font color="#B22222">   Options Database Keys for default Aggregation:</font>
<a name="line1382">1382: </a><font color="#B22222">+  -pc_gamg_agg_nsmooths &lt;nsmooth, default=1&gt; - number of smoothing steps to use with smooth aggregation</font>
<a name="line1383">1383: </a><font color="#B22222">.  -pc_gamg_sym_graph &lt;true,default=false&gt; - symmetrize the graph before computing the aggregation</font>
<a name="line1384">1384: </a><font color="#B22222">-  -pc_gamg_square_graph &lt;n,default=1&gt; - number of levels to square the graph before aggregating it</font>

<a name="line1386">1386: </a><font color="#B22222">   Multigrid options:</font>
<a name="line1387">1387: </a><font color="#B22222">+  -pc_mg_cycles &lt;v&gt; - v or w, see <a href="../../../../../docs/manualpages/PC/PCMGSetCycleType.html#PCMGSetCycleType">PCMGSetCycleType</a>()</font>
<a name="line1388">1388: </a><font color="#B22222">.  -pc_mg_distinct_smoothup - configure the up and down (pre and post) smoothers separately, see <a href="../../../../../docs/manualpages/PC/PCMGSetDistinctSmoothUp.html#PCMGSetDistinctSmoothUp">PCMGSetDistinctSmoothUp</a>()</font>
<a name="line1389">1389: </a><font color="#B22222">.  -pc_mg_type &lt;multiplicative&gt; - (one of) additive multiplicative full kascade</font>
<a name="line1390">1390: </a><font color="#B22222">-  -pc_mg_levels &lt;levels&gt; - Number of levels of multigrid to use.</font>


<a name="line1393">1393: </a><font color="#B22222">  Notes:</font>
<a name="line1394">1394: </a><font color="#B22222">    In order to obtain good performance for <a href="../../../../../docs/manualpages/PC/PCGAMG.html#PCGAMG">PCGAMG</a> for vector valued problems you must</font>
<a name="line1395">1395: </a><font color="#B22222">       Call <a href="../../../../../docs/manualpages/Mat/MatSetBlockSize.html#MatSetBlockSize">MatSetBlockSize</a>() to indicate the number of degrees of freedom per grid point</font>
<a name="line1396">1396: </a><font color="#B22222">       Call <a href="../../../../../docs/manualpages/Mat/MatSetNearNullSpace.html#MatSetNearNullSpace">MatSetNearNullSpace</a>() (or <a href="../../../../../docs/manualpages/PC/PCSetCoordinates.html#PCSetCoordinates">PCSetCoordinates</a>() if solving the equations of elasticity) to indicate the near null space of the operator</font>
<a name="line1397">1397: </a><font color="#B22222">       See the Users Manual Chapter 4 for more details</font>

<a name="line1399">1399: </a><font color="#B22222">  Level: intermediate</font>

<a name="line1401">1401: </a><font color="#B22222">.seealso:  <a href="../../../../../docs/manualpages/PC/PCCreate.html#PCCreate">PCCreate</a>(), <a href="../../../../../docs/manualpages/PC/PCSetType.html#PCSetType">PCSetType</a>(), <a href="../../../../../docs/manualpages/Mat/MatSetBlockSize.html#MatSetBlockSize">MatSetBlockSize</a>(), <a href="../../../../../docs/manualpages/PC/PCMGType.html#PCMGType">PCMGType</a>, <a href="../../../../../docs/manualpages/PC/PCSetCoordinates.html#PCSetCoordinates">PCSetCoordinates</a>(), <a href="../../../../../docs/manualpages/Mat/MatSetNearNullSpace.html#MatSetNearNullSpace">MatSetNearNullSpace</a>(), <a href="../../../../../docs/manualpages/PC/PCGAMGSetType.html#PCGAMGSetType">PCGAMGSetType</a>(), PCGAMGAGG, PCGAMGGEO, PCGAMGCLASSICAL, <a href="../../../../../docs/manualpages/PC/PCGAMGSetProcEqLim.html#PCGAMGSetProcEqLim">PCGAMGSetProcEqLim</a>(),</font>
<a name="line1402">1402: </a><font color="#B22222">           <a href="../../../../../docs/manualpages/PC/PCGAMGSetCoarseEqLim.html#PCGAMGSetCoarseEqLim">PCGAMGSetCoarseEqLim</a>(), <a href="../../../../../docs/manualpages/PC/PCGAMGSetRepartition.html#PCGAMGSetRepartition">PCGAMGSetRepartition</a>(), <a href="../../../../../docs/manualpages/PC/PCGAMGRegister.html#PCGAMGRegister">PCGAMGRegister</a>(), <a href="../../../../../docs/manualpages/PC/PCGAMGSetReuseInterpolation.html#PCGAMGSetReuseInterpolation">PCGAMGSetReuseInterpolation</a>(), <a href="../../../../../docs/manualpages/PC/PCGAMGASMSetUseAggs.html#PCGAMGASMSetUseAggs">PCGAMGASMSetUseAggs</a>(), <a href="../../../../../docs/manualpages/PC/PCGAMGSetUseParallelCoarseGridSolve.html#PCGAMGSetUseParallelCoarseGridSolve">PCGAMGSetUseParallelCoarseGridSolve</a>(), <a href="../../../../../docs/manualpages/PC/PCGAMGSetNlevels.html#PCGAMGSetNlevels">PCGAMGSetNlevels</a>(), <a href="../../../../../docs/manualpages/PC/PCGAMGSetThreshold.html#PCGAMGSetThreshold">PCGAMGSetThreshold</a>(), <a href="../../../../../docs/manualpages/PC/PCGAMGGetType.html#PCGAMGGetType">PCGAMGGetType</a>(), <a href="../../../../../docs/manualpages/PC/PCGAMGSetReuseInterpolation.html#PCGAMGSetReuseInterpolation">PCGAMGSetReuseInterpolation</a>()</font>
<a name="line1403">1403: </a><font color="#B22222">M*/</font>

<a name="line1405">1405: </a><strong><font color="#4169E1"><a name="PCCreate_GAMG"></a>PETSC_EXTERN <a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> PCCreate_GAMG(<a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a> pc)</font></strong>
<a name="line1406">1406: </a>{
<a name="line1407">1407: </a>  <a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> ierr,i;
<a name="line1408">1408: </a>  PC_GAMG        *pc_gamg;
<a name="line1409">1409: </a>  PC_MG          *mg;

<a name="line1412">1412: </a>   <font color="#B22222">/* register AMG type */</font>
<a name="line1413">1413: </a>  <a href="../../../../../docs/manualpages/PC/PCGAMGInitializePackage.html#PCGAMGInitializePackage">PCGAMGInitializePackage</a>();

<a name="line1415">1415: </a>  <font color="#B22222">/* <a href="../../../../../docs/manualpages/PC/PCGAMG.html#PCGAMG">PCGAMG</a> is an inherited class of <a href="../../../../../docs/manualpages/PC/PCMG.html#PCMG">PCMG</a>. Initialize pc as <a href="../../../../../docs/manualpages/PC/PCMG.html#PCMG">PCMG</a> */</font>
<a name="line1416">1416: </a>  <a href="../../../../../docs/manualpages/PC/PCSetType.html#PCSetType">PCSetType</a>(pc, <a href="../../../../../docs/manualpages/PC/PCMG.html#PCMG">PCMG</a>);
<a name="line1417">1417: </a>  PetscObjectChangeTypeName((<a href="../../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)pc, <a href="../../../../../docs/manualpages/PC/PCGAMG.html#PCGAMG">PCGAMG</a>);

<a name="line1419">1419: </a>  <font color="#B22222">/* create a supporting struct and attach it to pc */</font>
<a name="line1420">1420: </a>  <a href="../../../../../docs/manualpages/Sys/PetscNewLog.html#PetscNewLog">PetscNewLog</a>(pc,&amp;pc_gamg);
<a name="line1421">1421: </a>  <a href="../../../../../docs/manualpages/PC/PCMGSetGalerkin.html#PCMGSetGalerkin">PCMGSetGalerkin</a>(pc,<a href="../../../../../docs/manualpages/PC/PCMGalerkinType.html#PCMGalerkinType">PC_MG_GALERKIN_EXTERNAL</a>);
<a name="line1422">1422: </a>  mg           = (PC_MG*)pc-&gt;data;
<a name="line1423">1423: </a>  mg-&gt;innerctx = pc_gamg;

<a name="line1425">1425: </a>  <a href="../../../../../docs/manualpages/Sys/PetscNewLog.html#PetscNewLog">PetscNewLog</a>(pc,&amp;pc_gamg-&gt;ops);

<a name="line1427">1427: </a>  pc_gamg-&gt;setup_count = 0;
<a name="line1428">1428: </a>  <font color="#B22222">/* these should be in subctx but repartitioning needs simple arrays */</font>
<a name="line1429">1429: </a>  pc_gamg-&gt;data_sz = 0;
<a name="line1430">1430: </a>  pc_gamg-&gt;data    = 0;

<a name="line1432">1432: </a>  <font color="#B22222">/* overwrite the pointers of <a href="../../../../../docs/manualpages/PC/PCMG.html#PCMG">PCMG</a> by the functions of base class <a href="../../../../../docs/manualpages/PC/PCGAMG.html#PCGAMG">PCGAMG</a> */</font>
<a name="line1433">1433: </a>  pc-&gt;ops-&gt;setfromoptions = PCSetFromOptions_GAMG;
<a name="line1434">1434: </a>  pc-&gt;ops-&gt;setup          = PCSetUp_GAMG;
<a name="line1435">1435: </a>  pc-&gt;ops-&gt;reset          = PCReset_GAMG;
<a name="line1436">1436: </a>  pc-&gt;ops-&gt;destroy        = PCDestroy_GAMG;
<a name="line1437">1437: </a>  mg-&gt;view                = PCView_GAMG;

<a name="line1439">1439: </a>  <a href="../../../../../docs/manualpages/Sys/PetscObjectComposeFunction.html#PetscObjectComposeFunction">PetscObjectComposeFunction</a>((<a href="../../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)pc,<font color="#666666">"PCMGGetLevels_C"</font>,PCMGGetLevels_MG);
<a name="line1440">1440: </a>  <a href="../../../../../docs/manualpages/Sys/PetscObjectComposeFunction.html#PetscObjectComposeFunction">PetscObjectComposeFunction</a>((<a href="../../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)pc,<font color="#666666">"PCMGSetLevels_C"</font>,PCMGSetLevels_MG);
<a name="line1441">1441: </a>  <a href="../../../../../docs/manualpages/Sys/PetscObjectComposeFunction.html#PetscObjectComposeFunction">PetscObjectComposeFunction</a>((<a href="../../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)pc,<font color="#666666">"PCGAMGSetProcEqLim_C"</font>,PCGAMGSetProcEqLim_GAMG);
<a name="line1442">1442: </a>  <a href="../../../../../docs/manualpages/Sys/PetscObjectComposeFunction.html#PetscObjectComposeFunction">PetscObjectComposeFunction</a>((<a href="../../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)pc,<font color="#666666">"PCGAMGSetCoarseEqLim_C"</font>,PCGAMGSetCoarseEqLim_GAMG);
<a name="line1443">1443: </a>  <a href="../../../../../docs/manualpages/Sys/PetscObjectComposeFunction.html#PetscObjectComposeFunction">PetscObjectComposeFunction</a>((<a href="../../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)pc,<font color="#666666">"PCGAMGSetRepartition_C"</font>,PCGAMGSetRepartition_GAMG);
<a name="line1444">1444: </a>  <a href="../../../../../docs/manualpages/Sys/PetscObjectComposeFunction.html#PetscObjectComposeFunction">PetscObjectComposeFunction</a>((<a href="../../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)pc,<font color="#666666">"PCGAMGSetReuseInterpolation_C"</font>,PCGAMGSetReuseInterpolation_GAMG);
<a name="line1445">1445: </a>  <a href="../../../../../docs/manualpages/Sys/PetscObjectComposeFunction.html#PetscObjectComposeFunction">PetscObjectComposeFunction</a>((<a href="../../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)pc,<font color="#666666">"PCGAMGASMSetUseAggs_C"</font>,PCGAMGASMSetUseAggs_GAMG);
<a name="line1446">1446: </a>  <a href="../../../../../docs/manualpages/Sys/PetscObjectComposeFunction.html#PetscObjectComposeFunction">PetscObjectComposeFunction</a>((<a href="../../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)pc,<font color="#666666">"PCGAMGSetUseParallelCoarseGridSolve_C"</font>,PCGAMGSetUseParallelCoarseGridSolve_GAMG);
<a name="line1447">1447: </a>  <a href="../../../../../docs/manualpages/Sys/PetscObjectComposeFunction.html#PetscObjectComposeFunction">PetscObjectComposeFunction</a>((<a href="../../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)pc,<font color="#666666">"PCGAMGSetCpuPinCoarseGrids_C"</font>,PCGAMGSetCpuPinCoarseGrids_GAMG);
<a name="line1448">1448: </a>  <a href="../../../../../docs/manualpages/Sys/PetscObjectComposeFunction.html#PetscObjectComposeFunction">PetscObjectComposeFunction</a>((<a href="../../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)pc,<font color="#666666">"PCGAMGSetCoarseGridLayoutType_C"</font>,PCGAMGSetCoarseGridLayoutType_GAMG);
<a name="line1449">1449: </a>  <a href="../../../../../docs/manualpages/Sys/PetscObjectComposeFunction.html#PetscObjectComposeFunction">PetscObjectComposeFunction</a>((<a href="../../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)pc,<font color="#666666">"PCGAMGSetThreshold_C"</font>,PCGAMGSetThreshold_GAMG);
<a name="line1450">1450: </a>  <a href="../../../../../docs/manualpages/Sys/PetscObjectComposeFunction.html#PetscObjectComposeFunction">PetscObjectComposeFunction</a>((<a href="../../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)pc,<font color="#666666">"PCGAMGSetThresholdScale_C"</font>,PCGAMGSetThresholdScale_GAMG);
<a name="line1451">1451: </a>  <a href="../../../../../docs/manualpages/Sys/PetscObjectComposeFunction.html#PetscObjectComposeFunction">PetscObjectComposeFunction</a>((<a href="../../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)pc,<font color="#666666">"PCGAMGSetType_C"</font>,PCGAMGSetType_GAMG);
<a name="line1452">1452: </a>  <a href="../../../../../docs/manualpages/Sys/PetscObjectComposeFunction.html#PetscObjectComposeFunction">PetscObjectComposeFunction</a>((<a href="../../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)pc,<font color="#666666">"PCGAMGGetType_C"</font>,PCGAMGGetType_GAMG);
<a name="line1453">1453: </a>  <a href="../../../../../docs/manualpages/Sys/PetscObjectComposeFunction.html#PetscObjectComposeFunction">PetscObjectComposeFunction</a>((<a href="../../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)pc,<font color="#666666">"PCGAMGSetNlevels_C"</font>,PCGAMGSetNlevels_GAMG);
<a name="line1454">1454: </a>  pc_gamg-&gt;repart           = <a href="../../../../../docs/manualpages/Sys/PETSC_FALSE.html#PETSC_FALSE">PETSC_FALSE</a>;
<a name="line1455">1455: </a>  pc_gamg-&gt;reuse_prol       = <a href="../../../../../docs/manualpages/Sys/PETSC_FALSE.html#PETSC_FALSE">PETSC_FALSE</a>;
<a name="line1456">1456: </a>  pc_gamg-&gt;use_aggs_in_asm  = <a href="../../../../../docs/manualpages/Sys/PETSC_FALSE.html#PETSC_FALSE">PETSC_FALSE</a>;
<a name="line1457">1457: </a>  pc_gamg-&gt;use_parallel_coarse_grid_solver = <a href="../../../../../docs/manualpages/Sys/PETSC_FALSE.html#PETSC_FALSE">PETSC_FALSE</a>;
<a name="line1458">1458: </a>  pc_gamg-&gt;cpu_pin_coarse_grids = <a href="../../../../../docs/manualpages/Sys/PETSC_FALSE.html#PETSC_FALSE">PETSC_FALSE</a>;
<a name="line1459">1459: </a>  pc_gamg-&gt;layout_type      = <a href="../../../../../docs/manualpages/PC/PCGAMGLayoutType.html#PCGAMGLayoutType">PCGAMG_LAYOUT_SPREAD</a>;
<a name="line1460">1460: </a>  pc_gamg-&gt;min_eq_proc      = 50;
<a name="line1461">1461: </a>  pc_gamg-&gt;coarse_eq_limit  = 50;
<a name="line1462">1462: </a>  <font color="#4169E1">for</font> (i=0;i&lt;PETSC_GAMG_MAXLEVELS;i++) pc_gamg-&gt;threshold[i] = 0.;
<a name="line1463">1463: </a>  pc_gamg-&gt;threshold_scale = 1.;
<a name="line1464">1464: </a>  pc_gamg-&gt;Nlevels          = PETSC_GAMG_MAXLEVELS;
<a name="line1465">1465: </a>  pc_gamg-&gt;current_level    = 0; <font color="#B22222">/* don't need to init really */</font>
<a name="line1466">1466: </a>  pc_gamg-&gt;ops-&gt;createlevel = PCGAMGCreateLevel_GAMG;

<a name="line1468">1468: </a>  <font color="#B22222">/* PCSetUp_GAMG assumes that the type has been set, so set it to the default now */</font>
<a name="line1469">1469: </a>  <a href="../../../../../docs/manualpages/PC/PCGAMGSetType.html#PCGAMGSetType">PCGAMGSetType</a>(pc,PCGAMGAGG);
<a name="line1470">1470: </a>  <font color="#4169E1">return</font>(0);
<a name="line1471">1471: </a>}

<a name="line1473">1473: </a><font color="#B22222">/*@C</font>
<a name="line1474">1474: </a><font color="#B22222"> <a href="../../../../../docs/manualpages/PC/PCGAMGInitializePackage.html#PCGAMGInitializePackage">PCGAMGInitializePackage</a> - This function initializes everything in the <a href="../../../../../docs/manualpages/PC/PCGAMG.html#PCGAMG">PCGAMG</a> package. It is called</font>
<a name="line1475">1475: </a><font color="#B22222">    from <a href="../../../../../docs/manualpages/KSP/PCInitializePackage.html#PCInitializePackage">PCInitializePackage</a>().</font>

<a name="line1477">1477: </a><font color="#B22222"> Level: developer</font>

<a name="line1479">1479: </a><font color="#B22222"> .seealso: <a href="../../../../../docs/manualpages/Sys/PetscInitialize.html#PetscInitialize">PetscInitialize</a>()</font>
<a name="line1480">1480: </a><font color="#B22222">@*/</font>
<a name="line1481">1481: </a><strong><font color="#4169E1"><a name="PCGAMGInitializePackage"></a><a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> <a href="../../../../../docs/manualpages/PC/PCGAMGInitializePackage.html#PCGAMGInitializePackage">PCGAMGInitializePackage</a>(void)</font></strong>
<a name="line1482">1482: </a>{

<a name="line1486">1486: </a>  <font color="#4169E1">if</font> (PCGAMGPackageInitialized) <font color="#4169E1">return</font>(0);
<a name="line1487">1487: </a>  PCGAMGPackageInitialized = <a href="../../../../../docs/manualpages/Sys/PETSC_TRUE.html#PETSC_TRUE">PETSC_TRUE</a>;
<a name="line1488">1488: </a>  <a href="../../../../../docs/manualpages/Sys/PetscFunctionListAdd.html#PetscFunctionListAdd">PetscFunctionListAdd</a>(&amp;GAMGList,PCGAMGGEO,PCCreateGAMG_GEO);
<a name="line1489">1489: </a>  <a href="../../../../../docs/manualpages/Sys/PetscFunctionListAdd.html#PetscFunctionListAdd">PetscFunctionListAdd</a>(&amp;GAMGList,PCGAMGAGG,PCCreateGAMG_AGG);
<a name="line1490">1490: </a>  <a href="../../../../../docs/manualpages/Sys/PetscFunctionListAdd.html#PetscFunctionListAdd">PetscFunctionListAdd</a>(&amp;GAMGList,PCGAMGCLASSICAL,PCCreateGAMG_Classical);
<a name="line1491">1491: </a>  <a href="../../../../../docs/manualpages/Sys/PetscRegisterFinalize.html#PetscRegisterFinalize">PetscRegisterFinalize</a>(<a href="../../../../../docs/manualpages/PC/PCGAMGFinalizePackage.html#PCGAMGFinalizePackage">PCGAMGFinalizePackage</a>);

<a name="line1493">1493: </a>  <font color="#B22222">/* general events */</font>
<a name="line1494">1494: </a>  <a href="../../../../../docs/manualpages/Profiling/PetscLogEventRegister.html#PetscLogEventRegister">PetscLogEventRegister</a>(<font color="#666666">"PCGAMGGraph_AGG"</font>, 0, &amp;PC_GAMGGraph_AGG);
<a name="line1495">1495: </a>  <a href="../../../../../docs/manualpages/Profiling/PetscLogEventRegister.html#PetscLogEventRegister">PetscLogEventRegister</a>(<font color="#666666">"PCGAMGGraph_GEO"</font>, PC_CLASSID, &amp;PC_GAMGGraph_GEO);
<a name="line1496">1496: </a>  <a href="../../../../../docs/manualpages/Profiling/PetscLogEventRegister.html#PetscLogEventRegister">PetscLogEventRegister</a>(<font color="#666666">"PCGAMGCoarse_AGG"</font>, PC_CLASSID, &amp;PC_GAMGCoarsen_AGG);
<a name="line1497">1497: </a>  <a href="../../../../../docs/manualpages/Profiling/PetscLogEventRegister.html#PetscLogEventRegister">PetscLogEventRegister</a>(<font color="#666666">"PCGAMGCoarse_GEO"</font>, PC_CLASSID, &amp;PC_GAMGCoarsen_GEO);
<a name="line1498">1498: </a>  <a href="../../../../../docs/manualpages/Profiling/PetscLogEventRegister.html#PetscLogEventRegister">PetscLogEventRegister</a>(<font color="#666666">"PCGAMGProl_AGG"</font>, PC_CLASSID, &amp;PC_GAMGProlongator_AGG);
<a name="line1499">1499: </a>  <a href="../../../../../docs/manualpages/Profiling/PetscLogEventRegister.html#PetscLogEventRegister">PetscLogEventRegister</a>(<font color="#666666">"PCGAMGProl_GEO"</font>, PC_CLASSID, &amp;PC_GAMGProlongator_GEO);
<a name="line1500">1500: </a>  <a href="../../../../../docs/manualpages/Profiling/PetscLogEventRegister.html#PetscLogEventRegister">PetscLogEventRegister</a>(<font color="#666666">"PCGAMGPOpt_AGG"</font>, PC_CLASSID, &amp;PC_GAMGOptProlongator_AGG);

<a name="line1502">1502: </a><font color="#A020F0">#if defined PETSC_GAMG_USE_LOG</font>
<a name="line1503">1503: </a>  <a href="../../../../../docs/manualpages/Profiling/PetscLogEventRegister.html#PetscLogEventRegister">PetscLogEventRegister</a>(<font color="#666666">"GAMG: createProl"</font>, PC_CLASSID, &amp;petsc_gamg_setup_events[SET1]);
<a name="line1504">1504: </a>  <a href="../../../../../docs/manualpages/Profiling/PetscLogEventRegister.html#PetscLogEventRegister">PetscLogEventRegister</a>(<font color="#666666">"  Graph"</font>, PC_CLASSID, &amp;petsc_gamg_setup_events[GRAPH]);
<a name="line1505">1505: </a>  <font color="#B22222">/* <a href="../../../../../docs/manualpages/Profiling/PetscLogEventRegister.html#PetscLogEventRegister">PetscLogEventRegister</a>("    G.<a href="../../../../../docs/manualpages/Mat/Mat.html#Mat">Mat</a>", PC_CLASSID, &amp;petsc_gamg_setup_events[GRAPH_MAT]); */</font>
<a name="line1506">1506: </a>  <font color="#B22222">/* <a href="../../../../../docs/manualpages/Profiling/PetscLogEventRegister.html#PetscLogEventRegister">PetscLogEventRegister</a>("    G.Filter", PC_CLASSID, &amp;petsc_gamg_setup_events[GRAPH_FILTER]); */</font>
<a name="line1507">1507: </a>  <font color="#B22222">/* <a href="../../../../../docs/manualpages/Profiling/PetscLogEventRegister.html#PetscLogEventRegister">PetscLogEventRegister</a>("    G.Square", PC_CLASSID, &amp;petsc_gamg_setup_events[GRAPH_SQR]); */</font>
<a name="line1508">1508: </a>  <a href="../../../../../docs/manualpages/Profiling/PetscLogEventRegister.html#PetscLogEventRegister">PetscLogEventRegister</a>(<font color="#666666">"  MIS/Agg"</font>, PC_CLASSID, &amp;petsc_gamg_setup_events[SET4]);
<a name="line1509">1509: </a>  <a href="../../../../../docs/manualpages/Profiling/PetscLogEventRegister.html#PetscLogEventRegister">PetscLogEventRegister</a>(<font color="#666666">"  geo: growSupp"</font>, PC_CLASSID, &amp;petsc_gamg_setup_events[SET5]);
<a name="line1510">1510: </a>  <a href="../../../../../docs/manualpages/Profiling/PetscLogEventRegister.html#PetscLogEventRegister">PetscLogEventRegister</a>(<font color="#666666">"  geo: triangle"</font>, PC_CLASSID, &amp;petsc_gamg_setup_events[SET6]);
<a name="line1511">1511: </a>  <a href="../../../../../docs/manualpages/Profiling/PetscLogEventRegister.html#PetscLogEventRegister">PetscLogEventRegister</a>(<font color="#666666">"    search-set"</font>, PC_CLASSID, &amp;petsc_gamg_setup_events[FIND_V]);
<a name="line1512">1512: </a>  <a href="../../../../../docs/manualpages/Profiling/PetscLogEventRegister.html#PetscLogEventRegister">PetscLogEventRegister</a>(<font color="#666666">"  SA: col data"</font>, PC_CLASSID, &amp;petsc_gamg_setup_events[SET7]);
<a name="line1513">1513: </a>  <a href="../../../../../docs/manualpages/Profiling/PetscLogEventRegister.html#PetscLogEventRegister">PetscLogEventRegister</a>(<font color="#666666">"  SA: frmProl0"</font>, PC_CLASSID, &amp;petsc_gamg_setup_events[SET8]);
<a name="line1514">1514: </a>  <a href="../../../../../docs/manualpages/Profiling/PetscLogEventRegister.html#PetscLogEventRegister">PetscLogEventRegister</a>(<font color="#666666">"  SA: smooth"</font>, PC_CLASSID, &amp;petsc_gamg_setup_events[SET9]);
<a name="line1515">1515: </a>  <a href="../../../../../docs/manualpages/Profiling/PetscLogEventRegister.html#PetscLogEventRegister">PetscLogEventRegister</a>(<font color="#666666">"GAMG: partLevel"</font>, PC_CLASSID, &amp;petsc_gamg_setup_events[SET2]);
<a name="line1516">1516: </a>  <a href="../../../../../docs/manualpages/Profiling/PetscLogEventRegister.html#PetscLogEventRegister">PetscLogEventRegister</a>(<font color="#666666">"  repartition"</font>, PC_CLASSID, &amp;petsc_gamg_setup_events[SET12]);
<a name="line1517">1517: </a>  <a href="../../../../../docs/manualpages/Profiling/PetscLogEventRegister.html#PetscLogEventRegister">PetscLogEventRegister</a>(<font color="#666666">"  Invert-Sort"</font>, PC_CLASSID, &amp;petsc_gamg_setup_events[SET13]);
<a name="line1518">1518: </a>  <a href="../../../../../docs/manualpages/Profiling/PetscLogEventRegister.html#PetscLogEventRegister">PetscLogEventRegister</a>(<font color="#666666">"  Move A"</font>, PC_CLASSID, &amp;petsc_gamg_setup_events[SET14]);
<a name="line1519">1519: </a>  <a href="../../../../../docs/manualpages/Profiling/PetscLogEventRegister.html#PetscLogEventRegister">PetscLogEventRegister</a>(<font color="#666666">"  Move P"</font>, PC_CLASSID, &amp;petsc_gamg_setup_events[SET15]);

<a name="line1521">1521: </a>  <font color="#B22222">/* <a href="../../../../../docs/manualpages/Profiling/PetscLogEventRegister.html#PetscLogEventRegister">PetscLogEventRegister</a>(" PL move data", PC_CLASSID, &amp;petsc_gamg_setup_events[SET13]); */</font>
<a name="line1522">1522: </a>  <font color="#B22222">/* <a href="../../../../../docs/manualpages/Profiling/PetscLogEventRegister.html#PetscLogEventRegister">PetscLogEventRegister</a>("GAMG: fix", PC_CLASSID, &amp;petsc_gamg_setup_events[SET10]); */</font>
<a name="line1523">1523: </a>  <font color="#B22222">/* <a href="../../../../../docs/manualpages/Profiling/PetscLogEventRegister.html#PetscLogEventRegister">PetscLogEventRegister</a>("GAMG: set levels", PC_CLASSID, &amp;petsc_gamg_setup_events[SET11]); */</font>
<a name="line1524">1524: </a>  <font color="#B22222">/* create timer stages */</font>
<a name="line1525">1525: </a><font color="#A020F0">#if defined GAMG_STAGES</font>
<a name="line1526">1526: </a>  {
<a name="line1527">1527: </a>    char     str[32];
<a name="line1528">1528: </a>    <a href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> lidx;
<a name="line1529">1529: </a>    sprintf(str,<font color="#666666">"MG Level %d (finest)"</font>,0);
<a name="line1530">1530: </a>    <a href="../../../../../docs/manualpages/Profiling/PetscLogStageRegister.html#PetscLogStageRegister">PetscLogStageRegister</a>(str, &amp;gamg_stages[0]);
<a name="line1531">1531: </a>    <font color="#4169E1">for</font> (lidx=1; lidx&lt;9; lidx++) {
<a name="line1532">1532: </a>      sprintf(str,<font color="#666666">"MG Level %d"</font>,lidx);
<a name="line1533">1533: </a>      <a href="../../../../../docs/manualpages/Profiling/PetscLogStageRegister.html#PetscLogStageRegister">PetscLogStageRegister</a>(str, &amp;gamg_stages[lidx]);
<a name="line1534">1534: </a>    }
<a name="line1535">1535: </a>  }
<a name="line1536">1536: </a><font color="#A020F0">#endif</font>
<a name="line1537">1537: </a><font color="#A020F0">#endif</font>
<a name="line1538">1538: </a>  <font color="#4169E1">return</font>(0);
<a name="line1539">1539: </a>}

<a name="line1541">1541: </a><font color="#B22222">/*@C</font>
<a name="line1542">1542: </a><font color="#B22222"> <a href="../../../../../docs/manualpages/PC/PCGAMGFinalizePackage.html#PCGAMGFinalizePackage">PCGAMGFinalizePackage</a> - This function frees everything from the <a href="../../../../../docs/manualpages/PC/PCGAMG.html#PCGAMG">PCGAMG</a> package. It is</font>
<a name="line1543">1543: </a><font color="#B22222">    called from <a href="../../../../../docs/manualpages/Sys/PetscFinalize.html#PetscFinalize">PetscFinalize</a>() automatically.</font>

<a name="line1545">1545: </a><font color="#B22222"> Level: developer</font>

<a name="line1547">1547: </a><font color="#B22222"> .seealso: <a href="../../../../../docs/manualpages/Sys/PetscFinalize.html#PetscFinalize">PetscFinalize</a>()</font>
<a name="line1548">1548: </a><font color="#B22222">@*/</font>
<a name="line1549">1549: </a><strong><font color="#4169E1"><a name="PCGAMGFinalizePackage"></a><a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> <a href="../../../../../docs/manualpages/PC/PCGAMGFinalizePackage.html#PCGAMGFinalizePackage">PCGAMGFinalizePackage</a>(void)</font></strong>
<a name="line1550">1550: </a>{

<a name="line1554">1554: </a>  PCGAMGPackageInitialized = <a href="../../../../../docs/manualpages/Sys/PETSC_FALSE.html#PETSC_FALSE">PETSC_FALSE</a>;
<a name="line1555">1555: </a>  <a href="../../../../../docs/manualpages/Sys/PetscFunctionListDestroy.html#PetscFunctionListDestroy">PetscFunctionListDestroy</a>(&amp;GAMGList);
<a name="line1556">1556: </a>  <font color="#4169E1">return</font>(0);
<a name="line1557">1557: </a>}

<a name="line1559">1559: </a><font color="#B22222">/*@C</font>
<a name="line1560">1560: </a><font color="#B22222"> <a href="../../../../../docs/manualpages/PC/PCGAMGRegister.html#PCGAMGRegister">PCGAMGRegister</a> - Register a <a href="../../../../../docs/manualpages/PC/PCGAMG.html#PCGAMG">PCGAMG</a> implementation.</font>

<a name="line1562">1562: </a><font color="#B22222"> Input Parameters:</font>
<a name="line1563">1563: </a><font color="#B22222"> + type - string that will be used as the name of the GAMG type.</font>
<a name="line1564">1564: </a><font color="#B22222"> - create - function for creating the gamg context.</font>

<a name="line1566">1566: </a><font color="#B22222">  Level: advanced</font>

<a name="line1568">1568: </a><font color="#B22222"> .seealso: <a href="../../../../../docs/manualpages/PC/PCGAMGType.html#PCGAMGType">PCGAMGType</a>, <a href="../../../../../docs/manualpages/PC/PCGAMG.html#PCGAMG">PCGAMG</a>, <a href="../../../../../docs/manualpages/PC/PCGAMGSetType.html#PCGAMGSetType">PCGAMGSetType</a>()</font>
<a name="line1569">1569: </a><font color="#B22222">@*/</font>
<a name="line1570">1570: </a><strong><font color="#4169E1"><a name="PCGAMGRegister"></a><a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> <a href="../../../../../docs/manualpages/PC/PCGAMGRegister.html#PCGAMGRegister">PCGAMGRegister</a>(<a href="../../../../../docs/manualpages/PC/PCGAMGType.html#PCGAMGType">PCGAMGType</a> type, <a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> (*create)(<a href="../../../../../docs/manualpages/PC/PC.html#PC">PC</a>))</font></strong>
<a name="line1571">1571: </a>{

<a name="line1575">1575: </a>  <a href="../../../../../docs/manualpages/PC/PCGAMGInitializePackage.html#PCGAMGInitializePackage">PCGAMGInitializePackage</a>();
<a name="line1576">1576: </a>  <a href="../../../../../docs/manualpages/Sys/PetscFunctionListAdd.html#PetscFunctionListAdd">PetscFunctionListAdd</a>(&amp;GAMGList,type,create);
<a name="line1577">1577: </a>  <font color="#4169E1">return</font>(0);
<a name="line1578">1578: </a>}

</pre>
</body>

</html>
